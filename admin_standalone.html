<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ë“œì†ŒíŒ… ê´€ë¦¬ì</title>
    <style>
        /* ê³µí†µ ìŠ¤íƒ€ì¼ + ê´€ë¦¬ì ì „ìš© ìŠ¤íƒ€ì¼ */
        
        /* ê¸°ë³¸ ë¦¬ì…‹ ë° ì „ì—­ ì„¤ì • */
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-box-sizing: border-box;
            -moz-box-sizing: border-box;
        }
        
        /* Cross-browser í°íŠ¸ ìµœì í™” */
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', 'Apple SD Gothic Neo', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            background-attachment: fixed;
            background-size: cover;
            min-height: 100vh; 
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }
        
        /* ì»¨í…Œì´ë„ˆ í•´ìƒë„ë³„ ìµœì í™” */
        .container { 
            width: 100%;
            max-width: 1400px; 
            min-width: 320px;
            margin: 0 auto; 
            padding: 10px; 
            min-height: 100vh;
        }
        
        /* 1920Ã—1080 ìµœì í™” */
        @media screen and (min-width: 1920px) {
            .container {
                max-width: 1600px;
                padding: 20px;
            }
        }
        
        /* ê³ í•´ìƒë„ ëŒ€ì‘ (2560Ã—1440, 3440Ã—1440) */
        @media screen and (min-width: 2560px) {
            .container {
                max-width: 2000px;
                padding: 30px;
            }
        }
        
        /* ì €í•´ìƒë„ ëŒ€ì‘ (1366Ã—768, 1024Ã—768) */
        @media screen and (max-width: 1366px) {
            .container {
                padding: 5px;
            }
        }
        
        /* ê¸°ë³¸ ì¹´ë“œ ìŠ¤íƒ€ì¼ */
        .card { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            overflow: hidden;
            -webkit-border-radius: 12px;
            -moz-border-radius: 12px;
        }
        
        /* í˜ì´ì§€ ì „í™˜ ì• ë‹ˆë©”ì´ì…˜ */
        .page { 
            display: none; 
            -webkit-animation: fadeIn 0.3s ease-in;
            -moz-animation: fadeIn 0.3s ease-in;
            animation: fadeIn 0.3s ease-in;
        }
        
        .page.active { display: block; }
        
        @-webkit-keyframes fadeIn { 
            from { opacity: 0; -webkit-transform: translateY(20px); } 
            to { opacity: 1; -webkit-transform: translateY(0); } 
        }
        
        @-moz-keyframes fadeIn { 
            from { opacity: 0; -moz-transform: translateY(20px); } 
            to { opacity: 1; -moz-transform: translateY(0); } 
        }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        /* í—¤ë” ê³µí†µ ìŠ¤íƒ€ì¼ */
        .header { 
            background: white; 
            padding: 20px 30px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .logo { 
            font-size: 24px; 
            font-weight: bold; 
            color: #333; 
        }
        
        .nav-buttons { 
            display: flex; 
            gap: 10px; 
        }
        
        /* í¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .form-group { 
            margin: 20px 0; 
        }
        
        .form-label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #333; 
        }
        
        .form-control { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e1e5e9; 
            border-radius: 8px; 
            font-size: 16px; 
            transition: border-color 0.3s;
        }
        
        .form-control:focus { 
            outline: none; 
            border-color: #667eea; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .textarea { 
            min-height: 120px; 
            resize: vertical; 
            font-family: inherit; 
        }
        
        /* ë²„íŠ¼ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            text-decoration: none; 
            display: inline-block; 
            text-align: center;
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
        }
        
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary { 
            background: #e9ecef; 
            color: #495057; 
            border: 1px solid #ced4da; 
        }
        
        .btn-secondary:hover { 
            background: #dee2e6; 
            border-color: #ced4da; 
        }
        
        .btn-danger { 
            background: #e74c3c; 
            color: white; 
        }
        
        .btn-danger:hover { 
            background: #c0392b; 
        }
        
        /* ë¡œê·¸ì¸ ê³µí†µ ìŠ¤íƒ€ì¼ */
        .login-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            padding: 20px; 
        }
        
        .login-box { 
            background: white; 
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            width: 100%; 
            max-width: 400px;
        }
        
        .login-title { 
            text-align: center; 
            font-size: 20px; 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 10px; 
            line-height: 1.3; 
        }
        
        .login-subtitle { 
            text-align: center; 
            color: #666; 
            margin-bottom: 30px; 
        }
        
        /* ì²´í¬ë°•ìŠ¤ ìŠ¤íƒ€ì¼ */
        .checkbox-group { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
            margin: 15px 0; 
        }
        
        .checkbox-group input[type="checkbox"] { 
            margin: 0; 
        }
        
        /* ì•Œë¦¼ ìŠ¤íƒ€ì¼ */
        .alert { 
            padding: 12px 16px; 
            border-radius: 8px; 
            margin: 15px 0; 
            border-left: 4px solid;
        }
        
        .alert-info { 
            background: #e3f2fd; 
            border-color: #2196f3; 
            color: #1976d2; 
        }
        
        .alert-warning { 
            background: #fff3e0; 
            border-color: #ff9800; 
            color: #f57c00; 
        }
        
        .alert-success { 
            background: #e8f5e9; 
            border-color: #4caf50; 
            color: #388e3c; 
        }
        
        /* ìœ í‹¸ë¦¬í‹° í´ë˜ìŠ¤ */
        .hidden { 
            display: none !important; 
        }
        
        .text-center { 
            text-align: center; 
        }
        
        .mt-2 { margin-top: 10px; }
        .mt-3 { margin-top: 15px; }
        .mb-2 { margin-bottom: 10px; }
        .mb-3 { margin-bottom: 15px; }
        
        .flex { 
            display: flex !important; 
        }
        
        .flex-wrap { 
            flex-wrap: wrap; 
        }
        
        .gap-2 { gap: 10px; }
        .gap-3 { gap: 15px; }
        
        .justify-center { 
            justify-content: center; 
        }
        
        .items-center { 
            align-items: center; 
        }
        
        .w-full { 
            width: 100%; 
        }
        
        /* ì•Œë¦¼ í† ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .notification {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            max-width: 500px;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            font-weight: 600;
            font-size: 16px;
            animation: slideInDown 0.3s ease-out;
            border: 2px solid;
        }
        
        @keyframes slideInDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-30px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        /* ê´€ë¦¬ì ì „ìš© ìŠ¤íƒ€ì¼ */
        .admin-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px; 
            padding: 30px; 
        }
        
        .admin-section { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 12px; 
            border: 1px solid #e9ecef;
        }
        
        .admin-section h3 { 
            color: #333; 
            margin-bottom: 20px; 
            font-size: 20px; 
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr);
            gap: 15px; 
            margin: 20px 0; 
        }
        
        .stat-card { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            text-align: center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .stat-number { 
            font-size: 24px; 
            font-weight: bold; 
            color: #667eea; 
        }
        
        .stat-label { 
            font-size: 14px; 
            color: #666; 
            margin-top: 5px; 
        }
        
        /* í•´ìƒë„ë³„ ìµœì í™” */
        @media screen and (min-width: 1920px) {
            .admin-grid {
                grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
                gap: 40px;
                padding: 40px;
            }
        }
        
        @media screen and (min-width: 2560px) {
            .admin-grid {
                grid-template-columns: repeat(3, 1fr);
                gap: 50px;
                padding: 50px;
            }
        }
        
        @media screen and (max-width: 1366px) {
            .admin-grid {
                grid-template-columns: 1fr;
                gap: 20px;
                padding: 20px;
            }
        }
        
        @media (max-width: 768px) { 
            .admin-grid { 
                grid-template-columns: 1fr;
                padding: 20px; 
            }
            
            .nav-buttons { 
                flex-direction: column; 
                width: 100%; 
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ -->
        <div id="admin-login-page" class="page active">
            <div class="login-container">
                <div class="login-box">
                    <h1 class="login-title">ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
                    <p class="login-subtitle">ê´€ë¦¬ì ì „ìš© í˜ì´ì§€ì…ë‹ˆë‹¤</p>
                    
                    <form onsubmit="adminLogin(event)">
                        <div class="form-group">
                            <label class="form-label">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
                            <input 
                                type="password" 
                                id="admin-password" 
                                class="form-control" 
                                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                required
                            >
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-full">
                            ë¡œê·¸ì¸
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ -->
        <div id="admin-dashboard-page" class="page">
            <div class="card">
                <div class="header">
                    <div class="logo">ì¹´ë“œì†ŒíŒ… ê´€ë¦¬ì (Google Sheets ì—°ë™)</div>
                    <div class="nav-buttons">
                        <button class="btn btn-danger" onclick="adminLogout()">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>

                <div class="admin-grid">
                    <div class="admin-section">
                        <h3>ğŸ¯ í”„ë¡œì íŠ¸ ì„¤ì •</h3>
                        
                        <div class="form-group">
                            <label class="form-label">í”„ë¡œì íŠ¸ ì œëª©</label>
                            <input 
                                type="text" 
                                id="project-title" 
                                class="form-control" 
                                value="í˜œíƒ ì½˜í…ì¸  ì¹´ë“œì†ŒíŒ…"
                                placeholder="í”„ë¡œì íŠ¸ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                            >
                        </div>

                        <div class="form-group">
                            <label class="form-label">ì†ŒíŒ… ë°©ì‹</label>
                            <select id="sorting-type" class="form-control">
                                <option value="open">ì˜¤í”ˆ ì†ŒíŒ… (ê·¸ë£¹ ììœ  ìƒì„±)</option>
                                <option value="closed">í´ë¡œì¦ˆë“œ ì†ŒíŒ… (ê³ ì • ê·¸ë£¹ë§Œ)</option>
                                <option value="hybrid" selected>í•˜ì´ë¸Œë¦¬ë“œ ì†ŒíŒ… (ê¸°ë³¸ + ì‚¬ìš©ì ìƒì„±)</option>
                            </select>
                        </div>

                        <div class="form-group" id="predefined-groups-section">
                            <label class="form-label">ê¸°ë³¸ ê·¸ë£¹ (í´ë¡œì¦ˆë“œ/í•˜ì´ë¸Œë¦¬ë“œ ì „ìš©)</label>
                            <textarea 
                                id="predefined-groups" 
                                class="form-control textarea" 
                                placeholder="í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ì„¸ìš”"
                            >êµ¬ë§¤í˜œíƒ
ì°¸ì—¬í˜œíƒ
ì¹´ë“œ/ê²°ì œí˜œíƒ</textarea>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="shuffle-cards" checked>
                            <label for="shuffle-cards">ì¹´ë“œ ìˆœì„œ ë¬´ì‘ìœ„ ì„ê¸°</label>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="allow-edit-groups" checked>
                            <label for="allow-edit-groups">ê¸°ë³¸ ê·¸ë£¹ëª… ìˆ˜ì • í—ˆìš©</label>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>ğŸƒ ì¹´ë“œ ëª©ë¡ ê´€ë¦¬</h3>
                        
                        <div class="form-group">
                            <label class="form-label">ì¹´ë“œ ëª©ë¡ (ìµœëŒ€ 100ê°œ)</label>
                            <textarea 
                                id="card-list" 
                                class="form-control textarea" 
                                placeholder="í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ì„¸ìš”"
                                style="min-height: 200px;"
                            >ë°©ì†¡ ì•Œë¦¼ ì‹ ì²­í•˜ê³  ì ë¦½ê¸ˆ ë°›ê¸°
ë©¤ë²„ì‹­ ê°€ì…í•˜ê³  í• ì¸ ì¿ í° ë°›ê¸°
ë°©ì†¡ ì±„íŒ… ë‚¨ê¸°ê³  ì ë¦½ê¸ˆ ë°›ê¸°
ì¹œêµ¬ ì¶”ì²œí•˜ê³  í¬ì¸íŠ¸ ë°›ê¸°
ì²« êµ¬ë§¤ í›„ ìºì‹œë°± ë°›ê¸°
ë¦¬ë·° ì‘ì„±í•˜ê³  ì ë¦½ê¸ˆ ë°›ê¸°
ìƒì¼ ì¿ í° ë°›ê¸°
ë“±ê¸‰ë³„ í• ì¸ í˜œíƒ
ë¬´ë£Œë°°ì†¡ í˜œíƒ
ì ë¦½ê¸ˆ í˜œíƒ</textarea>
                        </div>

                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="new-card" 
                                class="form-control" 
                                placeholder="ìƒˆ ì¹´ë“œ ì¶”ê°€"
                                style="flex: 1;"
                            >
                            <button class="btn btn-secondary" onclick="addNewCard()">ì¶”ê°€</button>
                        </div>

                        <div class="alert alert-info mt-2">
                            <strong>í˜„ì¬ ì¹´ë“œ ìˆ˜:</strong> <span id="card-count">10</span>ê°œ
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>ğŸ”— Google Sheets ì„¤ì •</h3>
                        
                        <div class="form-group">
                            <label class="form-label">ì›¹ì•± URL</label>
                            <input 
                                type="text" 
                                id="webapp-url" 
                                class="form-control" 
                                placeholder="https://script.google.com/macros/s/AKfycbwbNhV4IPL0qb36bgelyKi2SYqjQY7OFDZ-Mh3WWn3zKaKG2du-5vG_pazf1QfyQNnILg/exec"
                                value="https://script.google.com/macros/s/AKfycbwbNhV4IPL0qb36bgelyKi2SYqjQY7OFDZ-Mh3WWn3zKaKG2du-5vG_pazf1QfyQNnILg/exec"
                            >
                        </div>

                        <div class="form-group">
                            <label class="form-label">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID</label>
                            <input 
                                type="text" 
                                id="spreadsheet-id" 
                                class="form-control" 
                                placeholder="1V9iTiBnesG9TRTHzohpAyC0358xzQVn2j9qQuVaj8FY"
                                value="1V9iTiBnesG9TRTHzohpAyC0358xzQVn2j9qQuVaj8FY"
                            >
                        </div>

                        <button class="btn btn-primary w-full mb-3" onclick="testConnection()">
                            ğŸ”— ì—°ê²° í…ŒìŠ¤íŠ¸
                        </button>

                        <div id="connection-status" class="alert alert-info">
                            <strong>ì—°ê²° ìƒíƒœ:</strong> í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>ğŸ”— ì‘ë‹µì URL ìƒì„±</h3>
                        
                        <button class="btn btn-primary w-full mb-3" onclick="generateURL()">
                            í”„ë¡œì íŠ¸ ì €ì¥ ë° URL ìƒì„±
                        </button>

                        <div id="generated-url-section" class="hidden">
                            <div class="form-group">
                                <label class="form-label">ìƒì„±ëœ ì‘ë‹µì URL</label>
                                <div style="position: relative;">
                                    <input 
                                        type="text" 
                                        id="generated-url" 
                                        class="form-control" 
                                        readonly
                                        style="padding-right: 60px;"
                                    >
                                    <button 
                                        class="btn btn-secondary" 
                                        onclick="copyURL()"
                                        style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); padding: 5px 10px; font-size: 12px;"
                                    >
                                        ë³µì‚¬
                                    </button>
                                </div>
                            </div>

                            <div class="flex gap-2 mt-2">
                                <button class="btn btn-secondary" onclick="openParticipantURL()">ğŸ‘¤ ì‘ë‹µì í˜ì´ì§€</button>
                                <button class="btn btn-secondary" onclick="openGoogleSheetsPage()">ğŸ“Š Google Sheets ì—´ê¸°</button>
                            </div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>ğŸ“Š ì‘ë‹µ í˜„í™©</h3>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="total-responses">0</div>
                                <div class="stat-label">ì´ ì‘ë‹µ ìˆ˜</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="completed-responses">0</div>
                                <div class="stat-label">ì™„ë£Œëœ ì‘ë‹µ</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="ongoing-responses">0</div>
                                <div class="stat-label">ì§„í–‰ ì¤‘</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="avg-duration">0ë¶„</div>
                                <div class="stat-label">í‰ê·  ì†Œìš”ì‹œê°„</div>
                            </div>
                        </div>

                        <div class="flex gap-2 mt-3">
                            <button class="btn btn-primary" onclick="downloadAllResponses()" style="flex: 1;">
                                ğŸ“¥ JSON ë‹¤ìš´ë¡œë“œ
                            </button>
                            <button class="btn btn-secondary" onclick="openGoogleSheetsPage()">
                                ğŸ“Š Google Sheets
                            </button>
                            <button class="btn btn-secondary" onclick="clearAllData()">
                                ğŸ—‘ï¸ ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ê³µí†µ ê¸°ëŠ¥ + ê´€ë¦¬ì ì „ìš© ê¸°ëŠ¥
        
        // ============================================
        // ğŸ”— Google Sheets ì—°ë™ ì„¤ì •
        // ============================================
        
        let GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx3ridIkA9eP6YX0WrUgBItWJo_uRWDjvrUf6IqX95POh1JMqA2xlP7qXx5BFzYTUFNiQ/exec';
        let SPREADSHEET_ID = '1V9iTiBnesG9TRTHzohpAyC0358xzQVn2j9qQuVaj8FY';
        
        // ============================================
        // ğŸ”§ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        // ============================================
        
        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                return false;
            }
        }
        
        function loadFromStorage(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.error('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                return defaultValue;
            }
        }
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }
        
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }
        
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            const colors = {
                success: { bg: '#d4edda', border: '#28a745', text: '#155724' },
                warning: { bg: '#fff3cd', border: '#ffc107', text: '#856404' },
                error: { bg: '#f8d7da', border: '#dc3545', text: '#721c24' },
                info: { bg: '#d1ecf1', border: '#17a2b8', text: '#0c5460' }
            };
            
            const color = colors[type] || colors.info;
            notification.style.backgroundColor = color.bg;
            notification.style.borderColor = color.border;
            notification.style.color = color.text;
            
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; font-size: 20px; cursor: pointer; color: ${color.text}; margin-left: 15px;">Ã—</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // ============================================
        // ğŸ”— Google Sheets ì—°ë™ í•¨ìˆ˜ë“¤
        // ============================================
        
        async function saveToGoogleSheets(responseData, projectConfig) {
            return new Promise((resolve, reject) => {
                try {
                    console.log('ğŸ”— Google Sheets ì €ì¥ ì‹œì‘ (JSONP ë°©ì‹)...');
                    
                    const exportData = formatResponseForExport(responseData, projectConfig);
                    
                    const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    
                    window[callbackName] = function(response) {
                        delete window[callbackName];
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                        
                        console.log('ğŸ“Š Google Sheets ì‘ë‹µ:', response);
                        
                        if (response.status === 'success') {
                            showNotification('âœ… Google Sheetsì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                            resolve(response);
                        } else {
                            reject(new Error(response.message || 'ì €ì¥ ì‹¤íŒ¨'));
                        }
                    };
                    
                    const params = new URLSearchParams({
                        action: 'save',
                        data: JSON.stringify(exportData),
                        callback: callbackName
                    });
                    
                    const url = `${GOOGLE_APPS_SCRIPT_URL}?${params.toString()}`;
                    
                    const script = document.createElement('script');
                    script.src = url;
                    script.onerror = function() {
                        delete window[callbackName];
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                        reject(new Error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨'));
                    };
                    
                    setTimeout(() => {
                        if (window[callbackName]) {
                            delete window[callbackName];
                            if (document.head.contains(script)) {
                                document.head.removeChild(script);
                            }
                            reject(new Error('íƒ€ì„ì•„ì›ƒ: ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'));
                        }
                    }, 15000);
                    
                    document.head.appendChild(script);
                    
                } catch (error) {
                    console.error('âŒ Google Sheets ì €ì¥ ì‹¤íŒ¨:', error);
                    reject(error);
                }
            });
        }
        
        async function testGoogleSheetsConnection(webappUrl, spreadsheetId) {
            const originalUrl = GOOGLE_APPS_SCRIPT_URL;
            const originalId = SPREADSHEET_ID;
            
            GOOGLE_APPS_SCRIPT_URL = webappUrl;
            SPREADSHEET_ID = spreadsheetId;
            
            try {
                const testData = {
                    participantInfo: {
                        participantId: 'connection_test_' + Date.now(),
                        name: 'ì—°ê²° í…ŒìŠ¤íŠ¸',
                        phone: '0000'
                    },
                    timeInfo: {
                        startTime: new Date().toISOString(),
                        completedTime: new Date().toISOString(),
                        durationMinutes: 0
                    },
                    sortingResults: {
                        sortingType: 'connection_test',
                        totalCards: 1,
                        assignedCards: 1,
                        totalGroups: 1,
                        groupResults: {
                            'í…ŒìŠ¤íŠ¸ê·¸ë£¹': ['ì—°ê²° í…ŒìŠ¤íŠ¸ ì¹´ë“œ']
                        }
                    },
                    projectInfo: {
                        projectTitle: 'ì—°ê²° í…ŒìŠ¤íŠ¸',
                        sortingType: 'connection_test'
                    }
                };
                
                const result = await saveToGoogleSheets(testData, { title: 'ì—°ê²° í…ŒìŠ¤íŠ¸', cards: ['í…ŒìŠ¤íŠ¸ ì¹´ë“œ'] });
                
                localStorage.setItem('google_sheets_config', JSON.stringify({
                    webappUrl: webappUrl,
                    spreadsheetId: spreadsheetId
                }));
                
                return { success: true, message: 'ì—°ê²° ì„±ê³µ!' };
                
            } catch (error) {
                console.error('ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                
                GOOGLE_APPS_SCRIPT_URL = originalUrl;
                SPREADSHEET_ID = originalId;
                
                return { success: false, message: error.message };
            }
        }
        
        function formatResponseForExport(responseData, projectConfig) {
            const groupResults = {};
            const cardDistribution = {};
            const groupOrder = [];
            
            const sortedGroups = Object.values(responseData.groups || {}).sort((a, b) => (a.order || 0) - (b.order || 0));
            
            sortedGroups.forEach(group => {
                if (group.cards.length > 0) {
                    groupResults[group.name] = group.cards.map(card => card.content);
                    groupOrder.push(group.name);
                    group.cards.forEach(card => {
                        cardDistribution[card.content] = group.name;
                    });
                }
            });
            
            if (responseData.unassignedCards && responseData.unassignedCards.length > 0) {
                groupResults['ë¯¸ë¶„ë¥˜'] = responseData.unassignedCards.map(card => card.content);
                responseData.unassignedCards.forEach(card => {
                    cardDistribution[card.content] = 'ë¯¸ë¶„ë¥˜';
                });
            }
            
            const customGroupsCount = Object.values(responseData.groups || {}).filter(g => g.isCustom && g.cards.length > 0).length;
            const usedGroupsCount = Object.keys(groupResults).length;
            const modifiedGroupNamesCount = responseData.modifiedGroupNames ? responseData.modifiedGroupNames.length : 0;
            
            const surveyResults = responseData.surveyData ? {
                mostUsed: responseData.surveyData.question1.map((card, index) => ({
                    rank: index + 1,
                    card: card.content,
                    group: cardDistribution[card.content] || 'ë¯¸ë¶„ë¥˜'
                })),
                leastUsed: responseData.surveyData.question2.map((card, index) => ({
                    rank: index + 1,
                    card: card.content,
                    group: cardDistribution[card.content] || 'ë¯¸ë¶„ë¥˜'
                }))
            } : null;
            
            return {
                ì´ë¦„: responseData.name || 'ì•Œ ìˆ˜ ì—†ìŒ',
                íœ´ëŒ€í°ë’·ë²ˆí˜¸4ìë¦¬: responseData.phone || '',
                ì‹œì‘ì‹œê°„: responseData.startTime,
                ì™„ë£Œì‹œê°„: responseData.completedTime,
                ì†Œìš”ì‹œê°„: Math.round(responseData.duration / 60) + 'ë¶„',
                ì†ŒíŒ…ë°©ì‹: responseData.sortingType,
                ì°¸ì—¬ìê°€ì¶”ê°€í•œê·¸ë£¹ìˆ˜: customGroupsCount,
                ì°¸ì—¬ìê°€ë¶„ë¥˜í•œê·¸ë£¹ìˆ˜: usedGroupsCount,
                ì°¸ì—¬ìê°€ë³€ê²½í•œê·¸ë£¹ëª…ì˜ìˆ˜: modifiedGroupNamesCount,
                ê·¸ë£¹ë³„ê²°ê³¼: JSON.stringify(groupResults),
                ê·¸ë£¹ìˆœì„œ: groupOrder.join(' > '),
                ê°€ì¥ë§ì´ì‚¬ìš©í•˜ëŠ”í˜œíƒ: responseData.surveyData ? responseData.surveyData.question1.map(c => c.content).join(', ') : '',
                ê°€ì¥ì ê²Œì‚¬ìš©í•˜ëŠ”í˜œíƒ: responseData.surveyData ? responseData.surveyData.question2.map(c => c.content).join(', ') : '',
                ì°¸ì—¬ìì˜ê²¬: responseData.participantFeedback || ''
            };
        }
        
        function downloadJSON(data, filename) {
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }
        
        function getAllResponses() {
            const responses = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('participant_')) {
                    const data = loadFromStorage(key);
                    if (data) responses.push(data);
                }
            }
            return responses;
        }
        
        function openGoogleSheets(spreadsheetId) {
            if (spreadsheetId && spreadsheetId !== 'ì—¬ê¸°ì—_ìŠ¤í”„ë ˆë“œì‹œíŠ¸_ID_ì…ë ¥') {
                const sheetsUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`;
                window.open(sheetsUrl, '_blank');
            } else {
                showNotification('âš ï¸ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'warning');
            }
        }
        
        // ============================================
        // ê´€ë¦¬ì ì „ìš© í•¨ìˆ˜ë“¤
        // ============================================
        
        let adminState = {
            currentUser: null,
            currentProject: null
        };
        
        const DEFAULT_PROJECT = {
            id: 'default-project',
            title: 'í˜œíƒ ì½˜í…ì¸  ì¹´ë“œì†ŒíŒ…',
            cards: [
                'ë°©ì†¡ ì•Œë¦¼ ì‹ ì²­í•˜ê³  ì ë¦½ê¸ˆ ë°›ê¸°',
                'ë©¤ë²„ì‹­ ê°€ì…í•˜ê³  í• ì¸ ì¿ í° ë°›ê¸°', 
                'ë°©ì†¡ ì±„íŒ… ë‚¨ê¸°ê³  ì ë¦½ê¸ˆ ë°›ê¸°',
                'ì¹œêµ¬ ì¶”ì²œí•˜ê³  í¬ì¸íŠ¸ ë°›ê¸°',
                'ì²« êµ¬ë§¤ í›„ ìºì‹œë°± ë°›ê¸°',
                'ë¦¬ë·° ì‘ì„±í•˜ê³  ì ë¦½ê¸ˆ ë°›ê¸°',
                'ìƒì¼ ì¿ í° ë°›ê¸°',
                'ë“±ê¸‰ë³„ í• ì¸ í˜œíƒ',
                'ë¬´ë£Œë°°ì†¡ í˜œíƒ',
                'ì ë¦½ê¸ˆ í˜œíƒ'
            ],
            sortingType: 'hybrid',
            predefinedGroups: ['êµ¬ë§¤í˜œíƒ', 'ì°¸ì—¬í˜œíƒ', 'ì¹´ë“œ/ê²°ì œí˜œíƒ'],
            shuffleCards: true,
            allowEditGroups: true,
            createdAt: new Date().toISOString()
        };
        
        function adminLogin(event) {
            event.preventDefault();
            const password = document.getElementById('admin-password').value;
            if (password === 'LHLH') {
                adminState.currentUser = { role: 'admin' };
                showPage('admin-dashboard-page');
                loadAdminData();
                updateResponseStats();
            } else {
                showNotification('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
            }
        }
        
        function adminLogout() {
            adminState.currentUser = null;
            showPage('admin-login-page');
            document.getElementById('admin-password').value = '';
        }
        
        function loadAdminData() {
            const project = loadFromStorage('current_project', DEFAULT_PROJECT);
            document.getElementById('project-title').value = project.title;
            document.getElementById('sorting-type').value = project.sortingType;
            document.getElementById('predefined-groups').value = project.predefinedGroups.join('\n');
            document.getElementById('card-list').value = project.cards.join('\n');
            document.getElementById('shuffle-cards').checked = project.shuffleCards || false;
            document.getElementById('allow-edit-groups').checked = project.allowEditGroups || false;
            updateCardCount();
            updateSortingTypeVisibility();
            
            const config = loadFromStorage('google_sheets_config');
            if (config) {
                document.getElementById('webapp-url').value = config.webappUrl || '';
                document.getElementById('spreadsheet-id').value = config.spreadsheetId || '';
            }
        }
        
        function addNewCard() {
            const newCard = document.getElementById('new-card').value.trim();
            if (!newCard) return;
            const cardList = document.getElementById('card-list');
            const currentCards = cardList.value.trim();
            if (currentCards) {
                cardList.value = currentCards + '\n' + newCard;
            } else {
                cardList.value = newCard;
            }
            document.getElementById('new-card').value = '';
            updateCardCount();
        }
        
        function updateCardCount() {
            const cards = document.getElementById('card-list').value.trim().split('\n').filter(card => card.trim());
            document.getElementById('card-count').textContent = cards.length;
        }
        
        function updateSortingTypeVisibility() {
            const sortingType = document.getElementById('sorting-type').value;
            const groupsSection = document.getElementById('predefined-groups-section');
            if (sortingType === 'open') {
                groupsSection.style.display = 'none';
            } else {
                groupsSection.style.display = 'block';
            }
        }
        
        function testConnection() {
            const webappUrl = document.getElementById('webapp-url').value.trim();
            const spreadsheetId = document.getElementById('spreadsheet-id').value.trim();
            
            if (!webappUrl || webappUrl === 'ì—¬ê¸°ì—_ìƒˆë¡œìš´_ì›¹ì•±_URL_ì…ë ¥') {
                showNotification('ì›¹ì•± URLì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = '<strong>ì—°ê²° ìƒíƒœ:</strong> í…ŒìŠ¤íŠ¸ ì¤‘...';
            statusDiv.className = 'alert alert-info';
            
            testGoogleSheetsConnection(webappUrl, spreadsheetId)
                .then(result => {
                    if (result.success) {
                        statusDiv.innerHTML = `âœ… <strong>ì—°ê²° ì„±ê³µ!</strong> Google Sheetsì™€ ì •ìƒ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.`;
                        statusDiv.className = 'alert alert-success';
                    } else {
                        statusDiv.innerHTML = `âŒ <strong>ì—°ê²° ì‹¤íŒ¨:</strong> ${result.message}`;
                        statusDiv.className = 'alert alert-warning';
                    }
                })
                .catch(error => {
                    statusDiv.innerHTML = `âŒ <strong>ì—°ê²° ì‹¤íŒ¨:</strong> ${error.message}`;
                    statusDiv.className = 'alert alert-warning';
                });
        }
        
        function generateURL() {
            const project = {
                id: generateId(),
                title: document.getElementById('project-title').value.trim(),
                sortingType: document.getElementById('sorting-type').value,
                predefinedGroups: document.getElementById('predefined-groups').value.trim().split('\n').filter(g => g.trim()),
                cards: document.getElementById('card-list').value.trim().split('\n').filter(c => c.trim()),
                shuffleCards: document.getElementById('shuffle-cards').checked,
                allowEditGroups: document.getElementById('allow-edit-groups').checked,
                createdAt: new Date().toISOString()
            };
        
            if (!project.title || project.cards.length === 0) {
                showNotification('í”„ë¡œì íŠ¸ ì œëª©ê³¼ ì¹´ë“œ ëª©ë¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
        
            if (project.cards.length > 100) {
                showNotification('ì¹´ë“œëŠ” ìµœëŒ€ 100ê°œê¹Œì§€ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
                return;
            }
        
            const webappUrl = document.getElementById('webapp-url').value.trim();
            const spreadsheetId = document.getElementById('spreadsheet-id').value.trim();
            
            if (webappUrl && webappUrl !== 'ì—¬ê¸°ì—_ìƒˆë¡œìš´_ì›¹ì•±_URL_ì…ë ¥') {
                localStorage.setItem('google_sheets_config', JSON.stringify({
                    webappUrl: webappUrl,
                    spreadsheetId: spreadsheetId
                }));
            }
        
            saveToStorage('current_project', project);
            adminState.currentProject = project;
        
            const baseURL = window.location.origin + window.location.pathname.replace('admin.html', '');
            const projectURL = `${baseURL}participant.html`;
            
            document.getElementById('generated-url').value = projectURL;
            document.getElementById('generated-url-section').classList.remove('hidden');
        
            showNotification('í”„ë¡œì íŠ¸ê°€ ì €ì¥ë˜ê³  URLì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }
        
        function copyURL() {
            const urlInput = document.getElementById('generated-url');
            urlInput.select();
            document.execCommand('copy');
            showNotification('URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }
        
        function openParticipantURL() {
            const baseURL = window.location.origin + window.location.pathname.replace('admin.html', '');
            const participantURL = `${baseURL}participant.html`;
            window.open(participantURL, '_blank');
        }
        
        function openGoogleSheetsPage() {
            const spreadsheetId = document.getElementById('spreadsheet-id').value.trim();
            openGoogleSheets(spreadsheetId);
        }
        
        function updateResponseStats() {
            const responses = getAllResponses();
            const completed = responses.filter(r => r.isCompleted);
            const ongoing = responses.filter(r => !r.isCompleted);
            
            const avgDuration = completed.length > 0 
                ? Math.round(completed.reduce((sum, r) => sum + (r.duration || 0), 0) / completed.length / 60)
                : 0;
        
            document.getElementById('total-responses').textContent = responses.length;
            document.getElementById('completed-responses').textContent = completed.length;
            document.getElementById('ongoing-responses').textContent = ongoing.length;
            document.getElementById('avg-duration').textContent = avgDuration + 'ë¶„';
        }
        
        function downloadAllResponses() {
            const responses = getAllResponses();
            if (responses.length === 0) {
                showNotification('ë‹¤ìš´ë¡œë“œí•  ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }
        
            const project = loadFromStorage('current_project', DEFAULT_PROJECT);
            const exportData = {
                projectInfo: project,
                exportDate: new Date().toISOString(),
                totalResponses: responses.length,
                responses: responses.map(r => formatResponseForExport(r, project))
            };
        
            downloadJSON(exportData, `ì¹´ë“œì†ŒíŒ…_ì „ì²´ì‘ë‹µ_${project.title}_${new Date().toISOString().split('T')[0]}.json`);
        }
        
        function clearAllData() {
            if (confirm('ëª¨ë“  ì‘ë‹µ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('participant_')) {
                        localStorage.removeItem(key);
                    }
                }
                updateResponseStats();
                showNotification('ëª¨ë“  ì‘ë‹µ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }
        
        // ============================================
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì„¤ì •
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('sorting-type').addEventListener('change', updateSortingTypeVisibility);
            document.getElementById('card-list').addEventListener('input', updateCardCount);
            
            document.getElementById('new-card').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addNewCard();
                }
            });
            
            updateSortingTypeVisibility();
            updateCardCount();
            
            const savedConfig = loadFromStorage('google_sheets_config');
            if (savedConfig) {
                GOOGLE_APPS_SCRIPT_URL = savedConfig.webappUrl || GOOGLE_APPS_SCRIPT_URL;
                SPREADSHEET_ID = savedConfig.spreadsheetId || SPREADSHEET_ID;
            }
            
            console.log('âœ… ê´€ë¦¬ì ì‹œìŠ¤í…œì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
    </script>
</body>
</html>