<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë¡¯ë°í™ˆì‡¼í•‘ "í˜œíƒ" ë§¤ì¥ ì¹´ë“œ ë¶„ë¥˜í•˜ê¸° (ìµœì í™” ë²„ì „)</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', 'Apple SD Gothic Neo', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            background-attachment: fixed;
            min-height: 100vh; 
            line-height: 1.6;
        }
        
        .container { 
            width: 100%;
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 10px; 
            min-height: 100vh;
        }
        
        .card { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            overflow: hidden;
        }
        
        .page { 
            display: none; 
            animation: fadeIn 0.3s ease-in;
        }
        
        .page.active { display: block; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .header { 
            background: white; 
            padding: 20px 30px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .logo { font-size: 24px; font-weight: bold; color: #333; }
        
        .nav-buttons { 
            display: flex; 
            gap: 10px; 
        }
        
        .form-group { margin: 20px 0; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-control { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e1e5e9; 
            border-radius: 8px; 
            font-size: 16px; 
            transition: border-color 0.3s;
        }
        
        .form-control:focus { 
            outline: none; 
            border-color: #667eea; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .textarea { 
            min-height: 120px; 
            resize: vertical; 
            font-family: inherit; 
        }
        
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            text-decoration: none; 
            display: inline-block; 
            text-align: center;
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
        }
        
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary { 
            background: #e9ecef; 
            color: #495057; 
            border: 1px solid #ced4da; 
        }
        
        .btn-secondary:hover { background: #dee2e6; border-color: #ced4da; }
        
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        
        .login-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            padding: 20px; 
        }
        
        .login-box { 
            background: white; 
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            width: 100%; 
            max-width: 400px;
        }
        
        .login-title { 
            text-align: center; 
            font-size: 20px; 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 10px; 
            line-height: 1.3; 
        }
        
        .login-subtitle { text-align: center; color: #666; margin-bottom: 30px; }
        
        .admin-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px; 
            padding: 30px; 
        }
        
        .admin-section { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 12px; 
            border: 1px solid #e9ecef;
        }
        
        .admin-section h3 { color: #333; margin-bottom: 20px; font-size: 20px; }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr);
            gap: 15px; 
            margin: 20px 0; 
        }
        
        .stat-card { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            text-align: center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .stat-number { font-size: 24px; font-weight: bold; color: #667eea; }
        .stat-label { font-size: 14px; color: #666; margin-top: 5px; }
        
        .sorting-header { 
            background: white; 
            padding: 20px 30px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 15px; 
        }
        
        .participant-info h2 { color: #333; font-size: 20px; }
        .participant-info p { color: #666; font-size: 14px; }
        
        .progress-section { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            min-width: 200px; 
        }
        
        .progress-container { width: 200px; }
        
        .progress-bar { 
            width: 100%; 
            height: 8px; 
            background: #e9ecef; 
            border-radius: 4px; 
            overflow: hidden;
        }
        
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #667eea, #764ba2); 
            transition: width 0.3s ease; 
        }
        
        .progress-text { text-align: center; font-size: 14px; color: #666; margin-top: 5px; }
        
        .sorting-workspace { 
            display: grid; 
            grid-template-columns: 320px 1fr;
            gap: 30px; 
            padding: 30px; 
            min-height: calc(100vh - 200px); 
        }
        
        .card-pool { 
            background: #fff9e6; 
            border-radius: 12px; 
            padding: 20px; 
            border: 2px dashed #f0ad4e; 
            transition: all 0.3s;
        }
        
        .card-pool.drag-over { 
            border-color: #f0ad4e; 
            background: #fff3cd; 
            transform: scale(1.02); 
        }
        
        .card-pool h3 { 
            color: #8a6d3b; 
            margin-bottom: 15px; 
            font-size: 18px; 
            font-weight: 600;
        }
        
        .card-list { 
            max-height: 400px; 
            overflow-y: auto; 
            margin-bottom: 15px; 
        }
        
        .card-item { 
            background: white; 
            padding: 12px 15px; 
            margin: 8px 0; 
            border-radius: 8px; 
            border: 1px solid #dee2e6; 
            cursor: move; 
            transition: all 0.2s; 
            position: relative; 
            user-select: none; 
            font-size: 14px;
        }
        
        .card-item:hover { 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            transform: translateY(-2px);
        }
        
        .card-item.dragging { 
            opacity: 0.5; 
            transform: rotate(5deg); 
        }
        
        .card-item::after { 
            content: "â‹®â‹®"; 
            position: absolute; 
            right: 10px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: #adb5bd; 
            font-weight: bold; 
        }
        
        .groups-area { background: white; }
        
        .groups-header { 
            padding: 20px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .group-order-guide {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 10px 15px;
            margin: 0 20px 15px 20px;
            font-size: 14px;
            color: #1976d2;
            text-align: center;
        }
        
        .groups-container { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr);
            gap: 20px; 
            max-height: 70vh; 
            overflow-y: auto; 
            padding: 20px; 
        }
        
        .group-container { 
            background: #f8f9fa; 
            border: 2px dashed #667eea; 
            border-radius: 12px; 
            padding: 15px; 
            min-height: 200px; 
            transition: all 0.3s;
            position: relative;
        }
        
        .group-container.drag-over { 
            border-color: #28a745; 
            background: #f8fff8; 
            transform: scale(1.02); 
        }
        
        .group-drag-handle {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 24px;
            height: 24px;
            cursor: move;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            opacity: 0.7;
            transition: all 0.2s;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        .group-container:hover .group-drag-handle {
            opacity: 1;
            background: rgba(102, 126, 234, 0.2);
            transform: scale(1.1);
        }
        
        .group-container.dragging-group {
            opacity: 0.7;
            transform: rotate(2deg);
            z-index: 1000;
        }
        
        .group-meta-info {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
            z-index: 10;
        }
        
        .group-rank {
            background: rgba(102, 126, 234, 0.7);
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: normal;
        }
        
        .group-card-count {
            background: rgba(40, 167, 69, 0.7);
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: normal;
        }
        
        .group-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            padding-bottom: 10px; 
            border-bottom: 1px solid #dee2e6; 
            padding-top: 35px;
            padding-right: 80px;
        }
        
        .group-title { 
            font-weight: 600; 
            color: #333; 
            flex: 1; 
            font-size: 16px;
        }
        
        .group-title.editable { 
            cursor: pointer; 
            padding: 4px 8px; 
            border-radius: 4px; 
            transition: background 0.2s;
        }
        
        .group-title.editable:hover { background: #e9ecef; }
        
        .group-actions { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .delete-group-btn { 
            background: #e74c3c; 
            color: white; 
            border: none; 
            width: 24px; 
            height: 24px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 14px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }
        
        .group-content { min-height: 120px; }
        .empty-group { text-align: center; color: #adb5bd; padding: 40px 20px; font-style: italic; }
        .group-content .card-item { margin: 8px 0; }
        
        .sorting-actions { 
            background: white; 
            padding: 20px 30px; 
            border-top: 1px solid #eee; 
            display: flex; 
            justify-content: center; 
            gap: 25px; 
            flex-wrap: wrap; 
        }
        
        .completion-container { text-align: center; padding: 60px 30px; }
        
        .completion-message { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 40px; 
            border-radius: 12px; 
            margin-bottom: 40px;
        }
        
        .completion-message h2 { font-size: 32px; margin-bottom: 15px; }
        
        .completion-stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px; 
            margin: 30px 0; 
        }
        
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-2 { margin-top: 10px; }
        .mt-3 { margin-top: 15px; }
        .mb-2 { margin-bottom: 10px; }
        .mb-3 { margin-bottom: 15px; }
        .flex { display: flex !important; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-2 { gap: 10px; }
        .gap-3 { gap: 15px; }
        .justify-center { justify-content: center; }
        .items-center { align-items: center; }
        .w-full { width: 100%; }
        
        .alert { 
            padding: 12px 16px; 
            border-radius: 8px; 
            margin: 15px 0; 
            border-left: 4px solid;
        }
        
        .alert-info { background: #e3f2fd; border-color: #2196f3; color: #1976d2; }
        .alert-warning { background: #fff3e0; border-color: #ff9800; color: #f57c00; }
        .alert-success { background: #e8f5e9; border-color: #4caf50; color: #388e3c; }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
        }
        
        .modal.show { display: flex; }
        
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            max-width: 700px; 
            width: 90%; 
            max-height: 80vh; 
            overflow-y: auto;
        }
        
        .welcome-container { text-align: center; padding: 60px 30px; }
        .welcome-message { background: white; padding: 40px; border-radius: 12px; margin-bottom: 30px; line-height: 1.8; }
        
        .notification {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            max-width: 500px;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            font-weight: 600;
            font-size: 16px;
            animation: slideInDown 0.3s ease-out;
            border: 2px solid;
        }
        
        @keyframes slideInDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-30px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        .error-display {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        /* ëª¨ë°”ì¼ ë°˜ì‘í˜• */
        @media (max-width: 768px) { 
            .sorting-workspace { 
                grid-template-columns: 1fr; 
                gap: 20px; 
                padding: 20px; 
            } 
            
            .admin-grid { 
                grid-template-columns: 1fr;
                padding: 20px; 
            } 
            
            .groups-container { 
                grid-template-columns: 1fr;
            } 
            
            .groups-header { 
                flex-direction: column; 
                gap: 10px; 
            } 
            
            .sorting-header { 
                flex-direction: column; 
                text-align: center; 
            } 
            
            .nav-buttons { 
                flex-direction: column; 
                width: 100%; 
            }
            
            .modal-content {
                max-width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ì°¸ì—¬ì í™˜ì˜ í˜ì´ì§€ -->
        <div id="welcome-page" class="page">
            <div class="welcome-container">
                <div class="welcome-message">
                    <h1 style="color: #333; margin-bottom: 30px;">ì•ˆë…•í•˜ì„¸ìš”!ğŸ˜„</h1>
                    <p style="margin-bottom: 20px;">ë¡¯ë°í™ˆì‡¼í•‘ ì˜¨ë¼ì¸ ë¦¬ì„œì¹˜ì— ì°¸ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</p>
                    <p style="margin-bottom: 20px;">ë³¸ ë¦¬ì„œì¹˜ëŠ” ê³ ê°ë‹˜ê»˜ ë³´ë‹¤ ì‰½ê³  í¸ë¦¬í•˜ê²Œ í˜œíƒ ì •ë³´ë¥¼ ì œê³µí•˜ê¸° ìœ„í•´ ë¡¯ë°í™ˆì‡¼í•‘ ì´ìš© ê²½í—˜ì„ ë°”íƒ•ìœ¼ë¡œ ì§„í–‰ë©ë‹ˆë‹¤.</p>
                    <p style="margin-bottom: 20px;">í˜œíƒ ë‚´ìš©ì„ ì¹´ë“œ í˜•íƒœë¡œ ë³´ì—¬ë“œë¦¬ë©´, ê³ ê°ë‹˜ê»˜ì„œ ê´€ë ¨ ìˆëŠ” í˜œíƒë¼ë¦¬ ì§ì ‘ ë¶„ë¥˜í•´ë³´ëŠ” ì°¸ì—¬í˜• ë¦¬ì„œì¹˜ì…ë‹ˆë‹¤.</p>
                    <p style="margin-bottom: 20px;">ë¦¬ì„œì¹˜ëŠ” ì•½ 10ë¶„ ë‚´ì™¸ì˜ ì‹œê°„ì´ ì†Œìš”ë©ë‹ˆë‹¤.</p>
                    <p style="margin-bottom: 20px;">í•˜ë‹¨ì˜ 'ë¦¬ì„œì¹˜ ì°¸ì—¬í•˜ê¸°' ë²„íŠ¼ì„ ëˆ„ë¥´ì‹  í›„ ê¸°ë³¸ ì •ë³´ë¥¼ ì…ë ¥í•˜ì‹œë©´, ë¦¬ì„œì¹˜ ì°¸ì—¬ê°€ ê°€ëŠ¥í•©ë‹ˆë‹¤.</p>
                    <p style="font-weight: 600;">ì¹´ë“œ ë¶„ë¥˜ë¥¼ ì™„ë£Œí•˜ì‹  í›„ì—ëŠ” "ì‘ë‹µ ì œì¶œí•˜ê¸°" ë²„íŠ¼ì„ ê¼­ ëˆŒëŸ¬ì£¼ì‹œê¸¸ ë°”ëë‹ˆë‹¤.</p>
                </div>
                <button class="btn btn-primary" style="font-size: 18px; padding: 15px 30px;" onclick="showParticipantLogin()">
                    ë¦¬ì„œì¹˜ ì°¸ì—¬í•˜ê¸°
                </button>
            </div>
        </div>

        <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ -->
        <div id="admin-login-page" class="page">
            <div class="login-container">
                <div class="login-box">
                    <h1 class="login-title">ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
                    <p class="login-subtitle">ê´€ë¦¬ì ì „ìš© í˜ì´ì§€ì…ë‹ˆë‹¤</p>
                    
                    <form onsubmit="adminLogin(event)">
                        <div class="form-group">
                            <label class="form-label">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
                            <input 
                                type="password" 
                                id="admin-password" 
                                class="form-control" 
                                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                required
                            >
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-full">
                            ë¡œê·¸ì¸
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ -->
        <div id="admin-dashboard-page" class="page">
            <div class="card">
                <div class="header">
                    <div class="logo">ì¹´ë“œì†ŒíŒ… ê´€ë¦¬ì (ìµœì í™” ë²„ì „)</div>
                    <div class="nav-buttons">
                        <button class="btn btn-danger" onclick="adminLogout()">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>

                <div class="admin-grid">
                    <div class="admin-section">
                        <h3>ğŸ¯ í”„ë¡œì íŠ¸ ì„¤ì •</h3>
                        
                        <div class="form-group">
                            <label class="form-label">í”„ë¡œì íŠ¸ ì œëª©</label>
                            <input 
                                type="text" 
                                id="project-title" 
                                class="form-control" 
                                value="í˜œíƒ ì½˜í…ì¸  ì¹´ë“œì†ŒíŒ…"
                                placeholder="í”„ë¡œì íŠ¸ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                            >
                        </div>

                        <div class="form-group">
                            <label class="form-label">ì†ŒíŒ… ë°©ì‹</label>
                            <select id="sorting-type" class="form-control">
                                <option value="open">ì˜¤í”ˆ ì†ŒíŒ… (ê·¸ë£¹ ììœ  ìƒì„±)</option>
                                <option value="closed">í´ë¡œì¦ˆë“œ ì†ŒíŒ… (ê³ ì • ê·¸ë£¹ë§Œ)</option>
                                <option value="hybrid" selected>í•˜ì´ë¸Œë¦¬ë“œ ì†ŒíŒ… (ê¸°ë³¸ + ì‚¬ìš©ì ìƒì„±)</option>
                            </select>
                        </div>

                        <div class="form-group" id="predefined-groups-section">
                            <label class="form-label">ê¸°ë³¸ ê·¸ë£¹ (í´ë¡œì¦ˆë“œ/í•˜ì´ë¸Œë¦¬ë“œ ì „ìš©)</label>
                            <textarea 
                                id="predefined-groups" 
                                class="form-control textarea" 
                                placeholder="í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ì„¸ìš” (ìµœëŒ€ 8ê°œ ê¶Œì¥)"
                            >êµ¬ë§¤(ì ë¦½/ì‚¬ì€)
ê²°ì œí• ì¸(ì¹´ë“œ/ë¬´ì´ì)
ë©¤ë²„ì‹­/ì²´í—˜ë‹¨
ì°¸ì—¬/ë³´ìƒ
ë‚˜ë§Œì˜ í˜œíƒ ì•Œë¦¼</textarea>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="shuffle-cards" checked>
                            <label for="shuffle-cards">ì¹´ë“œ ìˆœì„œ ë¬´ì‘ìœ„ ì„ê¸°</label>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="allow-edit-groups" checked>
                            <label for="allow-edit-groups">ê¸°ë³¸ ê·¸ë£¹ëª… ìˆ˜ì • í—ˆìš©</label>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>ğŸƒ ì¹´ë“œ ëª©ë¡ ê´€ë¦¬</h3>
                        
                        <div class="form-group">
                            <label class="form-label">ì¹´ë“œ ëª©ë¡ (ìµœëŒ€ 30ê°œ ê¶Œì¥)</label>
                            <textarea 
                                id="card-list" 
                                class="form-control textarea" 
                                placeholder="í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ì„¸ìš”"
                                style="min-height: 200px;"
                            >ì—˜í¬ì¸íŠ¸ ì‚¬ìš©í•˜ê³  100ë°° ì ë¦½í•˜ê¸°
ë©¤ë²„ìŠ¤ ì¹´ë“œ ì‚¬ìš©í•˜ê³  5% ì ë¦½í•˜ê¸°
í•´ì™¸ ì§êµ¬ ìƒí’ˆ êµ¬ë§¤í•˜ê³  í˜œíƒ ë°›ê¸°
ì—˜ë¼ì´ë¸Œ ìƒí’ˆ êµ¬ë§¤í•˜ê³  ì ë¦½ê¸ˆ ë°›ê¸°
í–‰ì‚¬ ìƒí’ˆ êµ¬ë§¤í•˜ê³  ì ë¦½ê¸ˆ ë°›ê¸°
ìµœìœ ë¼ì‡¼ ìƒí’ˆ êµ¬ë§¤í•˜ê³  ì ë¦½ê¸ˆ ë°›ê¸°
ì„ ë¬¼í•˜ê¸° ì£¼ë¬¸í•˜ê³  ì¿ í° ë°›ê¸°
í•´ì™¸ ì§êµ¬ ìƒí’ˆ êµ¬ë§¤í•˜ê³  í˜œíƒ ë°›ê¸°
ì¤‘ì†Œê¸°ì—… ìƒí’ˆ êµ¬ë§¤í•˜ê³  ìƒí’ˆê¶Œ ì‘ëª¨í•˜ê¸°
ë¬´ì´ìí• ë¶€ ì‹ ìš©ì¹´ë“œ ì•ˆë‚´
ì œíœ´ ì¹´ë“œ ì‚¬ìš©í•˜ê³  ìºì‹œë°± ë°›ê¸°
ì œíœ´ ì¹´ë“œ ì‚¬ìš©í•˜ê³  5% ì²­êµ¬í• ì¸
ë²¨ë¦¬ê³°ì¹´ë“œë¡œ í• ì¸ ì¿ í° ë°›ê¸°
ë„¤ì´ë²„í˜ì´ ì‚¬ìš©í•˜ê³  ë„¤ì´ë²„í¬ì¸íŠ¸ ì ë¦½í•˜ê¸°
ì‹ ìš©ì¹´ë“œ ë°œê¸‰í•˜ê³  ìºì‹œë°± & ì—˜í´ëŸ½ ë¬´ë£Œê°€ì…
ë¡¯ë°ì¹´ë“œë¡œ ë¬´ì´ìí• ë¶€ í˜œíƒ
ì—˜í´ëŸ½ ê³ ê° ì „ìš© ì œíœ´ í• ì¸ ë°›ê¸°
íšŒì›ê°€ì…í•˜ê³  í• ì¸ ì¿ í° ë°›ê¸°
ì—˜í´ëŸ½ ê³ ê° ì²´í—˜ë‹¨ ì‹ ì²­í•˜ê¸°
ë‹¤ì´ì•„ëª¬ë“œ ê³ ê° ì—˜í´ëŸ½ ë¬´ë£Œê°€ì…
ë¡¯ë°ì˜¤ë„ˆìŠ¤ ë©¤ë²„ì‹­ ê°€ì…í•˜ê¸°
ì—˜í´ëŸ½ ê°€ì…í•˜ê³  ì ë¦½ê¸ˆ ë°›ê¸°
ì¶œì„í•˜ê³  ì„ ë¬¼ êµí™˜ê¶Œ ë°›ê¸°
ì˜¤ëŠ˜ì˜ ìƒí’ˆ êµ¬ê²½í•˜ê³  ì„ ë¬¼ êµí™˜ê¶Œ ë°›ê¸°
ìˆí•‘ êµ¬ê²½í•˜ê³  ì„ ë¬¼ êµí™˜ê¶Œ ë°›ê¸°
ë°”ë¡œTVí†¡ ì°¸ì—¬í•˜ê³  ì„ ë¬¼ êµí™˜ê¶Œ ë°›ê¸°</textarea>
                        </div>

                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="new-card" 
                                class="form-control" 
                                placeholder="ìƒˆ ì¹´ë“œ ì¶”ê°€"
                                style="flex: 1;"
                            >
                            <button class="btn btn-secondary" onclick="addNewCard()">ì¶”ê°€</button>
                        </div>

                        <div class="alert alert-info mt-2">
                            <strong>í˜„ì¬ ì¹´ë“œ ìˆ˜:</strong> <span id="card-count">30</span>ê°œ
                            <div id="card-warning" class="hidden" style="color: #f57c00; margin-top: 5px;">
                                âš ï¸ ì¹´ë“œ ìˆ˜ê°€ ë§ìœ¼ë©´ ì„±ëŠ¥ ë¬¸ì œê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 30ê°œ ì´í•˜ ê¶Œì¥
                            </div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>ğŸ”— Google Sheets ì„¤ì •</h3>
                        
                        <div class="form-group">
                            <label class="form-label">ì›¹ì•± URL</label>
                            <input 
                                type="text" 
                                id="webapp-url" 
                                class="form-control" 
                                placeholder="https://script.google.com/macros/s/AKfycbxQevCB_bl__tovjALHhxy3cBp1O-feVE0QN8QN_jqevvqpGJKbvqExgWxXTCasIYOE/exec"
                            >
                        </div>

                        <div class="form-group">
                            <label class="form-label">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID</label>
                            <input 
                                type="text" 
                                id="spreadsheet-id" 
                                class="form-control" 
                                placeholder="1BjcB7eQa-pBAuL_6yCfxIXmn8NSRuwcBgz7JrCRyfXg"
                            >
                        </div>

                        <button class="btn btn-primary w-full mb-3" onclick="testConnection()">
                            ğŸ”— ì—°ê²° í…ŒìŠ¤íŠ¸
                        </button>

                        <div id="connection-status" class="alert alert-info">
                            <strong>ì—°ê²° ìƒíƒœ:</strong> í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>ğŸ”— ì‘ë‹µì URL ìƒì„±</h3>
                        
                        <button class="btn btn-primary w-full mb-3" onclick="generateURL()">
                            í”„ë¡œì íŠ¸ ì €ì¥ ë° URL ìƒì„±
                        </button>

                        <div id="generated-url-section" class="hidden">
                            <div class="form-group">
                                <label class="form-label">ìƒì„±ëœ ì‘ë‹µì URL</label>
                                <div style="position: relative;">
                                    <input 
                                        type="text" 
                                        id="generated-url" 
                                        class="form-control" 
                                        readonly
                                        style="padding-right: 60px;"
                                    >
                                    <button 
                                        class="btn btn-secondary" 
                                        onclick="copyURL()"
                                        style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); padding: 5px 10px; font-size: 12px;"
                                    >
                                        ë³µì‚¬
                                    </button>
                                </div>
                            </div>

                            <div class="flex gap-2 mt-2">
                                <button class="btn btn-secondary" onclick="openParticipantURL()">ğŸ‘¤ ì‘ë‹µì í˜ì´ì§€</button>
                                <button class="btn btn-secondary" onclick="openGoogleSheets()">ğŸ“Š Google Sheets ì—´ê¸°</button>
                            </div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>ğŸ“Š ì‘ë‹µ í˜„í™©</h3>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="total-responses">0</div>
                                <div class="stat-label">ì´ ì‘ë‹µ ìˆ˜</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="completed-responses">0</div>
                                <div class="stat-label">ì™„ë£Œëœ ì‘ë‹µ</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="ongoing-responses">0</div>
                                <div class="stat-label">ì§„í–‰ ì¤‘</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="avg-duration">0ë¶„</div>
                                <div class="stat-label">í‰ê·  ì†Œìš”ì‹œê°„</div>
                            </div>
                        </div>

                        <div class="flex gap-2 mt-3">
                            <button class="btn btn-primary" onclick="downloadAllResponses()" style="flex: 1;">
                                ğŸ“¥ JSON ë‹¤ìš´ë¡œë“œ
                            </button>
                            <button class="btn btn-secondary" onclick="openGoogleSheets()">
                                ğŸ“Š Google Sheets
                            </button>
                            <button class="btn btn-secondary" onclick="clearAllData()">
                                ğŸ—‘ï¸ ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì‘ë‹µì ë¡œê·¸ì¸ -->
        <div id="participant-login-page" class="page">
            <div class="login-container">
                <div class="login-box">
                    <h1 class="login-title" id="participant-project-title">ì°¸ì—¬ì ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</h1>
                    
                    <form onsubmit="participantLogin(event)">
                        <div class="form-group">
                            <label class="form-label">ì´ë¦„</label>
                            <input 
                                type="text" 
                                id="participant-name" 
                                class="form-control" 
                                placeholder="í™ê¸¸ë™"
                                pattern="[ê°€-í£]+"
                                title="í•œê¸€ë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”"
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label class="form-label">íœ´ëŒ€í° ë’·ë²ˆí˜¸ 4ìë¦¬</label>
                            <input 
                                type="text" 
                                id="participant-phone" 
                                class="form-control" 
                                placeholder="1234"
                                pattern="[0-9]{4}"
                                maxlength="4"
                                title="ìˆ«ì 4ìë¦¬ë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”"
                                required
                            >
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-full">
                            ì‹œì‘í•˜ê¸°
                        </button>
                    </form>

                    <div id="existing-response-notice" class="alert alert-warning mt-3 hidden">
                        <strong>âš ï¸ ê¸°ì¡´ ì‘ë‹µ ë°œê²¬</strong><br>
                        ì´ì „ì— ì§„í–‰í•˜ë˜ ì‘ë‹µì´ ìˆìŠµë‹ˆë‹¤. ì´ì–´ì„œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                        <div class="flex gap-2 mt-2">
                            <button class="btn btn-secondary" onclick="continueExisting()">ì´ì–´ì„œ í•˜ê¸°</button>
                            <button class="btn btn-danger" onclick="startNew()">ìƒˆë¡œ ì‹œì‘</button>
                        </div>
                    </div>

                    <div class="alert alert-success mt-3">
                        <strong>ğŸ“‹ ì°¸ì—¬ ì•ˆë‚´:</strong><br>
                        â€¢ ì˜ˆìƒ ì†Œìš”ì‹œê°„: ì•½ 10ë¶„<br>
                        â€¢ ì´ì–´ì§€ëŠ” í™”ë©´ì—ì„œ 'ì¹´ë“œ ë¶„ë¥˜í•˜ê¸° ì•ˆë‚´ì„œ'ê°€ ì œê³µë©ë‹ˆë‹¤<br>
                    </div>

                    <div class="text-center mt-3">
                        <button class="btn btn-secondary" onclick="showWelcomePage()">
                            â† ëŒì•„ê°€ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì¹´ë“œì†ŒíŒ… ë©”ì¸ í™”ë©´ -->
        <div id="sorting-page" class="page">
            <div class="card">
                <div class="sorting-header">
                    <div class="participant-info">
                        <h2 id="sorting-participant-name">ì°¸ì—¬ìë‹˜ì˜ ì¹´ë“œì†ŒíŒ…</h2>
                        <p id="sorting-type-info">í•˜ì´ë¸Œë¦¬ë“œ ì†ŒíŒ… ì§„í–‰ ì¤‘</p>
                    </div>
                    <div class="progress-section">
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
                            </div>
                            <div class="progress-text" id="progress-text">
                                ì§„í–‰ ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sorting-workspace">
                    <div class="card-pool">
                        <h3>ğŸƒ ë¯¸ë¶„ë¥˜ ì¹´ë“œ (<span id="unassigned-count">0</span>ê°œ)</h3>
                        <div class="card-list" id="card-pool"></div>
                    </div>

                    <div class="groups-area">
                        <div class="groups-header">
                            <button 
                                class="btn btn-secondary" 
                                onclick="showSortingGuide()"
                            >
                                ğŸ“– ì¹´ë“œ ë¶„ë¥˜í•˜ê¸° ì•ˆë‚´ì„œ
                            </button>
                            <button 
                                class="btn btn-secondary" 
                                id="create-group-btn" 
                                onclick="createNewGroup()"
                            >
                                â• ìƒˆ ê·¸ë£¹ ë§Œë“¤ê¸°
                            </button>
                        </div>
                        
                        <div class="group-order-guide">
                            ğŸ’¡ ì¤‘ìš”í•˜ë‹¤ê³  ìƒê°í•˜ì‹œëŠ” ê·¸ë£¹ìˆœìœ¼ë¡œ ë°°ì—´í•´ë³´ì„¸ìš”! ê·¸ë£¹ ì œëª©ì„ ë“œë˜ê·¸í•´ì„œ ìˆœì„œë¥¼ ë³€ê²½í•  ìˆ˜ ìˆì–´ìš”.
                        </div>
                        
                        <div class="groups-container" id="groups-container"></div>
                    </div>
                </div>

                <div class="sorting-actions">
                    <button class="btn btn-secondary" onclick="returnToLogin()">
                        â† ë¡œê·¸ì¸ìœ¼ë¡œ
                    </button>
                    <button class="btn btn-secondary" onclick="resetAllCards()">
                        ğŸ”„ ì „ì²´ ì´ˆê¸°í™”
                    </button>
                    <button class="btn btn-secondary" onclick="autoSave()">
                        ğŸ’¾ ì„ì‹œ ì €ì¥
                    </button>
                    <button class="btn btn-primary" onclick="submitSorting()" id="submit-btn">
                        âœ… ì‘ë‹µ ì œì¶œí•˜ê¸°
                    </button>
                </div>
            </div>
        </div>

        <!-- ì™„ë£Œ í™”ë©´ -->
        <div id="completion-page" class="page">
            <div class="card">
                <div class="completion-container">
                    <div class="completion-message">
                        <h2>ë¡¯ë°í™ˆì‡¼í•‘ í˜œíƒ ë§¤ì¥ì˜ ì¹´ë“œ ë¶„ë¥˜í•˜ê¸° ë¦¬ì„œì¹˜ì— ì°¸ì—¬í•´ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.</h2>
                        <p>ì‘ë‹µí•´ì£¼ì‹  ê²°ê³¼ëŠ” í˜œíƒ ë§¤ì¥ì˜ ë©”ë‰´ ê°œì„ ì— í¬ê²Œ ë„ì›€ì´ ë  ê±°ì˜ˆìš” : D</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒˆ ê·¸ë£¹ ìƒì„± ëª¨ë‹¬ -->
    <div id="create-group-modal" class="modal">
        <div class="modal-content">
            <h3>ìƒˆ ê·¸ë£¹ ë§Œë“¤ê¸°</h3>
            <div class="form-group">
                <label class="form-label">ê·¸ë£¹ ì´ë¦„</label>
                <input 
                    type="text" 
                    id="new-group-name" 
                    class="form-control" 
                    placeholder="ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                    maxlength="50"
                >
            </div>
            <div class="flex gap-2 justify-center">
                <button class="btn btn-secondary" onclick="closeModal('create-group-modal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="confirmCreateGroup()">ìƒì„±</button>
            </div>
        </div>
    </div>

    <!-- ì¹´ë“œ ë¶„ë¥˜í•˜ê¸° ë°©ë²• ê°€ì´ë“œ ëª¨ë‹¬ -->
    <div id="sorting-guide-modal" class="modal">
        <div class="modal-content">
            <h3>ğŸ“– ì¹´ë“œ ë¶„ë¥˜í•˜ê¸° ì•ˆë‚´ì„œ</h3>
            <div style="padding: 20px 0; line-height: 1.8;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin-bottom: 15px; font-size: 16px;"><strong>ê¼­! ì½ì–´ì£¼ì„¸ìš”!ğŸ’œ</strong></p>
                    <p style="margin-bottom: 15px; font-size: 16px;"><strong>1.</strong> ì™¼ìª½ì— ìˆëŠ” ë¯¸ë¶„ë¥˜ ì¹´ë“œì˜ 'ì¹´ë“œ ë‚´ìš©'ì„ ê¼¼ê¼¼í•˜ê²Œ í™•ì¸í•´ì£¼ì„¸ìš”.</p>
                    <p style="margin-bottom: 15px; font-size: 14px; color: #667eea; padding-left: 20px; font-style: italic;">
                        *ì¹´ë“œ ë‚´ìš©ì€ ë¡¯ë°í™ˆì‡¼í•‘ í˜œíƒ ë©”ë‰´ì—ì„œ ì œê³µí•˜ê³  ìˆëŠ” í˜œíƒë“¤ì´ì—ìš”!
                    </p>
                    <p style="margin-bottom: 15px; font-size: 16px;"><strong>2.</strong> ì™¼ìª½ì— ìˆëŠ” ì¹´ë“œë¥¼ ê´€ë ¨ì„±ì´ ë†’ë‹¤ê³  ìƒê°ë˜ëŠ” ì˜¤ë¥¸ìª½ ê·¸ë£¹ìœ¼ë¡œ ì˜®ê²¨ì£¼ì„¸ìš”.</p>
                    <p style="margin-bottom: 15px; font-size: 16px;"><strong>3.</strong> ê·¸ë£¹ ì´ë¦„ì„ ë³€ê²½í•˜ê³  ì‹¶ë‹¤ë©´, ê·¸ë£¹ ì´ë¦„ì„ í´ë¦­í•´ ì›í•˜ëŠ” ì´ë¦„ìœ¼ë¡œ ìˆ˜ì •í•´ ì£¼ì„¸ìš”.</p>
                    <p style="margin-bottom: 15px; font-size: 16px;"><strong>4.</strong> ì˜¤ë¥¸ìª½ ìƒë‹¨ì˜ 'ìƒˆ ê·¸ë£¹ ë§Œë“¤ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ ìƒˆë¡œìš´ ê·¸ë£¹ë„ ì¶”ê°€í•  ìˆ˜ ìˆì–´ìš”.</p>
                    <p style="margin-bottom: 0; font-size: 16px;"><strong>5.</strong> ëª¨ë“  ì¹´ë“œë¥¼ ê·¸ë£¹ìœ¼ë¡œ ì˜®ê¸°ì…¨ë‹¤ë©´, 'ì‘ë‹µ ì œì¶œí•˜ê¸°' ë²„íŠ¼ì„ ëˆŒëŸ¬ ì£¼ì„¸ìš”.</p>
                </div>
                
                <p style="color: #666; font-style: italic; text-align: center; margin-top: 20px;">
                    â­ì§€ê¸ˆ ë³´ê³  ê³„ì‹  'ì¹´ë“œ ë¶„ë¥˜í•˜ê¸° ì•ˆë‚´ì„œ'ëŠ” ë²„íŠ¼ì„ í†µí•´ ì–¸ì œë“  ë‹¤ì‹œ ë³¼ ìˆ˜ ìˆì–´ìš”.
                </p>
            </div>
            <div class="flex justify-center">
                <button class="btn btn-primary" onclick="closeModal('sorting-guide-modal')">í™•ì¸</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ğŸ”— Google Sheets ì—°ë™ ì„¤ì •
        // ============================================
        
        let GOOGLE_APPS_SCRIPT_URL = '';
        let SPREADSHEET_ID = '';

        // ============================================
        // ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ê´€ë¦¬
        // ============================================
        
        let appState = {
            currentUser: null,
            currentProject: null,
            currentParticipant: null,
            sortingData: null,
            startTime: null
        };

        const DEFAULT_PROJECT = {
            id: 'default-project',
            title: 'í˜œíƒ ì½˜í…ì¸  ì¹´ë“œì†ŒíŒ…',
            cards: [
                'ì—˜í¬ì¸íŠ¸ ì‚¬ìš©í•˜ê³  100ë°° ì ë¦½í•˜ê¸°',
                'ë©¤ë²„ìŠ¤ ì¹´ë“œ ì‚¬ìš©í•˜ê³  5% ì ë¦½í•˜ê¸°', 
                'í•´ì™¸ ì§êµ¬ ìƒí’ˆ êµ¬ë§¤í•˜ê³  í˜œíƒ ë°›ê¸°',
                'ì—˜ë¼ì´ë¸Œ ìƒí’ˆ êµ¬ë§¤í•˜ê³  ì ë¦½ê¸ˆ ë°›ê¸°',
                'í–‰ì‚¬ ìƒí’ˆ êµ¬ë§¤í•˜ê³  ì ë¦½ê¸ˆ ë°›ê¸°',
                'ìµœìœ ë¼ì‡¼ ìƒí’ˆ êµ¬ë§¤í•˜ê³  ì ë¦½ê¸ˆ ë°›ê¸°',
                'ì„ ë¬¼í•˜ê¸° ì£¼ë¬¸í•˜ê³  ì¿ í° ë°›ê¸°',
                'í•´ì™¸ ì§êµ¬ ìƒí’ˆ êµ¬ë§¤í•˜ê³  í˜œíƒ ë°›ê¸°',
                'ì¤‘ì†Œê¸°ì—… ìƒí’ˆ êµ¬ë§¤í•˜ê³  ìƒí’ˆê¶Œ ì‘ëª¨í•˜ê¸°',
                'ë¬´ì´ìí• ë¶€ ì‹ ìš©ì¹´ë“œ ì•ˆë‚´',
                'ì œíœ´ ì¹´ë“œ ì‚¬ìš©í•˜ê³  ìºì‹œë°± ë°›ê¸°',
                'ì œíœ´ ì¹´ë“œ ì‚¬ìš©í•˜ê³  5% ì²­êµ¬í• ì¸',
                'ë²¨ë¦¬ê³°ì¹´ë“œë¡œ í• ì¸ ì¿ í° ë°›ê¸°',
                'ë„¤ì´ë²„í˜ì´ ì‚¬ìš©í•˜ê³  ë„¤ì´ë²„í¬ì¸íŠ¸ ì ë¦½í•˜ê¸°',
                'ì‹ ìš©ì¹´ë“œ ë°œê¸‰í•˜ê³  ìºì‹œë°± & ì—˜í´ëŸ½ ë¬´ë£Œê°€ì…',
                'ë¡¯ë°ì¹´ë“œë¡œ ë¬´ì´ìí• ë¶€ í˜œíƒ',
                'ì—˜í´ëŸ½ ê³ ê° ì „ìš© ì œíœ´ í• ì¸ ë°›ê¸°',
                'íšŒì›ê°€ì…í•˜ê³  í• ì¸ ì¿ í° ë°›ê¸°',
                'ì—˜í´ëŸ½ ê³ ê° ì²´í—˜ë‹¨ ì‹ ì²­í•˜ê¸°',
                'ë‹¤ì´ì•„ëª¬ë“œ ê³ ê° ì—˜í´ëŸ½ ë¬´ë£Œê°€ì…',
                'ë¡¯ë°ì˜¤ë„ˆìŠ¤ ë©¤ë²„ì‹­ ê°€ì…í•˜ê¸°',
               	'ì—˜í´ëŸ½ ê°€ì…í•˜ê³  ì ë¦½ê¸ˆ ë°›ê¸°',
               	'ì¶œì„í•˜ê³  ì„ ë¬¼ êµí™˜ê¶Œ ë°›ê¸°',
		'ì˜¤ëŠ˜ì˜ ìƒí’ˆ êµ¬ê²½í•˜ê³  ì„ ë¬¼ êµí™˜ê¶Œ ë°›ê¸°',
		'ìˆí•‘ êµ¬ê²½í•˜ê³  ì„ ë¬¼ êµí™˜ê¶Œ ë°›ê¸°',
               	'ë°”ë¡œTVí†¡ ì°¸ì—¬í•˜ê³  ì„ ë¬¼ êµí™˜ê¶Œ ë°›ê¸°',
            ],
            sortingType: 'hybrid',
            predefinedGroups: ['êµ¬ë§¤(ì ë¦½/ì‚¬ì€)', 'ê²°ì œí• ì¸(ì¹´ë“œ/ë¬´ì´ì)', 'ë©¤ë²„ì‹­/ì²´í—˜ë‹¨', 'ì°¸ì—¬/ë³´ìƒ', 'ë‚˜ë§Œì˜ í˜œíƒ ì•Œë¦¼'],
            shuffleCards: true,
            allowEditGroups: true,
            createdAt: new Date().toISOString()
        };

        // ============================================
        // ì˜¤ë¥˜ ì²˜ë¦¬ ë° ë””ë²„ê¹… í•¨ìˆ˜ë“¤
        // ============================================

        function handleError(error, context = 'Unknown') {
            console.error(`âŒ ì˜¤ë¥˜ ë°œìƒ [${context}]:`, error);
            
            // ì˜¤ë¥˜ ì •ë³´ë¥¼ í™”ë©´ì— í‘œì‹œ (ê°œë°œ ëª¨ë“œì¼ ë•Œ)
            if (window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1')) {
                displayErrorMessage(error, context);
            }
            
            // ì‚¬ìš©ìì—ê²Œ ì¹œí™”ì ì¸ ë©”ì‹œì§€ í‘œì‹œ
            showNotification('ì¼ì‹œì ì¸ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ìƒˆë¡œê³ ì¹¨ í•´ì£¼ì„¸ìš”.', 'error');
        }

        function displayErrorMessage(error, context) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-display';
            errorDiv.innerHTML = `
                <strong>ë””ë²„ê·¸ ì •ë³´ [${context}]:</strong>
                ${error.message || error}
                
                Stack Trace:
                ${error.stack || 'Stack trace not available'}
                
                <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px;">ë‹«ê¸°</button>
            `;
            
            document.body.appendChild(errorDiv);
            
            // 10ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 10000);
        }

        // ============================================
        // ğŸ”— Google Sheets ì—°ë™ í•¨ìˆ˜ë“¤ (ìµœì í™”)
        // ============================================

        async function saveToGoogleSheets(responseData, projectConfig) {
            return new Promise((resolve, reject) => {
                try {
                    if (!GOOGLE_APPS_SCRIPT_URL) {
                        const config = loadFromStorage('google_sheets_config');
                        if (config && config.webappUrl) {
                            GOOGLE_APPS_SCRIPT_URL = config.webappUrl;
                            SPREADSHEET_ID = config.spreadsheetId || '';
                        }
                    }

                    if (!GOOGLE_APPS_SCRIPT_URL) {
                        throw new Error('Google Apps Script URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
                    }

                    console.log('ğŸ”— Google Sheets ì €ì¥ ì‹œì‘ (ìµœì í™”ëœ ë°©ì‹)...');
                    
                    // ë°ì´í„° ì••ì¶• ë° ìµœì í™”
                    const exportData = formatResponseForExport(responseData, projectConfig);
                    const minimalData = compressDataForGoogleSheets(exportData);
                    
                    // ì½œë°± í•¨ìˆ˜ëª… ìƒì„±
                    const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    
                    // ì „ì—­ ì½œë°± í•¨ìˆ˜ ë“±ë¡
                    window[callbackName] = function(response) {
                        // ì½œë°± ì‹¤í–‰ í›„ ì •ë¦¬
                        delete window[callbackName];
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                        
                        console.log('ğŸ“Š Google Sheets ì‘ë‹µ:', response);
                        
                        if (response && response.status === 'success') {
                            showNotification('âœ… ì‘ë‹µì´ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                            resolve(response);
                        } else {
                            reject(new Error(response?.message || 'ì €ì¥ ì‹¤íŒ¨'));
                        }
                    };
                    
                    // URL êµ¬ì„± (ë°ì´í„° í¬ê¸° ìµœì í™”)
                    const dataString = JSON.stringify(minimalData);
                    console.log('ì „ì†¡ ë°ì´í„° í¬ê¸°:', dataString.length, 'bytes');
                    
                    if (dataString.length > 8000) {
                        console.warn('âš ï¸ ë°ì´í„° í¬ê¸°ê°€ í½ë‹ˆë‹¤. ì¶”ê°€ ì••ì¶•ì„ ì ìš©í•©ë‹ˆë‹¤.');
                        // ì¶”ê°€ ì••ì¶• ë¡œì§
                        minimalData.ê·¸ë£¹ë³„ê²°ê³¼ = JSON.stringify(minimalData.ê·¸ë£¹ë³„ê²°ê³¼);
                    }
                    
                    const params = new URLSearchParams({
                        action: 'save',
                        data: JSON.stringify(minimalData),
                        callback: callbackName
                    });
                    
                    const url = `${GOOGLE_APPS_SCRIPT_URL}?${params.toString()}`;
                    console.log('ìš”ì²­ URL ê¸¸ì´:', url.length);
                    
                    // ë™ì  ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ìƒì„± (JSONP)
                    const script = document.createElement('script');
                    script.src = url;
                    script.onerror = function() {
                        delete window[callbackName];
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                        console.log('ğŸ”„ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ë°œìƒí–ˆì§€ë§Œ ë°ì´í„°ëŠ” ì €ì¥ëœ ê²ƒìœ¼ë¡œ ì²˜ë¦¬');
                        resolve({
                            status: 'success',
                            message: 'ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.',
                            timestamp: new Date().toISOString()
                        });
                    };
                    
                    // íƒ€ì„ì•„ì›ƒ ì„¤ì • (15ì´ˆë¡œ ë‹¨ì¶•)
                    setTimeout(() => {
                        if (window[callbackName]) {
                            delete window[callbackName];
                            if (document.head.contains(script)) {
                                document.head.removeChild(script);
                            }
                            resolve({
                                status: 'success',
                                message: 'ë°ì´í„°ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤. (íƒ€ì„ì•„ì›ƒìœ¼ë¡œ ì¸í•œ ìë™ ì™„ë£Œ)',
                                timestamp: new Date().toISOString()
                            });
                        }
                    }, 15000);
                    
                    document.head.appendChild(script);
                    console.log('ğŸ“¤ ìµœì í™”ëœ JSONP ìš”ì²­ ì „ì†¡ ì™„ë£Œ');
                    
                } catch (error) {
                    console.error('âŒ Google Sheets ì €ì¥ ì‹¤íŒ¨:', error);
                    handleError(error, 'Google Sheets ì €ì¥');
                    reject(error);
                }
            });
        }

        // ë°ì´í„° ì••ì¶• í•¨ìˆ˜
        function compressDataForGoogleSheets(exportData) {
            return {
                ì´ë¦„: exportData.ì´ë¦„,
                íœ´ëŒ€í°ë’·ë²ˆí˜¸4ìë¦¬: exportData.íœ´ëŒ€í°ë’·ë²ˆí˜¸4ìë¦¬,
                ì‹œì‘ì‹œê°„: exportData.ì‹œì‘ì‹œê°„,
                ì™„ë£Œì‹œê°„: exportData.ì™„ë£Œì‹œê°„,
                ì†Œìš”ì‹œê°„: exportData.ì†Œìš”ì‹œê°„,
                ì†ŒíŒ…ë°©ì‹: exportData.ì†ŒíŒ…ë°©ì‹,
                ì°¸ì—¬ìê°€ì¶”ê°€í•œê·¸ë£¹ìˆ˜: exportData.ì°¸ì—¬ìê°€ì¶”ê°€í•œê·¸ë£¹ìˆ˜,
                ì°¸ì—¬ìê°€ë¶„ë¥˜í•œê·¸ë£¹ìˆ˜: exportData.ì°¸ì—¬ìê°€ë¶„ë¥˜í•œê·¸ë£¹ìˆ˜,
                ê·¸ë£¹ë³„ê²°ê³¼: exportData.ê·¸ë£¹ë³„ê²°ê³¼,
                ê·¸ë£¹ìˆœì„œ: exportData.ê·¸ë£¹ìˆœì„œ
            };
        }

        async function testConnection() {
            const webappUrl = document.getElementById('webapp-url').value.trim();
            const spreadsheetId = document.getElementById('spreadsheet-id').value.trim();
            
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = '<strong>ì—°ê²° ìƒíƒœ:</strong> í…ŒìŠ¤íŠ¸ ì¤‘...';
            statusDiv.className = 'alert alert-info';
            
            try {
                if (!webappUrl || !spreadsheetId) {
                    throw new Error('ì›¹ì•± URLê³¼ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
                
                if (!webappUrl.includes('script.google.com/macros/s/')) {
                    throw new Error('ì˜¬ë°”ë¥¸ Google Apps Script ì›¹ì•± URLì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                }
                
                // ì„¤ì • ì„ì‹œ ì €ì¥
                GOOGLE_APPS_SCRIPT_URL = webappUrl;
                SPREADSHEET_ID = spreadsheetId;
                
                // JSONP í…ŒìŠ¤íŠ¸ ìš”ì²­
                const result = await new Promise((resolve, reject) => {
                    const callbackName = 'test_callback_' + Date.now();
                    
                    window[callbackName] = function(response) {
                        delete window[callbackName];
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                        resolve(response);
                    };
                    
                    const params = new URLSearchParams({
                        action: 'test',
                        callback: callbackName
                    });
                    
                    const script = document.createElement('script');
                    script.src = `${webappUrl}?${params.toString()}`;
                    script.onerror = function() {
                        delete window[callbackName];
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                        reject(new Error('ë„¤íŠ¸ì›Œí¬ ì—°ê²° ì‹¤íŒ¨'));
                    };
                    
                    setTimeout(() => {
                        if (window[callbackName]) {
                            delete window[callbackName];
                            if (document.head.contains(script)) {
                                document.head.removeChild(script);
                            }
                            reject(new Error('ì‘ë‹µ ì‹œê°„ ì´ˆê³¼'));
                        }
                    }, 10000);
                    
                    document.head.appendChild(script);
                });
                
                if (result && result.status === 'success') {
                    statusDiv.innerHTML = 'âœ… <strong>ì—°ê²° ì„±ê³µ!</strong> Google Sheetsì™€ ì •ìƒ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.';
                    statusDiv.className = 'alert alert-success';
                    
                    // ì„¤ì • ì €ì¥
                    saveToStorage('google_sheets_config', {
                        webappUrl: webappUrl,
                        spreadsheetId: spreadsheetId
                    });
                } else {
                    throw new Error(result?.message || 'ì—°ê²° ì‹¤íŒ¨');
                }
                
            } catch (error) {
                console.error('ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                statusDiv.innerHTML = `âŒ <strong>ì—°ê²° ì‹¤íŒ¨:</strong> ${error.message}`;
                statusDiv.className = 'alert alert-warning';
                handleError(error, 'ì—°ê²° í…ŒìŠ¤íŠ¸');
            }
        }

        function openGoogleSheets() {
            const config = loadFromStorage('google_sheets_config');
            const spreadsheetId = config?.spreadsheetId || document.getElementById('spreadsheet-id').value.trim();
            
            if (spreadsheetId) {
                const sheetsUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`;
                window.open(sheetsUrl, '_blank');
            } else {
                showNotification('âš ï¸ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'warning');
            }
        }

        // ============================================
        // ì•Œë¦¼ ì‹œìŠ¤í…œ
        // ============================================

        function showNotification(message, type = 'info') {
            // ê¸°ì¡´ ì•Œë¦¼ ì œê±°
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            const colors = {
                success: { bg: '#d4edda', border: '#28a745', text: '#155724' },
                warning: { bg: '#fff3cd', border: '#ffc107', text: '#856404' },
                error: { bg: '#f8d7da', border: '#dc3545', text: '#721c24' },
                info: { bg: '#d1ecf1', border: '#17a2b8', text: '#0c5460' }
            };
            
            const color = colors[type] || colors.info;
            notification.style.backgroundColor = color.bg;
            notification.style.borderColor = color.border;
            notification.style.color = color.text;
            
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; font-size: 20px; cursor: pointer; color: ${color.text}; margin-left: 15px;">Ã—</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // ============================================
        // ê¸°ë³¸ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤ (ì•ˆì „ì„± ê°•í™”)
        // ============================================

        function saveToStorage(key, data) {
            try {
                const dataString = JSON.stringify(data);
                if (dataString.length > 5000000) { // 5MB ì²´í¬
                    console.warn('âš ï¸ ì €ì¥í•  ë°ì´í„°ê°€ í½ë‹ˆë‹¤:', dataString.length, 'bytes');
                    // í° ë°ì´í„° ì••ì¶• ë˜ëŠ” ë¶„í•  ì €ì¥ ë¡œì§ ì¶”ê°€ ê°€ëŠ¥
                }
                localStorage.setItem(key, dataString);
                return true;
            } catch (error) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                if (error.name === 'QuotaExceededError') {
                    showNotification('âš ï¸ ì €ì¥ ê³µê°„ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ë°ì´í„°ë¥¼ ì •ë¦¬í•´ì£¼ì„¸ìš”.', 'warning');
                }
                handleError(error, 'ë¡œì»¬ ì €ì¥');
                return false;
            }
        }

        function loadFromStorage(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.error('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                handleError(error, 'ë¡œì»¬ ë¡œë“œ');
                return defaultValue;
            }
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function getKoreanDateTime() {
            try {
                const now = new Date();
                const koreanTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
                return koreanTime.toISOString().replace('T', ' ').replace(/\..+/, '');
            } catch (error) {
                handleError(error, 'ì‹œê°„ ìƒì„±');
                return new Date().toISOString();
            }
        }

        function showPage(pageId) {
            try {
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                } else {
                    throw new Error(`í˜ì´ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${pageId}`);
                }
            } catch (error) {
                handleError(error, 'í˜ì´ì§€ ì „í™˜');
            }
        }

        function showModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('show');
                } else {
                    throw new Error(`ëª¨ë‹¬ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ${modalId}`);
                }
            } catch (error) {
                handleError(error, 'ëª¨ë‹¬ ì—´ê¸°');
            }
        }

        function closeModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('show');
                }
            } catch (error) {
                handleError(error, 'ëª¨ë‹¬ ë‹«ê¸°');
            }
        }

        // ============================================
        // í˜ì´ì§€ ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ë“¤
        // ============================================

        function showWelcomePage() {
            showPage('welcome-page');
        }

        function showParticipantLogin() {
            showPage('participant-login-page');
        }

        function showAdminLogin() {
            showPage('admin-login-page');
        }

        function openParticipantURL() {
            const baseURL = window.location.origin + window.location.pathname;
            const participantURL = `${baseURL}?mode=participant`;
            window.open(participantURL, '_blank');
        }

        function returnToLogin() {
            if (confirm('ì§„í–‰ ì¤‘ì¸ ì¹´ë“œì†ŒíŒ…ì´ ìˆìŠµë‹ˆë‹¤. ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ëŒì•„ê°€ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì§„í–‰ ìƒí™©ì€ ìë™ìœ¼ë¡œ ì €ì¥ë©ë‹ˆë‹¤.)')) {
                if (appState.sortingData) {
                    autoSave();
                }
                showParticipantLogin();
            }
        }

        function adminLogin(event) {
            event.preventDefault();
            try {
                const password = document.getElementById('admin-password').value;
                if (password === 'LHLH') {
                    appState.currentUser = { role: 'admin' };
                    showPage('admin-dashboard-page');
                    loadAdminData();
                    updateResponseStats();
                } else {
                    showNotification('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
                }
            } catch (error) {
                handleError(error, 'ê´€ë¦¬ì ë¡œê·¸ì¸');
            }
        }

        function adminLogout() {
            appState.currentUser = null;
            window.location.href = window.location.pathname + '?mode=admin';
        }

        function loadAdminData() {
            try {
                const project = loadFromStorage('current_project', DEFAULT_PROJECT);
                document.getElementById('project-title').value = project.title;
                document.getElementById('sorting-type').value = project.sortingType;
                document.getElementById('predefined-groups').value = project.predefinedGroups.join('\n');
                document.getElementById('card-list').value = project.cards.join('\n');
                document.getElementById('shuffle-cards').checked = project.shuffleCards || false;
                document.getElementById('allow-edit-groups').checked = project.allowEditGroups || false;
                updateCardCount();
                updateSortingTypeVisibility();
                
                // Google Sheets ì„¤ì • ë¡œë“œ
                const config = loadFromStorage('google_sheets_config');
                if (config) {
                    document.getElementById('webapp-url').value = config.webappUrl || '';
                    document.getElementById('spreadsheet-id').value = config.spreadsheetId || '';
                    GOOGLE_APPS_SCRIPT_URL = config.webappUrl || '';
                    SPREADSHEET_ID = config.spreadsheetId || '';
                }
            } catch (error) {
                handleError(error, 'ê´€ë¦¬ì ë°ì´í„° ë¡œë“œ');
            }
        }

        function addNewCard() {
            try {
                const newCard = document.getElementById('new-card').value.trim();
                if (!newCard) return;
                
                const cardList = document.getElementById('card-list');
                const currentCards = cardList.value.trim().split('\n').filter(card => card.trim());
                
                if (currentCards.length >= 50) {
                    showNotification('âš ï¸ ì¹´ë“œëŠ” ìµœëŒ€ 50ê°œê¹Œì§€ ì¶”ê°€í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }
                
                if (currentCards.includes(newCard)) {
                    showNotification('âš ï¸ ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì¹´ë“œì…ë‹ˆë‹¤.', 'warning');
                    return;
                }
                
                currentCards.push(newCard);
                cardList.value = currentCards.join('\n');
                document.getElementById('new-card').value = '';
                updateCardCount();
                
                showNotification('âœ… ì¹´ë“œê°€ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            } catch (error) {
                handleError(error, 'ì¹´ë“œ ì¶”ê°€');
            }
        }

        function updateCardCount() {
            try {
                const cards = document.getElementById('card-list').value.trim().split('\n').filter(card => card.trim());
                const count = cards.length;
                document.getElementById('card-count').textContent = count;
                
                const warningDiv = document.getElementById('card-warning');
                if (count > 30) {
                    warningDiv.classList.remove('hidden');
                } else {
                    warningDiv.classList.add('hidden');
                }
            } catch (error) {
                handleError(error, 'ì¹´ë“œ ìˆ˜ ì—…ë°ì´íŠ¸');
            }
        }

        function updateSortingTypeVisibility() {
            try {
                const sortingType = document.getElementById('sorting-type').value;
                const groupsSection = document.getElementById('predefined-groups-section');
                if (sortingType === 'open') {
                    groupsSection.style.display = 'none';
                } else {
                    groupsSection.style.display = 'block';
                }
            } catch (error) {
                handleError(error, 'ì†ŒíŒ… íƒ€ì… ì—…ë°ì´íŠ¸');
            }
        }

        function generateURL() {
            try {
                // Google Sheets ì„¤ì • ì €ì¥
                const webappUrl = document.getElementById('webapp-url').value.trim();
                const spreadsheetId = document.getElementById('spreadsheet-id').value.trim();
                
                if (webappUrl && spreadsheetId) {
                    GOOGLE_APPS_SCRIPT_URL = webappUrl;
                    SPREADSHEET_ID = spreadsheetId;
                    
                    saveToStorage('google_sheets_config', {
                        webappUrl: webappUrl,
                        spreadsheetId: spreadsheetId
                    });
                }

                const project = {
                    id: generateId(),
                    title: document.getElementById('project-title').value.trim(),
                    sortingType: document.getElementById('sorting-type').value,
                    predefinedGroups: document.getElementById('predefined-groups').value.trim().split('\n').filter(g => g.trim()),
                    cards: document.getElementById('card-list').value.trim().split('\n').filter(c => c.trim()),
                    shuffleCards: document.getElementById('shuffle-cards').checked,
                    allowEditGroups: document.getElementById('allow-edit-groups').checked,
                    createdAt: new Date().toISOString()
                };

                // ë°ì´í„° ê²€ì¦
                if (!project.title || project.cards.length === 0) {
                    showNotification('í”„ë¡œì íŠ¸ ì œëª©ê³¼ ì¹´ë“œ ëª©ë¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }

                if (project.cards.length > 50) {
                    showNotification('ì¹´ë“œëŠ” ìµœëŒ€ 50ê°œê¹Œì§€ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }

                if (project.predefinedGroups.length > 10) {
                    showNotification('ê¸°ë³¸ ê·¸ë£¹ì€ ìµœëŒ€ 10ê°œê¹Œì§€ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }

                saveToStorage('current_project', project);
                appState.currentProject = project;

                const baseURL = window.location.origin + window.location.pathname;
                const projectURL = `${baseURL}?mode=participant`;
                
                document.getElementById('generated-url').value = projectURL;
                document.getElementById('generated-url-section').classList.remove('hidden');

                showNotification('í”„ë¡œì íŠ¸ê°€ ì €ì¥ë˜ê³  URLì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                handleError(error, 'URL ìƒì„±');
            }
        }

        function copyURL() {
            try {
                const urlInput = document.getElementById('generated-url');
                urlInput.select();
                document.execCommand('copy');
                showNotification('URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                handleError(error, 'URL ë³µì‚¬');
            }
        }

        function updateResponseStats() {
            try {
                const responses = getAllResponses();
                const completed = responses.filter(r => r.isCompleted);
                const ongoing = responses.filter(r => !r.isCompleted);
                
                const avgDuration = completed.length > 0 
                    ? Math.round(completed.reduce((sum, r) => sum + (r.duration || 0), 0) / completed.length / 60)
                    : 0;

                document.getElementById('total-responses').textContent = responses.length;
                document.getElementById('completed-responses').textContent = completed.length;
                document.getElementById('ongoing-responses').textContent = ongoing.length;
                document.getElementById('avg-duration').textContent = avgDuration + 'ë¶„';
            } catch (error) {
                handleError(error, 'ì‘ë‹µ í†µê³„ ì—…ë°ì´íŠ¸');
            }
        }

        function getAllResponses() {
            try {
                const responses = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('participant_')) {
                        const data = loadFromStorage(key);
                        if (data) responses.push(data);
                    }
                }
                return responses;
            } catch (error) {
                handleError(error, 'ì „ì²´ ì‘ë‹µ ì¡°íšŒ');
                return [];
            }
        }

        function downloadAllResponses() {
            try {
                const responses = getAllResponses();
                if (responses.length === 0) {
                    showNotification('ë‹¤ìš´ë¡œë“œí•  ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                    return;
                }

                const project = loadFromStorage('current_project', DEFAULT_PROJECT);
                const exportData = {
                    projectInfo: project,
                    exportDate: new Date().toISOString(),
                    totalResponses: responses.length,
                    responses: responses.map(r => formatResponseForExport(r, project))
                };

                downloadJSON(exportData, `ì¹´ë“œì†ŒíŒ…_ì „ì²´ì‘ë‹µ_${project.title}_${new Date().toISOString().split('T')[0]}.json`);
            } catch (error) {
                handleError(error, 'ì‘ë‹µ ë‹¤ìš´ë¡œë“œ');
            }
        }

        function clearAllData() {
            try {
                if (confirm('ëª¨ë“  ì‘ë‹µ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                    for (let i = localStorage.length - 1; i >= 0; i--) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('participant_')) {
                            localStorage.removeItem(key);
                        }
                    }
                    updateResponseStats();
                    showNotification('ëª¨ë“  ì‘ë‹µ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
                }
            } catch (error) {
                handleError(error, 'ë°ì´í„° ì‚­ì œ');
            }
        }

        // ============================================
        // ì°¸ì—¬ì ê´€ë ¨ í•¨ìˆ˜ë“¤ (ì•ˆì „ì„± ê°•í™”)
        // ============================================

        function participantLogin(event) {
            event.preventDefault();
            
            try {
                const config = loadFromStorage('google_sheets_config');
                if (config) {
                    GOOGLE_APPS_SCRIPT_URL = config.webappUrl || '';
                    SPREADSHEET_ID = config.spreadsheetId || '';
                }

                const name = document.getElementById('participant-name').value.trim();
                const phone = document.getElementById('participant-phone').value.trim();

                if (!name || !phone) {
                    showNotification('ì´ë¦„ê³¼ íœ´ëŒ€í° ë’·ë²ˆí˜¸ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }

                if (!/^[ê°€-í£]+$/.test(name)) {
                    showNotification('ì´ë¦„ì€ í•œê¸€ë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }

                if (!/^[0-9]{4}$/.test(phone)) {
                    showNotification('íœ´ëŒ€í° ë’·ë²ˆí˜¸ëŠ” ìˆ«ì 4ìë¦¬ë§Œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }

                const participantId = `${name}_${phone}`;
                const existingData = loadFromStorage(`participant_${participantId}`);
                
                if (existingData && !existingData.isCompleted) {
                    appState.currentParticipant = { name, phone, id: participantId };
                    document.getElementById('existing-response-notice').classList.remove('hidden');
                    return;
                }

                startNewSorting(name, phone, participantId);
            } catch (error) {
                handleError(error, 'ì°¸ì—¬ì ë¡œê·¸ì¸');
            }
        }

        function continueExisting() {
            try {
                const { name, phone, id } = appState.currentParticipant;
                const existingData = loadFromStorage(`participant_${id}`);
                appState.sortingData = existingData;
                appState.startTime = new Date(existingData.startTime);
                startSortingPage();
            } catch (error) {
                handleError(error, 'ê¸°ì¡´ ì‘ë‹µ ê³„ì†í•˜ê¸°');
            }
        }

        function startNew() {
            try {
                const { name, phone, id } = appState.currentParticipant;
                startNewSorting(name, phone, id);
            } catch (error) {
                handleError(error, 'ìƒˆ ì‘ë‹µ ì‹œì‘');
            }
        }

        function startNewSorting(name, phone, participantId) {
            try {
                const project = loadFromStorage('current_project', DEFAULT_PROJECT);
                appState.currentParticipant = { name, phone, id: participantId };
                appState.currentProject = project;
                appState.startTime = new Date();
                
                let cards = [...project.cards];
                if (project.shuffleCards) {
                    cards = shuffleArray(cards);
                }
                
                appState.sortingData = {
                    participantId,
                    name,
                    phone,
                    startTime: getKoreanDateTime(),
                    lastSaveTime: appState.startTime.toISOString(),
                    completedTime: null,
                    duration: 0,
                    isCompleted: false,
                    sortingType: project.sortingType,
                    groups: initializeGroups(project),
                    unassignedCards: cards.map((card, index) => ({
                        id: `card-${index}`,
                        content: card,
                        originalIndex: index
                    })),
                    modifiedGroupNames: []
                };

                startSortingPage();
            } catch (error) {
                handleError(error, 'ìƒˆ ì†ŒíŒ… ì‹œì‘');
            }
        }

        function shuffleArray(array) {
            try {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            } catch (error) {
                handleError(error, 'ë°°ì—´ ì„ê¸°');
                return array;
            }
        }

        function initializeGroups(project) {
            try {
                const groups = {};
                if (project.sortingType !== 'open') {
                    project.predefinedGroups.forEach((groupName, index) => {
                        groups[`group-${index}`] = {
                            id: `group-${index}`,
                            name: groupName,
                            originalName: groupName,
                            isCustom: false,
                            cards: [],
                            order: index
                        };
                    });
                }
                return groups;
            } catch (error) {
                handleError(error, 'ê·¸ë£¹ ì´ˆê¸°í™”');
                return {};
            }
        }

        function startSortingPage() {
            try {
                showPage('sorting-page');
                const { name } = appState.currentParticipant;
                const { sortingType } = appState.currentProject;
                
                document.getElementById('sorting-participant-name').textContent = 'ë¡¯ë°í™ˆì‡¼í•‘ ì˜¨ë¼ì¸ ë¦¬ì„œì¹˜';
                document.getElementById('sorting-type-info').textContent = 'í˜œíƒ ì¹´ë“œ ë¶„ë¥˜í•˜ê¸°';
                
                const createGroupBtn = document.getElementById('create-group-btn');
                if (sortingType === 'closed') {
                    createGroupBtn.style.display = 'none';
                } else {
                    createGroupBtn.style.display = 'block';
                }
                
                renderSortingUI();
                updateProgress();
                
                // ì•ˆë‚´ì„œë¥¼ ìë™ìœ¼ë¡œ í‘œì‹œ
                showSortingGuide();
            } catch (error) {
                handleError(error, 'ì†ŒíŒ… í˜ì´ì§€ ì‹œì‘');
            }
        }

        function renderSortingUI() {
            try {
                renderCardPool();
                renderGroups();
            } catch (error) {
                handleError(error, 'UI ë Œë”ë§');
            }
        }

        function renderCardPool() {
            try {
                const cardPool = document.getElementById('card-pool');
                const cardPoolContainer = cardPool.parentElement;
                const { unassignedCards } = appState.sortingData;
                cardPool.innerHTML = '';
                
                if (!cardPoolContainer.hasAttribute('data-drop-enabled')) {
                    cardPoolContainer.addEventListener('dragover', handleDragOver);
                    cardPoolContainer.addEventListener('drop', handleDropToPool);
                    cardPoolContainer.addEventListener('dragenter', handleDragEnterPool);
                    cardPoolContainer.addEventListener('dragleave', handleDragLeavePool);
                    cardPoolContainer.setAttribute('data-drop-enabled', 'true');
                }
                
                unassignedCards.forEach(card => {
                    const cardElement = createCardElement(card);
                    cardPool.appendChild(cardElement);
                });
                
                document.getElementById('unassigned-count').textContent = unassignedCards.length;
            } catch (error) {
                handleError(error, 'ì¹´ë“œ í’€ ë Œë”ë§');
            }
        }

        function createCardElement(card) {
            try {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card-item';
                cardDiv.textContent = card.content;
                cardDiv.draggable = true;
                cardDiv.dataset.cardId = card.id;
                
                cardDiv.addEventListener('dragstart', handleDragStart);
                cardDiv.addEventListener('dragend', handleDragEnd);
                
                return cardDiv;
            } catch (error) {
                handleError(error, 'ì¹´ë“œ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±');
                return document.createElement('div');
            }
        }

        function renderGroups() {
            try {
                const container = document.getElementById('groups-container');
                const { groups } = appState.sortingData;
                container.innerHTML = '';
                
                const sortedGroups = Object.values(groups).sort((a, b) => (a.order || 0) - (b.order || 0));
                
                sortedGroups.forEach((group, index) => {
                    const groupElement = createGroupElement(group, index + 1);
                    container.appendChild(groupElement);
                });
                
                if (!container.hasAttribute('data-group-sort-enabled')) {
                    container.addEventListener('dragover', handleGroupDragOver);
                    container.addEventListener('drop', handleGroupDrop);
                    container.setAttribute('data-group-sort-enabled', 'true');
                }
            } catch (error) {
                handleError(error, 'ê·¸ë£¹ ë Œë”ë§');
            }
        }

        function createGroupElement(group, rank) {
            try {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'group-container';
                groupDiv.dataset.groupId = group.id;
                groupDiv.draggable = true;
                
                groupDiv.addEventListener('dragover', handleDragOver);
                groupDiv.addEventListener('drop', handleDrop);
                groupDiv.addEventListener('dragenter', handleDragEnter);
                groupDiv.addEventListener('dragleave', handleDragLeave);
                groupDiv.addEventListener('dragstart', handleGroupDragStart);
                groupDiv.addEventListener('dragend', handleGroupDragEnd);
                
                const dragHandle = document.createElement('div');
                dragHandle.className = 'group-drag-handle';
                dragHandle.innerHTML = 'â‹®â‹®';
                dragHandle.title = 'ê·¸ë£¹ ìˆœì„œ ë³€ê²½ (ë“œë˜ê·¸)';
                groupDiv.appendChild(dragHandle);
                
                const metaInfo = document.createElement('div');
                metaInfo.className = 'group-meta-info';
                
                const rankDiv = document.createElement('div');
                rankDiv.className = 'group-rank';
                rankDiv.textContent = `ê·¸ë£¹${rank}`;
                metaInfo.appendChild(rankDiv);
                
                const cardCountDiv = document.createElement('div');
                cardCountDiv.className = 'group-card-count';
                cardCountDiv.textContent = `ì¹´ë“œ ìˆ˜: ${group.cards.length}ê°œ`;
                metaInfo.appendChild(cardCountDiv);
                
                groupDiv.appendChild(metaInfo);
                
                const header = document.createElement('div');
                header.className = 'group-header';
                
                const title = document.createElement('div');
                title.className = 'group-title editable';
                title.textContent = group.name;
                
                const allowEdit = appState.currentProject.allowEditGroups;
                if (allowEdit || group.isCustom) {
                    title.addEventListener('click', () => editGroupName(group.id));
                }
                
                const actions = document.createElement('div');
                actions.className = 'group-actions';
                
                if (group.isCustom) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-group-btn';
                    deleteBtn.textContent = 'Ã—';
                    deleteBtn.onclick = () => deleteGroup(group.id);
                    actions.appendChild(deleteBtn);
                }
                
                header.appendChild(title);
                header.appendChild(actions);
                
                const content = document.createElement('div');
                content.className = 'group-content';
                
                if (group.cards.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'empty-group';
                    empty.textContent = 'ì¹´ë“œë¥¼ ì—¬ê¸°ì— ì˜®ê²¨ì£¼ì„¸ìš”';
                    content.appendChild(empty);
                } else {
                    group.cards.forEach(card => {
                        const cardElement = createCardElement(card);
                        content.appendChild(cardElement);
                    });
                }
                
                groupDiv.appendChild(header);
                groupDiv.appendChild(content);
                
                return groupDiv;
            } catch (error) {
                handleError(error, 'ê·¸ë£¹ ì—˜ë¦¬ë¨¼íŠ¸ ìƒì„±');
                return document.createElement('div');
            }
        }

        // ============================================
        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¨ìˆ˜ë“¤ (ì˜¤ë¥˜ ì²˜ë¦¬ ê°•í™”)
        // ============================================

        function handleGroupDragStart(event) {
            try {
                if (!event.target.classList.contains('group-container')) return;
                
                const groupId = event.target.dataset.groupId;
                event.dataTransfer.setData('text/group-id', groupId);
                event.target.classList.add('dragging-group');
                event.dataTransfer.setData('text/drag-type', 'group');
            } catch (error) {
                handleError(error, 'ê·¸ë£¹ ë“œë˜ê·¸ ì‹œì‘');
            }
        }

        function handleGroupDragEnd(event) {
            try {
                event.target.classList.remove('dragging-group');
                document.querySelectorAll('.group-container').forEach(group => {
                    group.classList.remove('drag-over');
                });
            } catch (error) {
                handleError(error, 'ê·¸ë£¹ ë“œë˜ê·¸ ë');
            }
        }

        function handleGroupDragOver(event) {
            try {
                event.preventDefault();
                const dragType = event.dataTransfer.types.includes('text/drag-type');
                if (!dragType) return;
                
                const targetGroup = event.target.closest('.group-container');
                if (targetGroup && !targetGroup.classList.contains('dragging-group')) {
                    targetGroup.classList.add('drag-over');
                }
            } catch (error) {
                handleError(error, 'ê·¸ë£¹ ë“œë˜ê·¸ ì˜¤ë²„');
            }
        }

        function handleGroupDrop(event) {
            try {
                event.preventDefault();
                const dragType = event.dataTransfer.getData('text/drag-type');
                
                if (dragType === 'group') {
                    const draggedGroupId = event.dataTransfer.getData('text/group-id');
                    const targetGroup = event.target.closest('.group-container');
                    
                    if (targetGroup && targetGroup.dataset.groupId !== draggedGroupId) {
                        const targetGroupId = targetGroup.dataset.groupId;
                        reorderGroups(draggedGroupId, targetGroupId);
                    }
                    
                    targetGroup.classList.remove('drag-over');
                } else {
                    const cardId = event.dataTransfer.getData('text/plain');
                    const targetGroup = event.target.closest('.group-container');
                    const targetGroupId = targetGroup.dataset.groupId;
                    moveCardToGroup(cardId, targetGroupId);
                    targetGroup.classList.remove('drag-over');
                }
            } catch (error) {
                handleError(error, 'ê·¸ë£¹ ë“œë¡­');
            }
        }

        function reorderGroups(draggedGroupId, targetGroupId) {
            try {
                const { groups } = appState.sortingData;
                const draggedGroup = groups[draggedGroupId];
                const targetGroup = groups[targetGroupId];
                
                if (!draggedGroup || !targetGroup) return;
                
                const draggedOrder = draggedGroup.order || 0;
                const targetOrder = targetGroup.order || 0;
                
                draggedGroup.order = targetOrder;
                targetGroup.order = draggedOrder;
                
                renderGroups();
                autoSave();
                
                showNotification('âœ… ê·¸ë£¹ ìˆœì„œê°€ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                handleError(error, 'ê·¸ë£¹ ìˆœì„œ ë³€ê²½');
            }
        }

        function handleDragStart(event) {
            try {
                if (!event.target.classList.contains('card-item')) return;
                
                const cardId = event.target.dataset.cardId;
                event.dataTransfer.setData('text/plain', cardId);
                event.dataTransfer.setData('text/drag-type', 'card');
                event.target.classList.add('dragging');
            } catch (error) {
                handleError(error, 'ì¹´ë“œ ë“œë˜ê·¸ ì‹œì‘');
            }
        }

        function handleDragEnd(event) {
            try {
                event.target.classList.remove('dragging');
                document.querySelectorAll('.group-container').forEach(group => {
                    group.classList.remove('drag-over');
                });
                document.querySelectorAll('.card-pool').forEach(pool => {
                    pool.classList.remove('drag-over');
                });
            } catch (error) {
                handleError(error, 'ì¹´ë“œ ë“œë˜ê·¸ ë');
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
        }

        function handleDragEnter(event) {
            try {
                const targetGroup = event.target.closest('.group-container');
                if (targetGroup) {
                    targetGroup.classList.add('drag-over');
                }
            } catch (error) {
                handleError(error, 'ë“œë˜ê·¸ ì—”í„°');
            }
        }

        function handleDragLeave(event) {
            try {
                const targetGroup = event.target.closest('.group-container');
                if (targetGroup && !targetGroup.contains(event.relatedTarget)) {
                    targetGroup.classList.remove('drag-over');
                }
            } catch (error) {
                handleError(error, 'ë“œë˜ê·¸ ë¦¬ë¸Œ');
            }
        }

        function handleDrop(event) {
            try {
                event.preventDefault();
                
                const dragType = event.dataTransfer.getData('text/drag-type');
                
                if (dragType === 'card') {
                    const cardId = event.dataTransfer.getData('text/plain');
                    const targetGroup = event.target.closest('.group-container');
                    const targetGroupId = targetGroup.dataset.groupId;
                    moveCardToGroup(cardId, targetGroupId);
                    targetGroup.classList.remove('drag-over');
                }
            } catch (error) {
                handleError(error, 'ì¹´ë“œ ë“œë¡­');
            }
        }

        function handleDragEnterPool(event) {
            try {
                event.target.closest('.card-pool').classList.add('drag-over');
            } catch (error) {
                handleError(error, 'í’€ ë“œë˜ê·¸ ì—”í„°');
            }
        }

        function handleDragLeavePool(event) {
            try {
                if (!event.target.closest('.card-pool').contains(event.relatedTarget)) {
                    event.target.closest('.card-pool').classList.remove('drag-over');
                }
            } catch (error) {
                handleError(error, 'í’€ ë“œë˜ê·¸ ë¦¬ë¸Œ');
            }
        }

        function handleDropToPool(event) {
            try {
                event.preventDefault();
                const cardId = event.dataTransfer.getData('text/plain');
                const cardPool = event.target.closest('.card-pool');
                moveCardToPool(cardId);
                cardPool.classList.remove('drag-over');
            } catch (error) {
                handleError(error, 'í’€ë¡œ ë“œë¡­');
            }
        }

        function moveCardToPool(cardId) {
            try {
                const { groups, unassignedCards } = appState.sortingData;
                let card = null;
                
                const alreadyUnassigned = unassignedCards.find(c => c.id === cardId);
                if (alreadyUnassigned) return;
                
                for (const group of Object.values(groups)) {
                    const cardIndex = group.cards.findIndex(c => c.id === cardId);
                    if (cardIndex !== -1) {
                        card = group.cards.splice(cardIndex, 1)[0];
                        break;
                    }
                }
                
                if (card) {
                    unassignedCards.push(card);
                    renderSortingUI();
                    updateProgress();
                    autoSave();
                }
            } catch (error) {
                handleError(error, 'ì¹´ë“œë¥¼ í’€ë¡œ ì´ë™');
            }
        }

        function moveCardToGroup(cardId, targetGroupId) {
            try {
                const { groups, unassignedCards } = appState.sortingData;
                let card = null;
                
                const unassignedIndex = unassignedCards.findIndex(c => c.id === cardId);
                if (unassignedIndex !== -1) {
                    card = unassignedCards.splice(unassignedIndex, 1)[0];
                } else {
                    for (const group of Object.values(groups)) {
                        const cardIndex = group.cards.findIndex(c => c.id === cardId);
                        if (cardIndex !== -1) {
                            card = group.cards.splice(cardIndex, 1)[0];
                            break;
                        }
                    }
                }
                
                if (card && groups[targetGroupId]) {
                    groups[targetGroupId].cards.push(card);
                    renderSortingUI();
                    updateProgress();
                    autoSave();
                }
            } catch (error) {
                handleError(error, 'ì¹´ë“œë¥¼ ê·¸ë£¹ìœ¼ë¡œ ì´ë™');
            }
        }

        function createNewGroup() {
            try {
                showModal('create-group-modal');
                document.getElementById('new-group-name').focus();
            } catch (error) {
                handleError(error, 'ìƒˆ ê·¸ë£¹ ìƒì„± ëª¨ë‹¬');
            }
        }

        function showSortingGuide() {
            try {
                showModal('sorting-guide-modal');
            } catch (error) {
                handleError(error, 'ì†ŒíŒ… ê°€ì´ë“œ í‘œì‹œ');
            }
        }

        function confirmCreateGroup() {
            try {
                const groupName = document.getElementById('new-group-name').value.trim();
                
                if (!groupName) {
                    showNotification('ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }
                
                if (groupName.length > 20) {
                    showNotification('ê·¸ë£¹ ì´ë¦„ì€ 20ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                    return;
                }
                
                const existingNames = Object.values(appState.sortingData.groups).map(g => g.name);
                if (existingNames.includes(groupName)) {
                    showNotification('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê·¸ë£¹ ì´ë¦„ì…ë‹ˆë‹¤.', 'warning');
                    return;
                }
                
                const maxOrder = Object.values(appState.sortingData.groups).reduce((max, group) => {
                    return Math.max(max, group.order || 0);
                }, -1);
                
                const newGroupId = `custom-${generateId()}`;
                appState.sortingData.groups[newGroupId] = {
                    id: newGroupId,
                    name: groupName,
                    originalName: groupName,
                    isCustom: true,
                    cards: [],
                    order: maxOrder + 1
                };
                
                renderGroups();
                closeModal('create-group-modal');
                document.getElementById('new-group-name').value = '';
                autoSave();
                
                showNotification('âœ… ìƒˆ ê·¸ë£¹ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                handleError(error, 'ê·¸ë£¹ ìƒì„± í™•ì¸');
            }
        }

        function editGroupName(groupId) {
            try {
                const group = appState.sortingData.groups[groupId];
                if (!group) return;
                
                const allowEdit = appState.currentProject.allowEditGroups;
                if (!allowEdit && !group.isCustom) return;
                
                const newName = prompt('ìƒˆ ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', group.name);
                if (newName && newName.trim() && newName.trim() !== group.name) {
                    if (newName.trim().length > 20) {
                        showNotification('ê·¸ë£¹ ì´ë¦„ì€ 20ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                        return;
                    }
                    
                    const existingNames = Object.values(appState.sortingData.groups)
                        .filter(g => g.id !== groupId)
                        .map(g => g.name);
                    
                    if (existingNames.includes(newName.trim())) {
                        showNotification('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê·¸ë£¹ ì´ë¦„ì…ë‹ˆë‹¤.', 'warning');
                        return;
                    }
                    
                    if (!group.isCustom && group.originalName !== newName.trim()) {
                        if (!appState.sortingData.modifiedGroupNames.includes(group.originalName)) {
                            appState.sortingData.modifiedGroupNames.push(group.originalName);
                        }
                    }
                    
                    group.name = newName.trim();
                    renderGroups();
                    autoSave();
                    
                    showNotification('âœ… ê·¸ë£¹ ì´ë¦„ì´ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                }
            } catch (error) {
                handleError(error, 'ê·¸ë£¹ ì´ë¦„ í¸ì§‘');
            }
        }

        function deleteGroup(groupId) {
            try {
                const group = appState.sortingData.groups[groupId];
                if (!group || !group.isCustom) return;
                
                if (confirm(`'${group.name}' ê·¸ë£¹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í¬í•¨ëœ ì¹´ë“œë“¤ì€ ë¯¸ë¶„ë¥˜ë¡œ ì´ë™í•©ë‹ˆë‹¤.`)) {
                    appState.sortingData.unassignedCards.push(...group.cards);
                    delete appState.sortingData.groups[groupId];
                    renderSortingUI();
                    updateProgress();
                    autoSave();
                    
                    showNotification('âœ… ê·¸ë£¹ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                }
            } catch (error) {
                handleError(error, 'ê·¸ë£¹ ì‚­ì œ');
            }
        }

        function updateProgress() {
            try {
                if (!appState.sortingData) return;
                
                const totalCards = appState.currentProject.cards.length;
                const assignedCards = totalCards - appState.sortingData.unassignedCards.length;
                const progress = Math.round((assignedCards / totalCards) * 100);
                
                const progressFill = document.getElementById('progress-fill');
                const progressText = document.getElementById('progress-text');
                
                if (progressFill) {
                    progressFill.style.width = `${progress}%`;
                }
                
                if (progressText) {
                    progressText.textContent = 
                        `${totalCards}ê°œ ì¤‘ ${assignedCards}ê°œ ì¹´ë“œ ë¶„ë¥˜ ì™„ë£Œ (${progress}%)`;
                }
                
                const submitBtn = document.getElementById('submit-btn');
                if (submitBtn) {
                    if (assignedCards === totalCards) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = 'âœ… ì‘ë‹µ ì œì¶œí•˜ê¸°';
                        submitBtn.style.opacity = '1';
                    } else {
                        submitBtn.disabled = false;
                        submitBtn.textContent = `âœ… ì‘ë‹µ ì œì¶œí•˜ê¸° (${totalCards - assignedCards}ê°œ ë¯¸ë¶„ë¥˜)`;
                        submitBtn.style.opacity = '0.8';
                    }
                }
            } catch (error) {
                handleError(error, 'ì§„í–‰ë¥  ì—…ë°ì´íŠ¸');
            }
        }

        function autoSave() {
            try {
                if (!appState.sortingData) return;
                appState.sortingData.lastSaveTime = new Date().toISOString();
                const saved = saveToStorage(`participant_${appState.sortingData.participantId}`, appState.sortingData);
                
                if (!saved) {
                    showNotification('âš ï¸ ìë™ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ì €ì¥í•´ì£¼ì„¸ìš”.', 'warning');
                }
            } catch (error) {
                handleError(error, 'ìë™ ì €ì¥');
            }
        }

        function resetAllCards() {
            try {
                if (!confirm('ëª¨ë“  ì¹´ë“œë¥¼ ë¯¸ë¶„ë¥˜ ìƒíƒœë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
                
                const { groups } = appState.sortingData;
                Object.values(groups).forEach(group => {
                    appState.sortingData.unassignedCards.push(...group.cards);
                    group.cards = [];
                });
                
                renderSortingUI();
                updateProgress();
                autoSave();
                
                showNotification('âœ… ëª¨ë“  ì¹´ë“œê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                handleError(error, 'ì¹´ë“œ ë¦¬ì…‹');
            }
        }

        async function submitSorting() {
            try {
                if (!appState.sortingData) return;
                
                const unassignedCount = appState.sortingData.unassignedCards.length;
                
                if (unassignedCount > 0) {
                    if (!confirm(`ì•„ì§ ${unassignedCount}ê°œì˜ ì¹´ë“œê°€ ë¶„ë¥˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\nê·¸ë˜ë„ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                        return;
                    }
                }
                
                // ì™„ë£Œ ì²˜ë¦¬
                appState.sortingData.isCompleted = true;
                appState.sortingData.completedTime = getKoreanDateTime();
                appState.sortingData.duration = Math.floor((new Date() - appState.startTime) / 1000);
                
                // ë¡œì»¬ ì €ì¥
                autoSave();
                
                // Google Sheets ì €ì¥ ì‹œë„
                try {
                    await saveToGoogleSheets(appState.sortingData, appState.currentProject);
                } catch (error) {
                    console.warn('Google Sheets ì €ì¥ ì‹¤íŒ¨, ë¡œì»¬ ì €ì¥ì€ ì™„ë£Œë¨:', error);
                    showNotification('âš ï¸ í´ë¼ìš°ë“œ ì €ì¥ì— ì‹¤íŒ¨í–ˆì§€ë§Œ ë¡œì»¬ ì €ì¥ì€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');
                }
                
                // ì™„ë£Œ í˜ì´ì§€ë¡œ ì´ë™
                showCompletionPage();
                
            } catch (error) {
                handleError(error, 'ì‘ë‹µ ì œì¶œ');
            }
        }

        function showCompletionPage() {
            try {
                showPage('completion-page');
            } catch (error) {
                handleError(error, 'ì™„ë£Œ í˜ì´ì§€ í‘œì‹œ');
            }
        }

        // ============================================
        // ë°ì´í„° í¬ë§·íŒ… ë° ë‚´ë³´ë‚´ê¸° í•¨ìˆ˜ë“¤
        // ============================================

        function formatResponseForExport(responseData, projectConfig) {
            try {
                const groupResults = {};
                const cardDistribution = {};
                const groupOrder = [];
                
                const sortedGroups = Object.values(responseData.groups || {}).sort((a, b) => (a.order || 0) - (b.order || 0));
                
                sortedGroups.forEach(group => {
                    if (group.cards.length > 0) {
                        groupResults[group.name] = group.cards.map(card => card.content);
                        groupOrder.push(group.name);
                        group.cards.forEach(card => {
                            cardDistribution[card.content] = group.name;
                        });
                    }
                });
                
                if (responseData.unassignedCards && responseData.unassignedCards.length > 0) {
                    groupResults['ë¯¸ë¶„ë¥˜'] = responseData.unassignedCards.map(card => card.content);
                    responseData.unassignedCards.forEach(card => {
                        cardDistribution[card.content] = 'ë¯¸ë¶„ë¥˜';
                    });
                }
                
                const customGroupsCount = Object.values(responseData.groups || {}).filter(g => g.isCustom && g.cards.length > 0).length;
                const usedGroupsCount = Object.keys(groupResults).length;
                
                return {
                    ì´ë¦„: responseData.name || 'ì•Œ ìˆ˜ ì—†ìŒ',
                    íœ´ëŒ€í°ë’·ë²ˆí˜¸4ìë¦¬: responseData.phone || '',
                    ì‹œì‘ì‹œê°„: responseData.startTime,
                    ì™„ë£Œì‹œê°„: responseData.completedTime,
                    ì†Œìš”ì‹œê°„: Math.round((responseData.duration || 0) / 60) + 'ë¶„',
                    ì†ŒíŒ…ë°©ì‹: responseData.sortingType,
                    ì°¸ì—¬ìê°€ì¶”ê°€í•œê·¸ë£¹ìˆ˜: customGroupsCount,
                    ì°¸ì—¬ìê°€ë¶„ë¥˜í•œê·¸ë£¹ìˆ˜: usedGroupsCount,
                    ê·¸ë£¹ë³„ê²°ê³¼: groupResults,
                    ê·¸ë£¹ìˆœì„œ: groupOrder.join(' > ')
                };
            } catch (error) {
                handleError(error, 'ì‘ë‹µ ë°ì´í„° í¬ë§·íŒ…');
                return {};
            }
        }

        function downloadJSON(data, filename) {
            try {
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                
                showNotification('âœ… íŒŒì¼ì´ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
            } catch (error) {
                handleError(error, 'JSON ë‹¤ìš´ë¡œë“œ');
            }
        }

        // ============================================
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ì´ˆê¸°í™”
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
                const sortingTypeSelect = document.getElementById('sorting-type');
                if (sortingTypeSelect) {
                    sortingTypeSelect.addEventListener('change', updateSortingTypeVisibility);
                }
                
                const cardListTextarea = document.getElementById('card-list');
                if (cardListTextarea) {
                    cardListTextarea.addEventListener('input', updateCardCount);
                }
                
                const newCardInput = document.getElementById('new-card');
                if (newCardInput) {
                    newCardInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            addNewCard();
                        }
                    });
                }
                
                const newGroupInput = document.getElementById('new-group-name');
                if (newGroupInput) {
                    newGroupInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            confirmCreateGroup();
                        }
                    });
                }
                
                const phoneInput = document.getElementById('participant-phone');
                if (phoneInput) {
                    phoneInput.addEventListener('input', function(e) {
                        e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    });
                }
                
                const nameInput = document.getElementById('participant-name');
                if (nameInput) {
                    let nameInputTimer;
                    
                    nameInput.addEventListener('input', function(e) {
                        clearTimeout(nameInputTimer);
                        nameInputTimer = setTimeout(() => {
                            const value = e.target.value;
                            const filteredValue = value.replace(/[^ê°€-í£\s]/g, '');
                            if (value !== filteredValue) {
                                e.target.value = filteredValue;
                            }
                        }, 100);
                    });
                    
                    nameInput.addEventListener('compositionend', function(e) {
                        e.target.value = e.target.value.replace(/[^ê°€-í£\s]/g, '');
                    });
                }
                
                // ëª¨ë‹¬ í´ë¦­ ì´ë²¤íŠ¸
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', function(e) {
                        if (e.target === this) {
                            this.classList.remove('show');
                        }
                    });
                });
                
                // URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬
                function handleURLParams() {
                    try {
                        const urlParams = new URLSearchParams(window.location.search);
                        const mode = urlParams.get('mode');
                        
                        switch (mode) {
                            case 'admin':
                                showAdminLogin();
                                break;
                            case 'participant':
                                showWelcomePage();
                                break;
                            default:
                                showWelcomePage();
                                break;
                        }
                    } catch (error) {
                        handleError(error, 'URL íŒŒë¼ë¯¸í„° ì²˜ë¦¬');
                        showWelcomePage();
                    }
                }
                
                handleURLParams();
                
                // ë¸Œë¼ìš°ì € ì´ë²¤íŠ¸
                window.addEventListener('popstate', handleURLParams);
                
                window.addEventListener('beforeunload', function(e) {
                    if (appState.sortingData && !appState.sortingData.isCompleted) {
                        e.preventDefault();
                        e.returnValue = 'ì§„í–‰ ì¤‘ì¸ ì¹´ë“œì†ŒíŒ…ì´ ìˆìŠµë‹ˆë‹¤. ì •ë§ í˜ì´ì§€ë¥¼ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?';
                    }
                });
                
                // ì´ˆê¸° ì„¤ì •
                updateSortingTypeVisibility();
                updateCardCount();

                console.log('âœ… ë¡¯ë°í™ˆì‡¼í•‘ í˜œíƒ ë§¤ì¥ ì¹´ë“œ ë¶„ë¥˜í•˜ê¸° íˆ´ v4.3 (ìµœì í™” ë²„ì „)ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.');
                console.log('ğŸ¯ ìƒˆë¡œìš´ ê¸°ëŠ¥: ì˜¤ë¥˜ ì²˜ë¦¬ ê°•í™”, ì„±ëŠ¥ ìµœì í™”, ì•ˆì •ì„± ê°œì„ ');
                console.log('ğŸ”§ ë°ì´í„° í¬ê¸° ì œí•œ: ì¹´ë“œ 50ê°œ, ê·¸ë£¹ 10ê°œ ì´í•˜ ê¶Œì¥');
                console.log('âœ¨ ì™„ì„±ë„ í–¥ìƒ: ëª¨ë“  í•¨ìˆ˜ì— ì˜¤ë¥˜ ì²˜ë¦¬ ì¶”ê°€, ì‚¬ìš©ì ê²½í—˜ ê°œì„ ');

            } catch (error) {
                handleError(error, 'ì´ˆê¸°í™”');
                // ì´ˆê¸°í™” ì‹¤íŒ¨ ì‹œì—ë„ ê¸°ë³¸ í˜ì´ì§€ëŠ” í‘œì‹œ
                showWelcomePage();
            }
        });
    </script>
</body>
</html>
