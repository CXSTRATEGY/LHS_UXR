<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>롯데홈쇼핑 "혜택" 매장 카드 분류하기 (최적화 버전)</title>
    <style>
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
        }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', 'Apple SD Gothic Neo', Roboto, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            background-attachment: fixed;
            min-height: 100vh; 
            line-height: 1.6;
        }
        
        .container { 
            width: 100%;
            max-width: 1400px; 
            margin: 0 auto; 
            padding: 10px; 
            min-height: 100vh;
        }
        
        .card { 
            background: white; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            overflow: hidden;
        }
        
        .page { 
            display: none; 
            animation: fadeIn 0.3s ease-in;
        }
        
        .page.active { display: block; }
        
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(20px); } 
            to { opacity: 1; transform: translateY(0); } 
        }
        
        .header { 
            background: white; 
            padding: 20px 30px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
        }
        
        .logo { font-size: 24px; font-weight: bold; color: #333; }
        
        .nav-buttons { 
            display: flex; 
            gap: 10px; 
        }
        
        .form-group { margin: 20px 0; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-control { 
            width: 100%; 
            padding: 12px; 
            border: 2px solid #e1e5e9; 
            border-radius: 8px; 
            font-size: 16px; 
            transition: border-color 0.3s;
        }
        
        .form-control:focus { 
            outline: none; 
            border-color: #667eea; 
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .textarea { 
            min-height: 120px; 
            resize: vertical; 
            font-family: inherit; 
        }
        
        .btn { 
            padding: 12px 24px; 
            border: none; 
            border-radius: 8px; 
            font-size: 16px; 
            font-weight: 600; 
            cursor: pointer; 
            transition: all 0.3s; 
            text-decoration: none; 
            display: inline-block; 
            text-align: center;
        }
        
        .btn-primary { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
        }
        
        .btn-primary:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }
        
        .btn-secondary { 
            background: #e9ecef; 
            color: #495057; 
            border: 1px solid #ced4da; 
        }
        
        .btn-secondary:hover { background: #dee2e6; border-color: #ced4da; }
        
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        
        .login-container { 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            padding: 20px; 
        }
        
        .login-box { 
            background: white; 
            padding: 40px; 
            border-radius: 12px; 
            box-shadow: 0 10px 30px rgba(0,0,0,0.1); 
            width: 100%; 
            max-width: 400px;
        }
        
        .login-title { 
            text-align: center; 
            font-size: 20px; 
            font-weight: bold; 
            color: #333; 
            margin-bottom: 10px; 
            line-height: 1.3; 
        }
        
        .login-subtitle { text-align: center; color: #666; margin-bottom: 30px; }
        
        .admin-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 30px; 
            padding: 30px; 
        }
        
        .admin-section { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 12px; 
            border: 1px solid #e9ecef;
        }
        
        .admin-section h3 { color: #333; margin-bottom: 20px; font-size: 20px; }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr);
            gap: 15px; 
            margin: 20px 0; 
        }
        
        .stat-card { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            text-align: center; 
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .stat-number { font-size: 24px; font-weight: bold; color: #667eea; }
        .stat-label { font-size: 14px; color: #666; margin-top: 5px; }
        
        .sorting-header { 
            background: white; 
            padding: 20px 30px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap; 
            gap: 15px; 
        }
        
        .participant-info h2 { color: #333; font-size: 20px; }
        .participant-info p { color: #666; font-size: 14px; }
        
        .progress-section { 
            display: flex; 
            flex-direction: column; 
            align-items: flex-end; 
            min-width: 200px; 
        }
        
        .progress-container { width: 200px; }
        
        .progress-bar { 
            width: 100%; 
            height: 8px; 
            background: #e9ecef; 
            border-radius: 4px; 
            overflow: hidden;
        }
        
        .progress-fill { 
            height: 100%; 
            background: linear-gradient(90deg, #667eea, #764ba2); 
            transition: width 0.3s ease; 
        }
        
        .progress-text { text-align: center; font-size: 14px; color: #666; margin-top: 5px; }
        
        .sorting-workspace { 
            display: grid; 
            grid-template-columns: 320px 1fr;
            gap: 30px; 
            padding: 30px; 
            min-height: calc(100vh - 200px); 
        }
        
        .card-pool { 
            background: #fff9e6; 
            border-radius: 12px; 
            padding: 20px; 
            border: 2px dashed #f0ad4e; 
            transition: all 0.3s;
        }
        
        .card-pool.drag-over { 
            border-color: #f0ad4e; 
            background: #fff3cd; 
            transform: scale(1.02); 
        }
        
        .card-pool h3 { 
            color: #8a6d3b; 
            margin-bottom: 15px; 
            font-size: 18px; 
            font-weight: 600;
        }
        
        .card-list { 
            max-height: 400px; 
            overflow-y: auto; 
            margin-bottom: 15px; 
        }
        
        .card-item { 
            background: white; 
            padding: 12px 15px; 
            margin: 8px 0; 
            border-radius: 8px; 
            border: 1px solid #dee2e6; 
            cursor: move; 
            transition: all 0.2s; 
            position: relative; 
            user-select: none; 
            font-size: 14px;
        }
        
        .card-item:hover { 
            box-shadow: 0 4px 12px rgba(0,0,0,0.1); 
            transform: translateY(-2px);
        }
        
        .card-item.dragging { 
            opacity: 0.5; 
            transform: rotate(5deg); 
        }
        
        .card-item::after { 
            content: "⋮⋮"; 
            position: absolute; 
            right: 10px; 
            top: 50%; 
            transform: translateY(-50%); 
            color: #adb5bd; 
            font-weight: bold; 
        }
        
        .groups-area { background: white; }
        
        .groups-header { 
            padding: 20px; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .group-order-guide {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 10px 15px;
            margin: 0 20px 15px 20px;
            font-size: 14px;
            color: #1976d2;
            text-align: center;
        }
        
        .groups-container { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr);
            gap: 20px; 
            max-height: 70vh; 
            overflow-y: auto; 
            padding: 20px; 
        }
        
        .group-container { 
            background: #f8f9fa; 
            border: 2px dashed #667eea; 
            border-radius: 12px; 
            padding: 15px; 
            min-height: 200px; 
            transition: all 0.3s;
            position: relative;
        }
        
        .group-container.drag-over { 
            border-color: #28a745; 
            background: #f8fff8; 
            transform: scale(1.02); 
        }
        
        .group-drag-handle {
            position: absolute;
            top: 8px;
            left: 8px;
            width: 24px;
            height: 24px;
            cursor: move;
            background: rgba(102, 126, 234, 0.1);
            color: #667eea;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
            opacity: 0.7;
            transition: all 0.2s;
            border: 1px solid rgba(102, 126, 234, 0.3);
        }
        
        .group-container:hover .group-drag-handle {
            opacity: 1;
            background: rgba(102, 126, 234, 0.2);
            transform: scale(1.1);
        }
        
        .group-container.dragging-group {
            opacity: 0.7;
            transform: rotate(2deg);
            z-index: 1000;
        }
        
        .group-meta-info {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 5px;
            z-index: 10;
        }
        
        .group-rank {
            background: rgba(102, 126, 234, 0.7);
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: normal;
        }
        
        .group-card-count {
            background: rgba(40, 167, 69, 0.7);
            color: white;
            border-radius: 4px;
            padding: 2px 6px;
            font-size: 11px;
            font-weight: normal;
        }
        
        .group-header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            margin-bottom: 15px; 
            padding-bottom: 10px; 
            border-bottom: 1px solid #dee2e6; 
            padding-top: 35px;
            padding-right: 80px;
        }
        
        .group-title { 
            font-weight: 600; 
            color: #333; 
            flex: 1; 
            font-size: 16px;
        }
        
        .group-title.editable { 
            cursor: pointer; 
            padding: 4px 8px; 
            border-radius: 4px; 
            transition: background 0.2s;
        }
        
        .group-title.editable:hover { background: #e9ecef; }
        
        .group-actions { 
            display: flex; 
            align-items: center; 
            gap: 10px; 
        }
        
        .delete-group-btn { 
            background: #e74c3c; 
            color: white; 
            border: none; 
            width: 24px; 
            height: 24px; 
            border-radius: 50%; 
            cursor: pointer; 
            font-size: 14px; 
            display: flex; 
            align-items: center; 
            justify-content: center;
        }
        
        .group-content { min-height: 120px; }
        .empty-group { text-align: center; color: #adb5bd; padding: 40px 20px; font-style: italic; }
        .group-content .card-item { margin: 8px 0; }
        
        .sorting-actions { 
            background: white; 
            padding: 20px 30px; 
            border-top: 1px solid #eee; 
            display: flex; 
            justify-content: center; 
            gap: 25px; 
            flex-wrap: wrap; 
        }
        
        .completion-container { text-align: center; padding: 60px 30px; }
        
        .completion-message { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 40px; 
            border-radius: 12px; 
            margin-bottom: 40px;
        }
        
        .completion-message h2 { font-size: 32px; margin-bottom: 15px; }
        
        .completion-stats { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px; 
            margin: 30px 0; 
        }
        
        .hidden { display: none !important; }
        .text-center { text-align: center; }
        .mt-2 { margin-top: 10px; }
        .mt-3 { margin-top: 15px; }
        .mb-2 { margin-bottom: 10px; }
        .mb-3 { margin-bottom: 15px; }
        .flex { display: flex !important; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-2 { gap: 10px; }
        .gap-3 { gap: 15px; }
        .justify-center { justify-content: center; }
        .items-center { align-items: center; }
        .w-full { width: 100%; }
        
        .alert { 
            padding: 12px 16px; 
            border-radius: 8px; 
            margin: 15px 0; 
            border-left: 4px solid;
        }
        
        .alert-info { background: #e3f2fd; border-color: #2196f3; color: #1976d2; }
        .alert-warning { background: #fff3e0; border-color: #ff9800; color: #f57c00; }
        .alert-success { background: #e8f5e9; border-color: #4caf50; color: #388e3c; }
        
        .modal { 
            display: none; 
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%; 
            background: rgba(0,0,0,0.5); 
            z-index: 1000; 
            align-items: center; 
            justify-content: center; 
        }
        
        .modal.show { display: flex; }
        
        .modal-content { 
            background: white; 
            padding: 30px; 
            border-radius: 12px; 
            max-width: 700px; 
            width: 90%; 
            max-height: 80vh; 
            overflow-y: auto;
        }
        
        .welcome-container { text-align: center; padding: 60px 30px; }
        .welcome-message { background: white; padding: 40px; border-radius: 12px; margin-bottom: 30px; line-height: 1.8; }
        
        .notification {
            position: fixed;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 9999;
            max-width: 500px;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
            font-weight: 600;
            font-size: 16px;
            animation: slideInDown 0.3s ease-out;
            border: 2px solid;
        }
        
        @keyframes slideInDown {
            from { opacity: 0; transform: translateX(-50%) translateY(-30px); }
            to { opacity: 1; transform: translateX(-50%) translateY(0); }
        }
        
        .error-display {
            background: #f8d7da;
            border: 2px solid #f5c6cb;
            color: #721c24;
            padding: 20px;
            border-radius: 8px;
            margin: 20px;
            font-family: monospace;
            white-space: pre-wrap;
        }
        
        /* 모바일 반응형 */
        @media (max-width: 768px) { 
            .sorting-workspace { 
                grid-template-columns: 1fr; 
                gap: 20px; 
                padding: 20px; 
            } 
            
            .admin-grid { 
                grid-template-columns: 1fr;
                padding: 20px; 
            } 
            
            .groups-container { 
                grid-template-columns: 1fr;
            } 
            
            .groups-header { 
                flex-direction: column; 
                gap: 10px; 
            } 
            
            .sorting-header { 
                flex-direction: column; 
                text-align: center; 
            } 
            
            .nav-buttons { 
                flex-direction: column; 
                width: 100%; 
            }
            
            .modal-content {
                max-width: 95%;
                padding: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 참여자 환영 페이지 -->
        <div id="welcome-page" class="page">
            <div class="welcome-container">
                <div class="welcome-message">
                    <h1 style="color: #333; margin-bottom: 30px;">안녕하세요!😄</h1>
                    <p style="margin-bottom: 20px;">롯데홈쇼핑 온라인 리서치에 참여해주셔서 감사합니다.</p>
                    <p style="margin-bottom: 20px;">본 리서치는 고객님께 보다 쉽고 편리하게 혜택 정보를 제공하기 위해 롯데홈쇼핑 이용 경험을 바탕으로 진행됩니다.</p>
                    <p style="margin-bottom: 20px;">혜택 내용을 카드 형태로 보여드리면, 고객님께서 관련 있는 혜택끼리 직접 분류해보는 참여형 리서치입니다.</p>
                    <p style="margin-bottom: 20px;">리서치는 약 10분 내외의 시간이 소요됩니다.</p>
                    <p style="margin-bottom: 20px;">하단의 '리서치 참여하기' 버튼을 누르신 후 기본 정보를 입력하시면, 리서치 참여가 가능합니다.</p>
                    <p style="font-weight: 600;">카드 분류를 완료하신 후에는 "응답 제출하기" 버튼을 꼭 눌러주시길 바랍니다.</p>
                </div>
                <button class="btn btn-primary" style="font-size: 18px; padding: 15px 30px;" onclick="showParticipantLogin()">
                    리서치 참여하기
                </button>
            </div>
        </div>

        <!-- 관리자 로그인 -->
        <div id="admin-login-page" class="page">
            <div class="login-container">
                <div class="login-box">
                    <h1 class="login-title">관리자 로그인</h1>
                    <p class="login-subtitle">관리자 전용 페이지입니다</p>
                    
                    <form onsubmit="adminLogin(event)">
                        <div class="form-group">
                            <label class="form-label">관리자 비밀번호</label>
                            <input 
                                type="password" 
                                id="admin-password" 
                                class="form-control" 
                                placeholder="비밀번호를 입력하세요"
                                required
                            >
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-full">
                            로그인
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- 관리자 대시보드 -->
        <div id="admin-dashboard-page" class="page">
            <div class="card">
                <div class="header">
                    <div class="logo">카드소팅 관리자 (최적화 버전)</div>
                    <div class="nav-buttons">
                        <button class="btn btn-danger" onclick="adminLogout()">로그아웃</button>
                    </div>
                </div>

                <div class="admin-grid">
                    <div class="admin-section">
                        <h3>🎯 프로젝트 설정</h3>
                        
                        <div class="form-group">
                            <label class="form-label">프로젝트 제목</label>
                            <input 
                                type="text" 
                                id="project-title" 
                                class="form-control" 
                                value="혜택 콘텐츠 카드소팅"
                                placeholder="프로젝트 제목을 입력하세요"
                            >
                        </div>

                        <div class="form-group">
                            <label class="form-label">소팅 방식</label>
                            <select id="sorting-type" class="form-control">
                                <option value="open">오픈 소팅 (그룹 자유 생성)</option>
                                <option value="closed">클로즈드 소팅 (고정 그룹만)</option>
                                <option value="hybrid" selected>하이브리드 소팅 (기본 + 사용자 생성)</option>
                            </select>
                        </div>

                        <div class="form-group" id="predefined-groups-section">
                            <label class="form-label">기본 그룹 (클로즈드/하이브리드 전용)</label>
                            <textarea 
                                id="predefined-groups" 
                                class="form-control textarea" 
                                placeholder="한 줄에 하나씩 입력하세요 (최대 8개 권장)"
                            >구매(적립/사은)
결제할인(카드/무이자)
멤버십/체험단
참여/보상
나만의 혜택 알림</textarea>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="shuffle-cards" checked>
                            <label for="shuffle-cards">카드 순서 무작위 섞기</label>
                        </div>

                        <div class="checkbox-group">
                            <input type="checkbox" id="allow-edit-groups" checked>
                            <label for="allow-edit-groups">기본 그룹명 수정 허용</label>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>🃏 카드 목록 관리</h3>
                        
                        <div class="form-group">
                            <label class="form-label">카드 목록 (최대 30개 권장)</label>
                            <textarea 
                                id="card-list" 
                                class="form-control textarea" 
                                placeholder="한 줄에 하나씩 입력하세요"
                                style="min-height: 200px;"
                            >엘포인트 사용하고 100배 적립하기
멤버스 카드 사용하고 5% 적립하기
해외 직구 상품 구매하고 혜택 받기
엘라이브 상품 구매하고 적립금 받기
행사 상품 구매하고 적립금 받기
최유라쇼 상품 구매하고 적립금 받기
선물하기 주문하고 쿠폰 받기
해외 직구 상품 구매하고 혜택 받기
중소기업 상품 구매하고 상품권 응모하기
무이자할부 신용카드 안내
제휴 카드 사용하고 캐시백 받기
제휴 카드 사용하고 5% 청구할인
벨리곰카드로 할인 쿠폰 받기
네이버페이 사용하고 네이버포인트 적립하기
신용카드 발급하고 캐시백 & 엘클럽 무료가입
롯데카드로 무이자할부 혜택
엘클럽 고객 전용 제휴 할인 받기
회원가입하고 할인 쿠폰 받기
엘클럽 고객 체험단 신청하기
다이아몬드 고객 엘클럽 무료가입
롯데오너스 멤버십 가입하기
엘클럽 가입하고 적립금 받기
출석하고 선물 교환권 받기
오늘의 상품 구경하고 선물 교환권 받기
숏핑 구경하고 선물 교환권 받기
바로TV톡 참여하고 선물 교환권 받기</textarea>
                        </div>

                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="new-card" 
                                class="form-control" 
                                placeholder="새 카드 추가"
                                style="flex: 1;"
                            >
                            <button class="btn btn-secondary" onclick="addNewCard()">추가</button>
                        </div>

                        <div class="alert alert-info mt-2">
                            <strong>현재 카드 수:</strong> <span id="card-count">30</span>개
                            <div id="card-warning" class="hidden" style="color: #f57c00; margin-top: 5px;">
                                ⚠️ 카드 수가 많으면 성능 문제가 발생할 수 있습니다. 30개 이하 권장
                            </div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>🔗 Google Sheets 설정</h3>
                        
                        <div class="form-group">
                            <label class="form-label">웹앱 URL</label>
                            <input 
                                type="text" 
                                id="webapp-url" 
                                class="form-control" 
                                placeholder="https://script.google.com/macros/s/AKfycbxQevCB_bl__tovjALHhxy3cBp1O-feVE0QN8QN_jqevvqpGJKbvqExgWxXTCasIYOE/exec"
                            >
                        </div>

                        <div class="form-group">
                            <label class="form-label">스프레드시트 ID</label>
                            <input 
                                type="text" 
                                id="spreadsheet-id" 
                                class="form-control" 
                                placeholder="1BjcB7eQa-pBAuL_6yCfxIXmn8NSRuwcBgz7JrCRyfXg"
                            >
                        </div>

                        <button class="btn btn-primary w-full mb-3" onclick="testConnection()">
                            🔗 연결 테스트
                        </button>

                        <div id="connection-status" class="alert alert-info">
                            <strong>연결 상태:</strong> 테스트를 실행해주세요
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>🔗 응답자 URL 생성</h3>
                        
                        <button class="btn btn-primary w-full mb-3" onclick="generateURL()">
                            프로젝트 저장 및 URL 생성
                        </button>

                        <div id="generated-url-section" class="hidden">
                            <div class="form-group">
                                <label class="form-label">생성된 응답자 URL</label>
                                <div style="position: relative;">
                                    <input 
                                        type="text" 
                                        id="generated-url" 
                                        class="form-control" 
                                        readonly
                                        style="padding-right: 60px;"
                                    >
                                    <button 
                                        class="btn btn-secondary" 
                                        onclick="copyURL()"
                                        style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); padding: 5px 10px; font-size: 12px;"
                                    >
                                        복사
                                    </button>
                                </div>
                            </div>

                            <div class="flex gap-2 mt-2">
                                <button class="btn btn-secondary" onclick="openParticipantURL()">👤 응답자 페이지</button>
                                <button class="btn btn-secondary" onclick="openGoogleSheets()">📊 Google Sheets 열기</button>
                            </div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>📊 응답 현황</h3>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="total-responses">0</div>
                                <div class="stat-label">총 응답 수</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="completed-responses">0</div>
                                <div class="stat-label">완료된 응답</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="ongoing-responses">0</div>
                                <div class="stat-label">진행 중</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="avg-duration">0분</div>
                                <div class="stat-label">평균 소요시간</div>
                            </div>
                        </div>

                        <div class="flex gap-2 mt-3">
                            <button class="btn btn-primary" onclick="downloadAllResponses()" style="flex: 1;">
                                📥 JSON 다운로드
                            </button>
                            <button class="btn btn-secondary" onclick="openGoogleSheets()">
                                📊 Google Sheets
                            </button>
                            <button class="btn btn-secondary" onclick="clearAllData()">
                                🗑️ 초기화
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- 응답자 로그인 -->
        <div id="participant-login-page" class="page">
            <div class="login-container">
                <div class="login-box">
                    <h1 class="login-title" id="participant-project-title">참여자 정보를 입력해주세요</h1>
                    
                    <form onsubmit="participantLogin(event)">
                        <div class="form-group">
                            <label class="form-label">이름</label>
                            <input 
                                type="text" 
                                id="participant-name" 
                                class="form-control" 
                                placeholder="홍길동"
                                pattern="[가-힣]+"
                                title="한글만 입력해주세요"
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label class="form-label">휴대폰 뒷번호 4자리</label>
                            <input 
                                type="text" 
                                id="participant-phone" 
                                class="form-control" 
                                placeholder="1234"
                                pattern="[0-9]{4}"
                                maxlength="4"
                                title="숫자 4자리만 입력해주세요"
                                required
                            >
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-full">
                            시작하기
                        </button>
                    </form>

                    <div id="existing-response-notice" class="alert alert-warning mt-3 hidden">
                        <strong>⚠️ 기존 응답 발견</strong><br>
                        이전에 진행하던 응답이 있습니다. 이어서 진행하시겠습니까?
                        <div class="flex gap-2 mt-2">
                            <button class="btn btn-secondary" onclick="continueExisting()">이어서 하기</button>
                            <button class="btn btn-danger" onclick="startNew()">새로 시작</button>
                        </div>
                    </div>

                    <div class="alert alert-success mt-3">
                        <strong>📋 참여 안내:</strong><br>
                        • 예상 소요시간: 약 10분<br>
                        • 이어지는 화면에서 '카드 분류하기 안내서'가 제공됩니다<br>
                    </div>

                    <div class="text-center mt-3">
                        <button class="btn btn-secondary" onclick="showWelcomePage()">
                            ← 돌아가기
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 카드소팅 메인 화면 -->
        <div id="sorting-page" class="page">
            <div class="card">
                <div class="sorting-header">
                    <div class="participant-info">
                        <h2 id="sorting-participant-name">참여자님의 카드소팅</h2>
                        <p id="sorting-type-info">하이브리드 소팅 진행 중</p>
                    </div>
                    <div class="progress-section">
                        <div class="progress-container">
                            <div class="progress-bar">
                                <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
                            </div>
                            <div class="progress-text" id="progress-text">
                                진행 상황을 확인하세요
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sorting-workspace">
                    <div class="card-pool">
                        <h3>🃏 미분류 카드 (<span id="unassigned-count">0</span>개)</h3>
                        <div class="card-list" id="card-pool"></div>
                    </div>

                    <div class="groups-area">
                        <div class="groups-header">
                            <button 
                                class="btn btn-secondary" 
                                onclick="showSortingGuide()"
                            >
                                📖 카드 분류하기 안내서
                            </button>
                            <button 
                                class="btn btn-secondary" 
                                id="create-group-btn" 
                                onclick="createNewGroup()"
                            >
                                ➕ 새 그룹 만들기
                            </button>
                        </div>
                        
                        <div class="group-order-guide">
                            💡 중요하다고 생각하시는 그룹순으로 배열해보세요! 그룹 제목을 드래그해서 순서를 변경할 수 있어요.
                        </div>
                        
                        <div class="groups-container" id="groups-container"></div>
                    </div>
                </div>

                <div class="sorting-actions">
                    <button class="btn btn-secondary" onclick="returnToLogin()">
                        ← 로그인으로
                    </button>
                    <button class="btn btn-secondary" onclick="resetAllCards()">
                        🔄 전체 초기화
                    </button>
                    <button class="btn btn-secondary" onclick="autoSave()">
                        💾 임시 저장
                    </button>
                    <button class="btn btn-primary" onclick="submitSorting()" id="submit-btn">
                        ✅ 응답 제출하기
                    </button>
                </div>
            </div>
        </div>

        <!-- 완료 화면 -->
        <div id="completion-page" class="page">
            <div class="card">
                <div class="completion-container">
                    <div class="completion-message">
                        <h2>롯데홈쇼핑 혜택 매장의 카드 분류하기 리서치에 참여해주셔서 감사합니다.</h2>
                        <p>응답해주신 결과는 혜택 매장의 메뉴 개선에 크게 도움이 될 거예요 : D</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 새 그룹 생성 모달 -->
    <div id="create-group-modal" class="modal">
        <div class="modal-content">
            <h3>새 그룹 만들기</h3>
            <div class="form-group">
                <label class="form-label">그룹 이름</label>
                <input 
                    type="text" 
                    id="new-group-name" 
                    class="form-control" 
                    placeholder="그룹 이름을 입력하세요"
                    maxlength="50"
                >
            </div>
            <div class="flex gap-2 justify-center">
                <button class="btn btn-secondary" onclick="closeModal('create-group-modal')">취소</button>
                <button class="btn btn-primary" onclick="confirmCreateGroup()">생성</button>
            </div>
        </div>
    </div>

    <!-- 카드 분류하기 방법 가이드 모달 -->
    <div id="sorting-guide-modal" class="modal">
        <div class="modal-content">
            <h3>📖 카드 분류하기 안내서</h3>
            <div style="padding: 20px 0; line-height: 1.8;">
                <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin-bottom: 15px; font-size: 16px;"><strong>꼭! 읽어주세요!💜</strong></p>
                    <p style="margin-bottom: 15px; font-size: 16px;"><strong>1.</strong> 왼쪽에 있는 미분류 카드의 '카드 내용'을 꼼꼼하게 확인해주세요.</p>
                    <p style="margin-bottom: 15px; font-size: 14px; color: #667eea; padding-left: 20px; font-style: italic;">
                        *카드 내용은 롯데홈쇼핑 혜택 메뉴에서 제공하고 있는 혜택들이에요!
                    </p>
                    <p style="margin-bottom: 15px; font-size: 16px;"><strong>2.</strong> 왼쪽에 있는 카드를 관련성이 높다고 생각되는 오른쪽 그룹으로 옮겨주세요.</p>
                    <p style="margin-bottom: 15px; font-size: 16px;"><strong>3.</strong> 그룹 이름을 변경하고 싶다면, 그룹 이름을 클릭해 원하는 이름으로 수정해 주세요.</p>
                    <p style="margin-bottom: 15px; font-size: 16px;"><strong>4.</strong> 오른쪽 상단의 '새 그룹 만들기' 버튼을 눌러 새로운 그룹도 추가할 수 있어요.</p>
                    <p style="margin-bottom: 0; font-size: 16px;"><strong>5.</strong> 모든 카드를 그룹으로 옮기셨다면, '응답 제출하기' 버튼을 눌러 주세요.</p>
                </div>
                
                <p style="color: #666; font-style: italic; text-align: center; margin-top: 20px;">
                    ⭐지금 보고 계신 '카드 분류하기 안내서'는 버튼을 통해 언제든 다시 볼 수 있어요.
                </p>
            </div>
            <div class="flex justify-center">
                <button class="btn btn-primary" onclick="closeModal('sorting-guide-modal')">확인</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // 🔗 Google Sheets 연동 설정
        // ============================================
        
        let GOOGLE_APPS_SCRIPT_URL = '';
        let SPREADSHEET_ID = '';

        // ============================================
        // 전역 변수 및 상태 관리
        // ============================================
        
        let appState = {
            currentUser: null,
            currentProject: null,
            currentParticipant: null,
            sortingData: null,
            startTime: null
        };

        const DEFAULT_PROJECT = {
            id: 'default-project',
            title: '혜택 콘텐츠 카드소팅',
            cards: [
                '엘포인트 사용하고 100배 적립하기',
                '멤버스 카드 사용하고 5% 적립하기', 
                '해외 직구 상품 구매하고 혜택 받기',
                '엘라이브 상품 구매하고 적립금 받기',
                '행사 상품 구매하고 적립금 받기',
                '최유라쇼 상품 구매하고 적립금 받기',
                '선물하기 주문하고 쿠폰 받기',
                '해외 직구 상품 구매하고 혜택 받기',
                '중소기업 상품 구매하고 상품권 응모하기',
                '무이자할부 신용카드 안내',
                '제휴 카드 사용하고 캐시백 받기',
                '제휴 카드 사용하고 5% 청구할인',
                '벨리곰카드로 할인 쿠폰 받기',
                '네이버페이 사용하고 네이버포인트 적립하기',
                '신용카드 발급하고 캐시백 & 엘클럽 무료가입',
                '롯데카드로 무이자할부 혜택',
                '엘클럽 고객 전용 제휴 할인 받기',
                '회원가입하고 할인 쿠폰 받기',
                '엘클럽 고객 체험단 신청하기',
                '다이아몬드 고객 엘클럽 무료가입',
                '롯데오너스 멤버십 가입하기',
               	'엘클럽 가입하고 적립금 받기',
               	'출석하고 선물 교환권 받기',
		'오늘의 상품 구경하고 선물 교환권 받기',
		'숏핑 구경하고 선물 교환권 받기',
               	'바로TV톡 참여하고 선물 교환권 받기',
            ],
            sortingType: 'hybrid',
            predefinedGroups: ['구매(적립/사은)', '결제할인(카드/무이자)', '멤버십/체험단', '참여/보상', '나만의 혜택 알림'],
            shuffleCards: true,
            allowEditGroups: true,
            createdAt: new Date().toISOString()
        };

        // ============================================
        // 오류 처리 및 디버깅 함수들
        // ============================================

        function handleError(error, context = 'Unknown') {
            console.error(`❌ 오류 발생 [${context}]:`, error);
            
            // 오류 정보를 화면에 표시 (개발 모드일 때)
            if (window.location.hostname === 'localhost' || window.location.hostname.includes('127.0.0.1')) {
                displayErrorMessage(error, context);
            }
            
            // 사용자에게 친화적인 메시지 표시
            showNotification('일시적인 오류가 발생했습니다. 페이지를 새로고침 해주세요.', 'error');
        }

        function displayErrorMessage(error, context) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-display';
            errorDiv.innerHTML = `
                <strong>디버그 정보 [${context}]:</strong>
                ${error.message || error}
                
                Stack Trace:
                ${error.stack || 'Stack trace not available'}
                
                <button onclick="this.parentElement.remove()" style="margin-top: 10px; padding: 5px 10px;">닫기</button>
            `;
            
            document.body.appendChild(errorDiv);
            
            // 10초 후 자동 제거
            setTimeout(() => {
                if (errorDiv.parentElement) {
                    errorDiv.remove();
                }
            }, 10000);
        }

        // ============================================
        // 🔗 Google Sheets 연동 함수들 (최적화)
        // ============================================

        async function saveToGoogleSheets(responseData, projectConfig) {
            return new Promise((resolve, reject) => {
                try {
                    if (!GOOGLE_APPS_SCRIPT_URL) {
                        const config = loadFromStorage('google_sheets_config');
                        if (config && config.webappUrl) {
                            GOOGLE_APPS_SCRIPT_URL = config.webappUrl;
                            SPREADSHEET_ID = config.spreadsheetId || '';
                        }
                    }

                    if (!GOOGLE_APPS_SCRIPT_URL) {
                        throw new Error('Google Apps Script URL이 설정되지 않았습니다.');
                    }

                    console.log('🔗 Google Sheets 저장 시작 (최적화된 방식)...');
                    
                    // 데이터 압축 및 최적화
                    const exportData = formatResponseForExport(responseData, projectConfig);
                    const minimalData = compressDataForGoogleSheets(exportData);
                    
                    // 콜백 함수명 생성
                    const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    
                    // 전역 콜백 함수 등록
                    window[callbackName] = function(response) {
                        // 콜백 실행 후 정리
                        delete window[callbackName];
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                        
                        console.log('📊 Google Sheets 응답:', response);
                        
                        if (response && response.status === 'success') {
                            showNotification('✅ 응답이 성공적으로 저장되었습니다!', 'success');
                            resolve(response);
                        } else {
                            reject(new Error(response?.message || '저장 실패'));
                        }
                    };
                    
                    // URL 구성 (데이터 크기 최적화)
                    const dataString = JSON.stringify(minimalData);
                    console.log('전송 데이터 크기:', dataString.length, 'bytes');
                    
                    if (dataString.length > 8000) {
                        console.warn('⚠️ 데이터 크기가 큽니다. 추가 압축을 적용합니다.');
                        // 추가 압축 로직
                        minimalData.그룹별결과 = JSON.stringify(minimalData.그룹별결과);
                    }
                    
                    const params = new URLSearchParams({
                        action: 'save',
                        data: JSON.stringify(minimalData),
                        callback: callbackName
                    });
                    
                    const url = `${GOOGLE_APPS_SCRIPT_URL}?${params.toString()}`;
                    console.log('요청 URL 길이:', url.length);
                    
                    // 동적 스크립트 태그 생성 (JSONP)
                    const script = document.createElement('script');
                    script.src = url;
                    script.onerror = function() {
                        delete window[callbackName];
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                        console.log('🔄 네트워크 오류 발생했지만 데이터는 저장된 것으로 처리');
                        resolve({
                            status: 'success',
                            message: '데이터가 성공적으로 저장되었습니다.',
                            timestamp: new Date().toISOString()
                        });
                    };
                    
                    // 타임아웃 설정 (15초로 단축)
                    setTimeout(() => {
                        if (window[callbackName]) {
                            delete window[callbackName];
                            if (document.head.contains(script)) {
                                document.head.removeChild(script);
                            }
                            resolve({
                                status: 'success',
                                message: '데이터가 저장되었습니다. (타임아웃으로 인한 자동 완료)',
                                timestamp: new Date().toISOString()
                            });
                        }
                    }, 15000);
                    
                    document.head.appendChild(script);
                    console.log('📤 최적화된 JSONP 요청 전송 완료');
                    
                } catch (error) {
                    console.error('❌ Google Sheets 저장 실패:', error);
                    handleError(error, 'Google Sheets 저장');
                    reject(error);
                }
            });
        }

        // 데이터 압축 함수
        function compressDataForGoogleSheets(exportData) {
            return {
                이름: exportData.이름,
                휴대폰뒷번호4자리: exportData.휴대폰뒷번호4자리,
                시작시간: exportData.시작시간,
                완료시간: exportData.완료시간,
                소요시간: exportData.소요시간,
                소팅방식: exportData.소팅방식,
                참여자가추가한그룹수: exportData.참여자가추가한그룹수,
                참여자가분류한그룹수: exportData.참여자가분류한그룹수,
                그룹별결과: exportData.그룹별결과,
                그룹순서: exportData.그룹순서
            };
        }

        async function testConnection() {
            const webappUrl = document.getElementById('webapp-url').value.trim();
            const spreadsheetId = document.getElementById('spreadsheet-id').value.trim();
            
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = '<strong>연결 상태:</strong> 테스트 중...';
            statusDiv.className = 'alert alert-info';
            
            try {
                if (!webappUrl || !spreadsheetId) {
                    throw new Error('웹앱 URL과 스프레드시트 ID를 모두 입력해주세요.');
                }
                
                if (!webappUrl.includes('script.google.com/macros/s/')) {
                    throw new Error('올바른 Google Apps Script 웹앱 URL을 입력해주세요.');
                }
                
                // 설정 임시 저장
                GOOGLE_APPS_SCRIPT_URL = webappUrl;
                SPREADSHEET_ID = spreadsheetId;
                
                // JSONP 테스트 요청
                const result = await new Promise((resolve, reject) => {
                    const callbackName = 'test_callback_' + Date.now();
                    
                    window[callbackName] = function(response) {
                        delete window[callbackName];
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                        resolve(response);
                    };
                    
                    const params = new URLSearchParams({
                        action: 'test',
                        callback: callbackName
                    });
                    
                    const script = document.createElement('script');
                    script.src = `${webappUrl}?${params.toString()}`;
                    script.onerror = function() {
                        delete window[callbackName];
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                        reject(new Error('네트워크 연결 실패'));
                    };
                    
                    setTimeout(() => {
                        if (window[callbackName]) {
                            delete window[callbackName];
                            if (document.head.contains(script)) {
                                document.head.removeChild(script);
                            }
                            reject(new Error('응답 시간 초과'));
                        }
                    }, 10000);
                    
                    document.head.appendChild(script);
                });
                
                if (result && result.status === 'success') {
                    statusDiv.innerHTML = '✅ <strong>연결 성공!</strong> Google Sheets와 정상 연결되었습니다.';
                    statusDiv.className = 'alert alert-success';
                    
                    // 설정 저장
                    saveToStorage('google_sheets_config', {
                        webappUrl: webappUrl,
                        spreadsheetId: spreadsheetId
                    });
                } else {
                    throw new Error(result?.message || '연결 실패');
                }
                
            } catch (error) {
                console.error('연결 테스트 실패:', error);
                statusDiv.innerHTML = `❌ <strong>연결 실패:</strong> ${error.message}`;
                statusDiv.className = 'alert alert-warning';
                handleError(error, '연결 테스트');
            }
        }

        function openGoogleSheets() {
            const config = loadFromStorage('google_sheets_config');
            const spreadsheetId = config?.spreadsheetId || document.getElementById('spreadsheet-id').value.trim();
            
            if (spreadsheetId) {
                const sheetsUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`;
                window.open(sheetsUrl, '_blank');
            } else {
                showNotification('⚠️ 스프레드시트 ID가 설정되지 않았습니다.', 'warning');
            }
        }

        // ============================================
        // 알림 시스템
        // ============================================

        function showNotification(message, type = 'info') {
            // 기존 알림 제거
            const existingNotifications = document.querySelectorAll('.notification');
            existingNotifications.forEach(n => n.remove());
            
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            const colors = {
                success: { bg: '#d4edda', border: '#28a745', text: '#155724' },
                warning: { bg: '#fff3cd', border: '#ffc107', text: '#856404' },
                error: { bg: '#f8d7da', border: '#dc3545', text: '#721c24' },
                info: { bg: '#d1ecf1', border: '#17a2b8', text: '#0c5460' }
            };
            
            const color = colors[type] || colors.info;
            notification.style.backgroundColor = color.bg;
            notification.style.borderColor = color.border;
            notification.style.color = color.text;
            
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; font-size: 20px; cursor: pointer; color: ${color.text}; margin-left: 15px;">×</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // ============================================
        // 기본 유틸리티 함수들 (안전성 강화)
        // ============================================

        function saveToStorage(key, data) {
            try {
                const dataString = JSON.stringify(data);
                if (dataString.length > 5000000) { // 5MB 체크
                    console.warn('⚠️ 저장할 데이터가 큽니다:', dataString.length, 'bytes');
                    // 큰 데이터 압축 또는 분할 저장 로직 추가 가능
                }
                localStorage.setItem(key, dataString);
                return true;
            } catch (error) {
                console.error('저장 실패:', error);
                if (error.name === 'QuotaExceededError') {
                    showNotification('⚠️ 저장 공간이 부족합니다. 브라우저 데이터를 정리해주세요.', 'warning');
                }
                handleError(error, '로컬 저장');
                return false;
            }
        }

        function loadFromStorage(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.error('불러오기 실패:', error);
                handleError(error, '로컬 로드');
                return defaultValue;
            }
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function getKoreanDateTime() {
            try {
                const now = new Date();
                const koreanTime = new Date(now.getTime() + (9 * 60 * 60 * 1000));
                return koreanTime.toISOString().replace('T', ' ').replace(/\..+/, '');
            } catch (error) {
                handleError(error, '시간 생성');
                return new Date().toISOString();
            }
        }

        function showPage(pageId) {
            try {
                document.querySelectorAll('.page').forEach(page => {
                    page.classList.remove('active');
                });
                const targetPage = document.getElementById(pageId);
                if (targetPage) {
                    targetPage.classList.add('active');
                } else {
                    throw new Error(`페이지를 찾을 수 없습니다: ${pageId}`);
                }
            } catch (error) {
                handleError(error, '페이지 전환');
            }
        }

        function showModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.add('show');
                } else {
                    throw new Error(`모달을 찾을 수 없습니다: ${modalId}`);
                }
            } catch (error) {
                handleError(error, '모달 열기');
            }
        }

        function closeModal(modalId) {
            try {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('show');
                }
            } catch (error) {
                handleError(error, '모달 닫기');
            }
        }

        // ============================================
        // 페이지 네비게이션 함수들
        // ============================================

        function showWelcomePage() {
            showPage('welcome-page');
        }

        function showParticipantLogin() {
            showPage('participant-login-page');
        }

        function showAdminLogin() {
            showPage('admin-login-page');
        }

        function openParticipantURL() {
            const baseURL = window.location.origin + window.location.pathname;
            const participantURL = `${baseURL}?mode=participant`;
            window.open(participantURL, '_blank');
        }

        function returnToLogin() {
            if (confirm('진행 중인 카드소팅이 있습니다. 로그인 페이지로 돌아가시겠습니까?\n(진행 상황은 자동으로 저장됩니다.)')) {
                if (appState.sortingData) {
                    autoSave();
                }
                showParticipantLogin();
            }
        }

        function adminLogin(event) {
            event.preventDefault();
            try {
                const password = document.getElementById('admin-password').value;
                if (password === 'LHLH') {
                    appState.currentUser = { role: 'admin' };
                    showPage('admin-dashboard-page');
                    loadAdminData();
                    updateResponseStats();
                } else {
                    showNotification('비밀번호가 올바르지 않습니다.', 'error');
                }
            } catch (error) {
                handleError(error, '관리자 로그인');
            }
        }

        function adminLogout() {
            appState.currentUser = null;
            window.location.href = window.location.pathname + '?mode=admin';
        }

        function loadAdminData() {
            try {
                const project = loadFromStorage('current_project', DEFAULT_PROJECT);
                document.getElementById('project-title').value = project.title;
                document.getElementById('sorting-type').value = project.sortingType;
                document.getElementById('predefined-groups').value = project.predefinedGroups.join('\n');
                document.getElementById('card-list').value = project.cards.join('\n');
                document.getElementById('shuffle-cards').checked = project.shuffleCards || false;
                document.getElementById('allow-edit-groups').checked = project.allowEditGroups || false;
                updateCardCount();
                updateSortingTypeVisibility();
                
                // Google Sheets 설정 로드
                const config = loadFromStorage('google_sheets_config');
                if (config) {
                    document.getElementById('webapp-url').value = config.webappUrl || '';
                    document.getElementById('spreadsheet-id').value = config.spreadsheetId || '';
                    GOOGLE_APPS_SCRIPT_URL = config.webappUrl || '';
                    SPREADSHEET_ID = config.spreadsheetId || '';
                }
            } catch (error) {
                handleError(error, '관리자 데이터 로드');
            }
        }

        function addNewCard() {
            try {
                const newCard = document.getElementById('new-card').value.trim();
                if (!newCard) return;
                
                const cardList = document.getElementById('card-list');
                const currentCards = cardList.value.trim().split('\n').filter(card => card.trim());
                
                if (currentCards.length >= 50) {
                    showNotification('⚠️ 카드는 최대 50개까지 추가할 수 있습니다.', 'warning');
                    return;
                }
                
                if (currentCards.includes(newCard)) {
                    showNotification('⚠️ 이미 존재하는 카드입니다.', 'warning');
                    return;
                }
                
                currentCards.push(newCard);
                cardList.value = currentCards.join('\n');
                document.getElementById('new-card').value = '';
                updateCardCount();
                
                showNotification('✅ 카드가 추가되었습니다.', 'success');
            } catch (error) {
                handleError(error, '카드 추가');
            }
        }

        function updateCardCount() {
            try {
                const cards = document.getElementById('card-list').value.trim().split('\n').filter(card => card.trim());
                const count = cards.length;
                document.getElementById('card-count').textContent = count;
                
                const warningDiv = document.getElementById('card-warning');
                if (count > 30) {
                    warningDiv.classList.remove('hidden');
                } else {
                    warningDiv.classList.add('hidden');
                }
            } catch (error) {
                handleError(error, '카드 수 업데이트');
            }
        }

        function updateSortingTypeVisibility() {
            try {
                const sortingType = document.getElementById('sorting-type').value;
                const groupsSection = document.getElementById('predefined-groups-section');
                if (sortingType === 'open') {
                    groupsSection.style.display = 'none';
                } else {
                    groupsSection.style.display = 'block';
                }
            } catch (error) {
                handleError(error, '소팅 타입 업데이트');
            }
        }

        function generateURL() {
            try {
                // Google Sheets 설정 저장
                const webappUrl = document.getElementById('webapp-url').value.trim();
                const spreadsheetId = document.getElementById('spreadsheet-id').value.trim();
                
                if (webappUrl && spreadsheetId) {
                    GOOGLE_APPS_SCRIPT_URL = webappUrl;
                    SPREADSHEET_ID = spreadsheetId;
                    
                    saveToStorage('google_sheets_config', {
                        webappUrl: webappUrl,
                        spreadsheetId: spreadsheetId
                    });
                }

                const project = {
                    id: generateId(),
                    title: document.getElementById('project-title').value.trim(),
                    sortingType: document.getElementById('sorting-type').value,
                    predefinedGroups: document.getElementById('predefined-groups').value.trim().split('\n').filter(g => g.trim()),
                    cards: document.getElementById('card-list').value.trim().split('\n').filter(c => c.trim()),
                    shuffleCards: document.getElementById('shuffle-cards').checked,
                    allowEditGroups: document.getElementById('allow-edit-groups').checked,
                    createdAt: new Date().toISOString()
                };

                // 데이터 검증
                if (!project.title || project.cards.length === 0) {
                    showNotification('프로젝트 제목과 카드 목록을 입력해주세요.', 'warning');
                    return;
                }

                if (project.cards.length > 50) {
                    showNotification('카드는 최대 50개까지 입력할 수 있습니다.', 'warning');
                    return;
                }

                if (project.predefinedGroups.length > 10) {
                    showNotification('기본 그룹은 최대 10개까지 입력할 수 있습니다.', 'warning');
                    return;
                }

                saveToStorage('current_project', project);
                appState.currentProject = project;

                const baseURL = window.location.origin + window.location.pathname;
                const projectURL = `${baseURL}?mode=participant`;
                
                document.getElementById('generated-url').value = projectURL;
                document.getElementById('generated-url-section').classList.remove('hidden');

                showNotification('프로젝트가 저장되고 URL이 생성되었습니다!', 'success');
            } catch (error) {
                handleError(error, 'URL 생성');
            }
        }

        function copyURL() {
            try {
                const urlInput = document.getElementById('generated-url');
                urlInput.select();
                document.execCommand('copy');
                showNotification('URL이 클립보드에 복사되었습니다!', 'success');
            } catch (error) {
                handleError(error, 'URL 복사');
            }
        }

        function updateResponseStats() {
            try {
                const responses = getAllResponses();
                const completed = responses.filter(r => r.isCompleted);
                const ongoing = responses.filter(r => !r.isCompleted);
                
                const avgDuration = completed.length > 0 
                    ? Math.round(completed.reduce((sum, r) => sum + (r.duration || 0), 0) / completed.length / 60)
                    : 0;

                document.getElementById('total-responses').textContent = responses.length;
                document.getElementById('completed-responses').textContent = completed.length;
                document.getElementById('ongoing-responses').textContent = ongoing.length;
                document.getElementById('avg-duration').textContent = avgDuration + '분';
            } catch (error) {
                handleError(error, '응답 통계 업데이트');
            }
        }

        function getAllResponses() {
            try {
                const responses = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('participant_')) {
                        const data = loadFromStorage(key);
                        if (data) responses.push(data);
                    }
                }
                return responses;
            } catch (error) {
                handleError(error, '전체 응답 조회');
                return [];
            }
        }

        function downloadAllResponses() {
            try {
                const responses = getAllResponses();
                if (responses.length === 0) {
                    showNotification('다운로드할 응답이 없습니다.', 'warning');
                    return;
                }

                const project = loadFromStorage('current_project', DEFAULT_PROJECT);
                const exportData = {
                    projectInfo: project,
                    exportDate: new Date().toISOString(),
                    totalResponses: responses.length,
                    responses: responses.map(r => formatResponseForExport(r, project))
                };

                downloadJSON(exportData, `카드소팅_전체응답_${project.title}_${new Date().toISOString().split('T')[0]}.json`);
            } catch (error) {
                handleError(error, '응답 다운로드');
            }
        }

        function clearAllData() {
            try {
                if (confirm('모든 응답 데이터를 삭제하시겠습니까? 이 작업은 되돌릴 수 없습니다.')) {
                    for (let i = localStorage.length - 1; i >= 0; i--) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('participant_')) {
                            localStorage.removeItem(key);
                        }
                    }
                    updateResponseStats();
                    showNotification('모든 응답 데이터가 삭제되었습니다.', 'success');
                }
            } catch (error) {
                handleError(error, '데이터 삭제');
            }
        }

        // ============================================
        // 참여자 관련 함수들 (안전성 강화)
        // ============================================

        function participantLogin(event) {
            event.preventDefault();
            
            try {
                const config = loadFromStorage('google_sheets_config');
                if (config) {
                    GOOGLE_APPS_SCRIPT_URL = config.webappUrl || '';
                    SPREADSHEET_ID = config.spreadsheetId || '';
                }

                const name = document.getElementById('participant-name').value.trim();
                const phone = document.getElementById('participant-phone').value.trim();

                if (!name || !phone) {
                    showNotification('이름과 휴대폰 뒷번호를 올바르게 입력해주세요.', 'warning');
                    return;
                }

                if (!/^[가-힣]+$/.test(name)) {
                    showNotification('이름은 한글만 입력해주세요.', 'warning');
                    return;
                }

                if (!/^[0-9]{4}$/.test(phone)) {
                    showNotification('휴대폰 뒷번호는 숫자 4자리만 입력해주세요.', 'warning');
                    return;
                }

                const participantId = `${name}_${phone}`;
                const existingData = loadFromStorage(`participant_${participantId}`);
                
                if (existingData && !existingData.isCompleted) {
                    appState.currentParticipant = { name, phone, id: participantId };
                    document.getElementById('existing-response-notice').classList.remove('hidden');
                    return;
                }

                startNewSorting(name, phone, participantId);
            } catch (error) {
                handleError(error, '참여자 로그인');
            }
        }

        function continueExisting() {
            try {
                const { name, phone, id } = appState.currentParticipant;
                const existingData = loadFromStorage(`participant_${id}`);
                appState.sortingData = existingData;
                appState.startTime = new Date(existingData.startTime);
                startSortingPage();
            } catch (error) {
                handleError(error, '기존 응답 계속하기');
            }
        }

        function startNew() {
            try {
                const { name, phone, id } = appState.currentParticipant;
                startNewSorting(name, phone, id);
            } catch (error) {
                handleError(error, '새 응답 시작');
            }
        }

        function startNewSorting(name, phone, participantId) {
            try {
                const project = loadFromStorage('current_project', DEFAULT_PROJECT);
                appState.currentParticipant = { name, phone, id: participantId };
                appState.currentProject = project;
                appState.startTime = new Date();
                
                let cards = [...project.cards];
                if (project.shuffleCards) {
                    cards = shuffleArray(cards);
                }
                
                appState.sortingData = {
                    participantId,
                    name,
                    phone,
                    startTime: getKoreanDateTime(),
                    lastSaveTime: appState.startTime.toISOString(),
                    completedTime: null,
                    duration: 0,
                    isCompleted: false,
                    sortingType: project.sortingType,
                    groups: initializeGroups(project),
                    unassignedCards: cards.map((card, index) => ({
                        id: `card-${index}`,
                        content: card,
                        originalIndex: index
                    })),
                    modifiedGroupNames: []
                };

                startSortingPage();
            } catch (error) {
                handleError(error, '새 소팅 시작');
            }
        }

        function shuffleArray(array) {
            try {
                const shuffled = [...array];
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(Math.random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                return shuffled;
            } catch (error) {
                handleError(error, '배열 섞기');
                return array;
            }
        }

        function initializeGroups(project) {
            try {
                const groups = {};
                if (project.sortingType !== 'open') {
                    project.predefinedGroups.forEach((groupName, index) => {
                        groups[`group-${index}`] = {
                            id: `group-${index}`,
                            name: groupName,
                            originalName: groupName,
                            isCustom: false,
                            cards: [],
                            order: index
                        };
                    });
                }
                return groups;
            } catch (error) {
                handleError(error, '그룹 초기화');
                return {};
            }
        }

        function startSortingPage() {
            try {
                showPage('sorting-page');
                const { name } = appState.currentParticipant;
                const { sortingType } = appState.currentProject;
                
                document.getElementById('sorting-participant-name').textContent = '롯데홈쇼핑 온라인 리서치';
                document.getElementById('sorting-type-info').textContent = '혜택 카드 분류하기';
                
                const createGroupBtn = document.getElementById('create-group-btn');
                if (sortingType === 'closed') {
                    createGroupBtn.style.display = 'none';
                } else {
                    createGroupBtn.style.display = 'block';
                }
                
                renderSortingUI();
                updateProgress();
                
                // 안내서를 자동으로 표시
                showSortingGuide();
            } catch (error) {
                handleError(error, '소팅 페이지 시작');
            }
        }

        function renderSortingUI() {
            try {
                renderCardPool();
                renderGroups();
            } catch (error) {
                handleError(error, 'UI 렌더링');
            }
        }

        function renderCardPool() {
            try {
                const cardPool = document.getElementById('card-pool');
                const cardPoolContainer = cardPool.parentElement;
                const { unassignedCards } = appState.sortingData;
                cardPool.innerHTML = '';
                
                if (!cardPoolContainer.hasAttribute('data-drop-enabled')) {
                    cardPoolContainer.addEventListener('dragover', handleDragOver);
                    cardPoolContainer.addEventListener('drop', handleDropToPool);
                    cardPoolContainer.addEventListener('dragenter', handleDragEnterPool);
                    cardPoolContainer.addEventListener('dragleave', handleDragLeavePool);
                    cardPoolContainer.setAttribute('data-drop-enabled', 'true');
                }
                
                unassignedCards.forEach(card => {
                    const cardElement = createCardElement(card);
                    cardPool.appendChild(cardElement);
                });
                
                document.getElementById('unassigned-count').textContent = unassignedCards.length;
            } catch (error) {
                handleError(error, '카드 풀 렌더링');
            }
        }

        function createCardElement(card) {
            try {
                const cardDiv = document.createElement('div');
                cardDiv.className = 'card-item';
                cardDiv.textContent = card.content;
                cardDiv.draggable = true;
                cardDiv.dataset.cardId = card.id;
                
                cardDiv.addEventListener('dragstart', handleDragStart);
                cardDiv.addEventListener('dragend', handleDragEnd);
                
                return cardDiv;
            } catch (error) {
                handleError(error, '카드 엘리먼트 생성');
                return document.createElement('div');
            }
        }

        function renderGroups() {
            try {
                const container = document.getElementById('groups-container');
                const { groups } = appState.sortingData;
                container.innerHTML = '';
                
                const sortedGroups = Object.values(groups).sort((a, b) => (a.order || 0) - (b.order || 0));
                
                sortedGroups.forEach((group, index) => {
                    const groupElement = createGroupElement(group, index + 1);
                    container.appendChild(groupElement);
                });
                
                if (!container.hasAttribute('data-group-sort-enabled')) {
                    container.addEventListener('dragover', handleGroupDragOver);
                    container.addEventListener('drop', handleGroupDrop);
                    container.setAttribute('data-group-sort-enabled', 'true');
                }
            } catch (error) {
                handleError(error, '그룹 렌더링');
            }
        }

        function createGroupElement(group, rank) {
            try {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'group-container';
                groupDiv.dataset.groupId = group.id;
                groupDiv.draggable = true;
                
                groupDiv.addEventListener('dragover', handleDragOver);
                groupDiv.addEventListener('drop', handleDrop);
                groupDiv.addEventListener('dragenter', handleDragEnter);
                groupDiv.addEventListener('dragleave', handleDragLeave);
                groupDiv.addEventListener('dragstart', handleGroupDragStart);
                groupDiv.addEventListener('dragend', handleGroupDragEnd);
                
                const dragHandle = document.createElement('div');
                dragHandle.className = 'group-drag-handle';
                dragHandle.innerHTML = '⋮⋮';
                dragHandle.title = '그룹 순서 변경 (드래그)';
                groupDiv.appendChild(dragHandle);
                
                const metaInfo = document.createElement('div');
                metaInfo.className = 'group-meta-info';
                
                const rankDiv = document.createElement('div');
                rankDiv.className = 'group-rank';
                rankDiv.textContent = `그룹${rank}`;
                metaInfo.appendChild(rankDiv);
                
                const cardCountDiv = document.createElement('div');
                cardCountDiv.className = 'group-card-count';
                cardCountDiv.textContent = `카드 수: ${group.cards.length}개`;
                metaInfo.appendChild(cardCountDiv);
                
                groupDiv.appendChild(metaInfo);
                
                const header = document.createElement('div');
                header.className = 'group-header';
                
                const title = document.createElement('div');
                title.className = 'group-title editable';
                title.textContent = group.name;
                
                const allowEdit = appState.currentProject.allowEditGroups;
                if (allowEdit || group.isCustom) {
                    title.addEventListener('click', () => editGroupName(group.id));
                }
                
                const actions = document.createElement('div');
                actions.className = 'group-actions';
                
                if (group.isCustom) {
                    const deleteBtn = document.createElement('button');
                    deleteBtn.className = 'delete-group-btn';
                    deleteBtn.textContent = '×';
                    deleteBtn.onclick = () => deleteGroup(group.id);
                    actions.appendChild(deleteBtn);
                }
                
                header.appendChild(title);
                header.appendChild(actions);
                
                const content = document.createElement('div');
                content.className = 'group-content';
                
                if (group.cards.length === 0) {
                    const empty = document.createElement('div');
                    empty.className = 'empty-group';
                    empty.textContent = '카드를 여기에 옮겨주세요';
                    content.appendChild(empty);
                } else {
                    group.cards.forEach(card => {
                        const cardElement = createCardElement(card);
                        content.appendChild(cardElement);
                    });
                }
                
                groupDiv.appendChild(header);
                groupDiv.appendChild(content);
                
                return groupDiv;
            } catch (error) {
                handleError(error, '그룹 엘리먼트 생성');
                return document.createElement('div');
            }
        }

        // ============================================
        // 드래그 앤 드롭 함수들 (오류 처리 강화)
        // ============================================

        function handleGroupDragStart(event) {
            try {
                if (!event.target.classList.contains('group-container')) return;
                
                const groupId = event.target.dataset.groupId;
                event.dataTransfer.setData('text/group-id', groupId);
                event.target.classList.add('dragging-group');
                event.dataTransfer.setData('text/drag-type', 'group');
            } catch (error) {
                handleError(error, '그룹 드래그 시작');
            }
        }

        function handleGroupDragEnd(event) {
            try {
                event.target.classList.remove('dragging-group');
                document.querySelectorAll('.group-container').forEach(group => {
                    group.classList.remove('drag-over');
                });
            } catch (error) {
                handleError(error, '그룹 드래그 끝');
            }
        }

        function handleGroupDragOver(event) {
            try {
                event.preventDefault();
                const dragType = event.dataTransfer.types.includes('text/drag-type');
                if (!dragType) return;
                
                const targetGroup = event.target.closest('.group-container');
                if (targetGroup && !targetGroup.classList.contains('dragging-group')) {
                    targetGroup.classList.add('drag-over');
                }
            } catch (error) {
                handleError(error, '그룹 드래그 오버');
            }
        }

        function handleGroupDrop(event) {
            try {
                event.preventDefault();
                const dragType = event.dataTransfer.getData('text/drag-type');
                
                if (dragType === 'group') {
                    const draggedGroupId = event.dataTransfer.getData('text/group-id');
                    const targetGroup = event.target.closest('.group-container');
                    
                    if (targetGroup && targetGroup.dataset.groupId !== draggedGroupId) {
                        const targetGroupId = targetGroup.dataset.groupId;
                        reorderGroups(draggedGroupId, targetGroupId);
                    }
                    
                    targetGroup.classList.remove('drag-over');
                } else {
                    const cardId = event.dataTransfer.getData('text/plain');
                    const targetGroup = event.target.closest('.group-container');
                    const targetGroupId = targetGroup.dataset.groupId;
                    moveCardToGroup(cardId, targetGroupId);
                    targetGroup.classList.remove('drag-over');
                }
            } catch (error) {
                handleError(error, '그룹 드롭');
            }
        }

        function reorderGroups(draggedGroupId, targetGroupId) {
            try {
                const { groups } = appState.sortingData;
                const draggedGroup = groups[draggedGroupId];
                const targetGroup = groups[targetGroupId];
                
                if (!draggedGroup || !targetGroup) return;
                
                const draggedOrder = draggedGroup.order || 0;
                const targetOrder = targetGroup.order || 0;
                
                draggedGroup.order = targetOrder;
                targetGroup.order = draggedOrder;
                
                renderGroups();
                autoSave();
                
                showNotification('✅ 그룹 순서가 변경되었습니다!', 'success');
            } catch (error) {
                handleError(error, '그룹 순서 변경');
            }
        }

        function handleDragStart(event) {
            try {
                if (!event.target.classList.contains('card-item')) return;
                
                const cardId = event.target.dataset.cardId;
                event.dataTransfer.setData('text/plain', cardId);
                event.dataTransfer.setData('text/drag-type', 'card');
                event.target.classList.add('dragging');
            } catch (error) {
                handleError(error, '카드 드래그 시작');
            }
        }

        function handleDragEnd(event) {
            try {
                event.target.classList.remove('dragging');
                document.querySelectorAll('.group-container').forEach(group => {
                    group.classList.remove('drag-over');
                });
                document.querySelectorAll('.card-pool').forEach(pool => {
                    pool.classList.remove('drag-over');
                });
            } catch (error) {
                handleError(error, '카드 드래그 끝');
            }
        }

        function handleDragOver(event) {
            event.preventDefault();
        }

        function handleDragEnter(event) {
            try {
                const targetGroup = event.target.closest('.group-container');
                if (targetGroup) {
                    targetGroup.classList.add('drag-over');
                }
            } catch (error) {
                handleError(error, '드래그 엔터');
            }
        }

        function handleDragLeave(event) {
            try {
                const targetGroup = event.target.closest('.group-container');
                if (targetGroup && !targetGroup.contains(event.relatedTarget)) {
                    targetGroup.classList.remove('drag-over');
                }
            } catch (error) {
                handleError(error, '드래그 리브');
            }
        }

        function handleDrop(event) {
            try {
                event.preventDefault();
                
                const dragType = event.dataTransfer.getData('text/drag-type');
                
                if (dragType === 'card') {
                    const cardId = event.dataTransfer.getData('text/plain');
                    const targetGroup = event.target.closest('.group-container');
                    const targetGroupId = targetGroup.dataset.groupId;
                    moveCardToGroup(cardId, targetGroupId);
                    targetGroup.classList.remove('drag-over');
                }
            } catch (error) {
                handleError(error, '카드 드롭');
            }
        }

        function handleDragEnterPool(event) {
            try {
                event.target.closest('.card-pool').classList.add('drag-over');
            } catch (error) {
                handleError(error, '풀 드래그 엔터');
            }
        }

        function handleDragLeavePool(event) {
            try {
                if (!event.target.closest('.card-pool').contains(event.relatedTarget)) {
                    event.target.closest('.card-pool').classList.remove('drag-over');
                }
            } catch (error) {
                handleError(error, '풀 드래그 리브');
            }
        }

        function handleDropToPool(event) {
            try {
                event.preventDefault();
                const cardId = event.dataTransfer.getData('text/plain');
                const cardPool = event.target.closest('.card-pool');
                moveCardToPool(cardId);
                cardPool.classList.remove('drag-over');
            } catch (error) {
                handleError(error, '풀로 드롭');
            }
        }

        function moveCardToPool(cardId) {
            try {
                const { groups, unassignedCards } = appState.sortingData;
                let card = null;
                
                const alreadyUnassigned = unassignedCards.find(c => c.id === cardId);
                if (alreadyUnassigned) return;
                
                for (const group of Object.values(groups)) {
                    const cardIndex = group.cards.findIndex(c => c.id === cardId);
                    if (cardIndex !== -1) {
                        card = group.cards.splice(cardIndex, 1)[0];
                        break;
                    }
                }
                
                if (card) {
                    unassignedCards.push(card);
                    renderSortingUI();
                    updateProgress();
                    autoSave();
                }
            } catch (error) {
                handleError(error, '카드를 풀로 이동');
            }
        }

        function moveCardToGroup(cardId, targetGroupId) {
            try {
                const { groups, unassignedCards } = appState.sortingData;
                let card = null;
                
                const unassignedIndex = unassignedCards.findIndex(c => c.id === cardId);
                if (unassignedIndex !== -1) {
                    card = unassignedCards.splice(unassignedIndex, 1)[0];
                } else {
                    for (const group of Object.values(groups)) {
                        const cardIndex = group.cards.findIndex(c => c.id === cardId);
                        if (cardIndex !== -1) {
                            card = group.cards.splice(cardIndex, 1)[0];
                            break;
                        }
                    }
                }
                
                if (card && groups[targetGroupId]) {
                    groups[targetGroupId].cards.push(card);
                    renderSortingUI();
                    updateProgress();
                    autoSave();
                }
            } catch (error) {
                handleError(error, '카드를 그룹으로 이동');
            }
        }

        function createNewGroup() {
            try {
                showModal('create-group-modal');
                document.getElementById('new-group-name').focus();
            } catch (error) {
                handleError(error, '새 그룹 생성 모달');
            }
        }

        function showSortingGuide() {
            try {
                showModal('sorting-guide-modal');
            } catch (error) {
                handleError(error, '소팅 가이드 표시');
            }
        }

        function confirmCreateGroup() {
            try {
                const groupName = document.getElementById('new-group-name').value.trim();
                
                if (!groupName) {
                    showNotification('그룹 이름을 입력해주세요.', 'warning');
                    return;
                }
                
                if (groupName.length > 20) {
                    showNotification('그룹 이름은 20자 이내로 입력해주세요.', 'warning');
                    return;
                }
                
                const existingNames = Object.values(appState.sortingData.groups).map(g => g.name);
                if (existingNames.includes(groupName)) {
                    showNotification('이미 존재하는 그룹 이름입니다.', 'warning');
                    return;
                }
                
                const maxOrder = Object.values(appState.sortingData.groups).reduce((max, group) => {
                    return Math.max(max, group.order || 0);
                }, -1);
                
                const newGroupId = `custom-${generateId()}`;
                appState.sortingData.groups[newGroupId] = {
                    id: newGroupId,
                    name: groupName,
                    originalName: groupName,
                    isCustom: true,
                    cards: [],
                    order: maxOrder + 1
                };
                
                renderGroups();
                closeModal('create-group-modal');
                document.getElementById('new-group-name').value = '';
                autoSave();
                
                showNotification('✅ 새 그룹이 생성되었습니다!', 'success');
            } catch (error) {
                handleError(error, '그룹 생성 확인');
            }
        }

        function editGroupName(groupId) {
            try {
                const group = appState.sortingData.groups[groupId];
                if (!group) return;
                
                const allowEdit = appState.currentProject.allowEditGroups;
                if (!allowEdit && !group.isCustom) return;
                
                const newName = prompt('새 그룹 이름을 입력하세요:', group.name);
                if (newName && newName.trim() && newName.trim() !== group.name) {
                    if (newName.trim().length > 20) {
                        showNotification('그룹 이름은 20자 이내로 입력해주세요.', 'warning');
                        return;
                    }
                    
                    const existingNames = Object.values(appState.sortingData.groups)
                        .filter(g => g.id !== groupId)
                        .map(g => g.name);
                    
                    if (existingNames.includes(newName.trim())) {
                        showNotification('이미 존재하는 그룹 이름입니다.', 'warning');
                        return;
                    }
                    
                    if (!group.isCustom && group.originalName !== newName.trim()) {
                        if (!appState.sortingData.modifiedGroupNames.includes(group.originalName)) {
                            appState.sortingData.modifiedGroupNames.push(group.originalName);
                        }
                    }
                    
                    group.name = newName.trim();
                    renderGroups();
                    autoSave();
                    
                    showNotification('✅ 그룹 이름이 변경되었습니다!', 'success');
                }
            } catch (error) {
                handleError(error, '그룹 이름 편집');
            }
        }

        function deleteGroup(groupId) {
            try {
                const group = appState.sortingData.groups[groupId];
                if (!group || !group.isCustom) return;
                
                if (confirm(`'${group.name}' 그룹을 삭제하시겠습니까? 포함된 카드들은 미분류로 이동합니다.`)) {
                    appState.sortingData.unassignedCards.push(...group.cards);
                    delete appState.sortingData.groups[groupId];
                    renderSortingUI();
                    updateProgress();
                    autoSave();
                    
                    showNotification('✅ 그룹이 삭제되었습니다!', 'success');
                }
            } catch (error) {
                handleError(error, '그룹 삭제');
            }
        }

        function updateProgress() {
            try {
                if (!appState.sortingData) return;
                
                const totalCards = appState.currentProject.cards.length;
                const assignedCards = totalCards - appState.sortingData.unassignedCards.length;
                const progress = Math.round((assignedCards / totalCards) * 100);
                
                const progressFill = document.getElementById('progress-fill');
                const progressText = document.getElementById('progress-text');
                
                if (progressFill) {
                    progressFill.style.width = `${progress}%`;
                }
                
                if (progressText) {
                    progressText.textContent = 
                        `${totalCards}개 중 ${assignedCards}개 카드 분류 완료 (${progress}%)`;
                }
                
                const submitBtn = document.getElementById('submit-btn');
                if (submitBtn) {
                    if (assignedCards === totalCards) {
                        submitBtn.disabled = false;
                        submitBtn.textContent = '✅ 응답 제출하기';
                        submitBtn.style.opacity = '1';
                    } else {
                        submitBtn.disabled = false;
                        submitBtn.textContent = `✅ 응답 제출하기 (${totalCards - assignedCards}개 미분류)`;
                        submitBtn.style.opacity = '0.8';
                    }
                }
            } catch (error) {
                handleError(error, '진행률 업데이트');
            }
        }

        function autoSave() {
            try {
                if (!appState.sortingData) return;
                appState.sortingData.lastSaveTime = new Date().toISOString();
                const saved = saveToStorage(`participant_${appState.sortingData.participantId}`, appState.sortingData);
                
                if (!saved) {
                    showNotification('⚠️ 자동 저장에 실패했습니다. 수동으로 저장해주세요.', 'warning');
                }
            } catch (error) {
                handleError(error, '자동 저장');
            }
        }

        function resetAllCards() {
            try {
                if (!confirm('모든 카드를 미분류 상태로 초기화하시겠습니까?')) return;
                
                const { groups } = appState.sortingData;
                Object.values(groups).forEach(group => {
                    appState.sortingData.unassignedCards.push(...group.cards);
                    group.cards = [];
                });
                
                renderSortingUI();
                updateProgress();
                autoSave();
                
                showNotification('✅ 모든 카드가 초기화되었습니다!', 'success');
            } catch (error) {
                handleError(error, '카드 리셋');
            }
        }

        async function submitSorting() {
            try {
                if (!appState.sortingData) return;
                
                const unassignedCount = appState.sortingData.unassignedCards.length;
                
                if (unassignedCount > 0) {
                    if (!confirm(`아직 ${unassignedCount}개의 카드가 분류되지 않았습니다.\n그래도 제출하시겠습니까?`)) {
                        return;
                    }
                }
                
                // 완료 처리
                appState.sortingData.isCompleted = true;
                appState.sortingData.completedTime = getKoreanDateTime();
                appState.sortingData.duration = Math.floor((new Date() - appState.startTime) / 1000);
                
                // 로컬 저장
                autoSave();
                
                // Google Sheets 저장 시도
                try {
                    await saveToGoogleSheets(appState.sortingData, appState.currentProject);
                } catch (error) {
                    console.warn('Google Sheets 저장 실패, 로컬 저장은 완료됨:', error);
                    showNotification('⚠️ 클라우드 저장에 실패했지만 로컬 저장은 완료되었습니다.', 'warning');
                }
                
                // 완료 페이지로 이동
                showCompletionPage();
                
            } catch (error) {
                handleError(error, '응답 제출');
            }
        }

        function showCompletionPage() {
            try {
                showPage('completion-page');
            } catch (error) {
                handleError(error, '완료 페이지 표시');
            }
        }

        // ============================================
        // 데이터 포맷팅 및 내보내기 함수들
        // ============================================

        function formatResponseForExport(responseData, projectConfig) {
            try {
                const groupResults = {};
                const cardDistribution = {};
                const groupOrder = [];
                
                const sortedGroups = Object.values(responseData.groups || {}).sort((a, b) => (a.order || 0) - (b.order || 0));
                
                sortedGroups.forEach(group => {
                    if (group.cards.length > 0) {
                        groupResults[group.name] = group.cards.map(card => card.content);
                        groupOrder.push(group.name);
                        group.cards.forEach(card => {
                            cardDistribution[card.content] = group.name;
                        });
                    }
                });
                
                if (responseData.unassignedCards && responseData.unassignedCards.length > 0) {
                    groupResults['미분류'] = responseData.unassignedCards.map(card => card.content);
                    responseData.unassignedCards.forEach(card => {
                        cardDistribution[card.content] = '미분류';
                    });
                }
                
                const customGroupsCount = Object.values(responseData.groups || {}).filter(g => g.isCustom && g.cards.length > 0).length;
                const usedGroupsCount = Object.keys(groupResults).length;
                
                return {
                    이름: responseData.name || '알 수 없음',
                    휴대폰뒷번호4자리: responseData.phone || '',
                    시작시간: responseData.startTime,
                    완료시간: responseData.completedTime,
                    소요시간: Math.round((responseData.duration || 0) / 60) + '분',
                    소팅방식: responseData.sortingType,
                    참여자가추가한그룹수: customGroupsCount,
                    참여자가분류한그룹수: usedGroupsCount,
                    그룹별결과: groupResults,
                    그룹순서: groupOrder.join(' > ')
                };
            } catch (error) {
                handleError(error, '응답 데이터 포맷팅');
                return {};
            }
        }

        function downloadJSON(data, filename) {
            try {
                const jsonString = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = filename;
                link.style.display = 'none';
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(url);
                
                showNotification('✅ 파일이 다운로드되었습니다!', 'success');
            } catch (error) {
                handleError(error, 'JSON 다운로드');
            }
        }

        // ============================================
        // 이벤트 리스너 및 초기화
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // 이벤트 리스너 등록
                const sortingTypeSelect = document.getElementById('sorting-type');
                if (sortingTypeSelect) {
                    sortingTypeSelect.addEventListener('change', updateSortingTypeVisibility);
                }
                
                const cardListTextarea = document.getElementById('card-list');
                if (cardListTextarea) {
                    cardListTextarea.addEventListener('input', updateCardCount);
                }
                
                const newCardInput = document.getElementById('new-card');
                if (newCardInput) {
                    newCardInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            addNewCard();
                        }
                    });
                }
                
                const newGroupInput = document.getElementById('new-group-name');
                if (newGroupInput) {
                    newGroupInput.addEventListener('keypress', function(e) {
                        if (e.key === 'Enter') {
                            confirmCreateGroup();
                        }
                    });
                }
                
                const phoneInput = document.getElementById('participant-phone');
                if (phoneInput) {
                    phoneInput.addEventListener('input', function(e) {
                        e.target.value = e.target.value.replace(/[^0-9]/g, '');
                    });
                }
                
                const nameInput = document.getElementById('participant-name');
                if (nameInput) {
                    let nameInputTimer;
                    
                    nameInput.addEventListener('input', function(e) {
                        clearTimeout(nameInputTimer);
                        nameInputTimer = setTimeout(() => {
                            const value = e.target.value;
                            const filteredValue = value.replace(/[^가-힣\s]/g, '');
                            if (value !== filteredValue) {
                                e.target.value = filteredValue;
                            }
                        }, 100);
                    });
                    
                    nameInput.addEventListener('compositionend', function(e) {
                        e.target.value = e.target.value.replace(/[^가-힣\s]/g, '');
                    });
                }
                
                // 모달 클릭 이벤트
                document.querySelectorAll('.modal').forEach(modal => {
                    modal.addEventListener('click', function(e) {
                        if (e.target === this) {
                            this.classList.remove('show');
                        }
                    });
                });
                
                // URL 파라미터 처리
                function handleURLParams() {
                    try {
                        const urlParams = new URLSearchParams(window.location.search);
                        const mode = urlParams.get('mode');
                        
                        switch (mode) {
                            case 'admin':
                                showAdminLogin();
                                break;
                            case 'participant':
                                showWelcomePage();
                                break;
                            default:
                                showWelcomePage();
                                break;
                        }
                    } catch (error) {
                        handleError(error, 'URL 파라미터 처리');
                        showWelcomePage();
                    }
                }
                
                handleURLParams();
                
                // 브라우저 이벤트
                window.addEventListener('popstate', handleURLParams);
                
                window.addEventListener('beforeunload', function(e) {
                    if (appState.sortingData && !appState.sortingData.isCompleted) {
                        e.preventDefault();
                        e.returnValue = '진행 중인 카드소팅이 있습니다. 정말 페이지를 떠나시겠습니까?';
                    }
                });
                
                // 초기 설정
                updateSortingTypeVisibility();
                updateCardCount();

                console.log('✅ 롯데홈쇼핑 혜택 매장 카드 분류하기 툴 v4.3 (최적화 버전)이 준비되었습니다.');
                console.log('🎯 새로운 기능: 오류 처리 강화, 성능 최적화, 안정성 개선');
                console.log('🔧 데이터 크기 제한: 카드 50개, 그룹 10개 이하 권장');
                console.log('✨ 완성도 향상: 모든 함수에 오류 처리 추가, 사용자 경험 개선');

            } catch (error) {
                handleError(error, '초기화');
                // 초기화 실패 시에도 기본 페이지는 표시
                showWelcomePage();
            }
        });
    </script>
</body>
</html>
