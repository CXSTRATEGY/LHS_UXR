<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹´ë“œì†ŒíŒ… ë¦¬ì„œì¹˜ íˆ´ - Google Sheets ì—°ë™</title>
    <style>
        /* CSSëŠ” ê¸°ì¡´ê³¼ ë™ì¼í•˜ë¯€ë¡œ ìƒëµ - ê¸°ì¡´ 7ë²ˆ ì•„í‹°íŒ©íŠ¸ì˜ CSS ê·¸ëŒ€ë¡œ ì‚¬ìš© */
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; line-height: 1.6; }
        .container { max-width: 1200px; margin: 0 auto; padding: 20px; min-height: 100vh; }
        .card { background: white; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); overflow: hidden; }
        .page { display: none; animation: fadeIn 0.3s ease-in; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .header { background: white; padding: 20px 30px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; }
        .logo { font-size: 24px; font-weight: bold; color: #333; }
        .nav-buttons { display: flex; gap: 10px; }
        .form-group { margin: 20px 0; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        .form-control { width: 100%; padding: 12px; border: 2px solid #e1e5e9; border-radius: 8px; font-size: 16px; transition: border-color 0.3s; }
        .form-control:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .textarea { min-height: 120px; resize: vertical; font-family: inherit; }
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s; text-decoration: none; display: inline-block; text-align: center; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        .btn-primary:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4); }
        .btn-secondary { background: #f8f9fa; color: #495057; border: 1px solid #dee2e6; }
        .btn-secondary:hover { background: #e9ecef; }
        .btn-danger { background: #e74c3c; color: white; }
        .btn-danger:hover { background: #c0392b; }
        .login-container { display: flex; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; }
        .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.1); width: 100%; max-width: 400px; }
        .login-title { text-align: center; font-size: 28px; font-weight: bold; color: #333; margin-bottom: 10px; }
        .login-subtitle { text-align: center; color: #666; margin-bottom: 30px; }
        .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(350px, 1fr)); gap: 30px; padding: 30px; }
        .admin-section { background: #f8f9fa; padding: 25px; border-radius: 12px; border: 1px solid #e9ecef; }
        .admin-section h3 { color: #333; margin-bottom: 20px; font-size: 20px; }
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin: 20px 0; }
        .stat-card { background: white; padding: 20px; border-radius: 8px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
        .stat-number { font-size: 24px; font-weight: bold; color: #667eea; }
        .stat-label { font-size: 14px; color: #666; margin-top: 5px; }
        .sorting-header { background: white; padding: 20px 30px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; }
        .participant-info h2 { color: #333; font-size: 20px; }
        .participant-info p { color: #666; font-size: 14px; }
        .timer { background: #f8f9fa; padding: 10px 20px; border-radius: 8px; font-size: 18px; font-weight: bold; color: #333; min-width: 100px; text-align: center; }
        .progress-container { width: 100%; margin-top: 15px; }
        .progress-bar { width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease; }
        .progress-text { text-align: center; font-size: 14px; color: #666; margin-top: 5px; }
        .sorting-workspace { display: grid; grid-template-columns: 300px 1fr; gap: 30px; padding: 30px; min-height: calc(100vh - 200px); }
        .card-pool { background: #f8f9fa; border-radius: 12px; padding: 20px; border: 2px dashed #dee2e6; }
        .card-pool h3 { color: #333; margin-bottom: 15px; font-size: 18px; }
        .card-list { max-height: 400px; overflow-y: auto; margin-bottom: 15px; }
        .card-item { background: white; padding: 12px 15px; margin: 8px 0; border-radius: 8px; border: 1px solid #dee2e6; cursor: move; transition: all 0.2s; position: relative; user-select: none; }
        .card-item:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.1); transform: translateY(-2px); }
        .card-item.dragging { opacity: 0.5; transform: rotate(5deg); }
        .card-item::after { content: "â‹®â‹®"; position: absolute; right: 10px; top: 50%; transform: translateY(-50%); color: #adb5bd; font-weight: bold; }
        .groups-area { background: white; }
        .groups-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; max-height: 70vh; overflow-y: auto; padding: 20px; }
        .group-container { background: #f8f9fa; border: 2px dashed #dee2e6; border-radius: 12px; padding: 15px; min-height: 200px; transition: all 0.3s; }
        .group-container.drag-over { border-color: #28a745; background: #f8fff8; transform: scale(1.02); }
        .group-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #dee2e6; }
        .group-title { font-weight: 600; color: #333; flex: 1; }
        .group-title.editable { cursor: pointer; padding: 4px 8px; border-radius: 4px; transition: background 0.2s; }
        .group-title.editable:hover { background: #e9ecef; }
        .group-meta { display: flex; align-items: center; gap: 10px; }
        .card-count { background: #667eea; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; font-weight: 600; }
        .delete-group-btn { background: #e74c3c; color: white; border: none; width: 24px; height: 24px; border-radius: 50%; cursor: pointer; font-size: 14px; display: flex; align-items: center; justify-content: center; }
        .group-content { min-height: 120px; }
        .empty-group { text-align: center; color: #adb5bd; padding: 40px 20px; font-style: italic; }
        .group-content .card-item { margin: 8px 0; }
        .sorting-actions { background: white; padding: 20px 30px; border-top: 1px solid #eee; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; }
        .completion-container { text-align: center; padding: 60px 30px; }
        .completion-message { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 12px; margin-bottom: 40px; }
        .completion-message h2 { font-size: 32px; margin-bottom: 15px; }
        .completion-stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 20px; margin: 30px 0; }
        .hidden { display: none; }
        .text-center { text-align: center; }
        .mt-2 { margin-top: 10px; }
        .mt-3 { margin-top: 15px; }
        .mb-2 { margin-bottom: 10px; }
        .mb-3 { margin-bottom: 15px; }
        .flex { display: flex; }
        .flex-wrap { flex-wrap: wrap; }
        .gap-2 { gap: 10px; }
        .gap-3 { gap: 15px; }
        .justify-center { justify-content: center; }
        .items-center { align-items: center; }
        .w-full { width: 100%; }
        .alert { padding: 12px 16px; border-radius: 8px; margin: 15px 0; border-left: 4px solid; }
        .alert-info { background: #e3f2fd; border-color: #2196f3; color: #1976d2; }
        .alert-warning { background: #fff3e0; border-color: #ff9800; color: #f57c00; }
        .alert-success { background: #e8f5e9; border-color: #4caf50; color: #388e3c; }
        .modal { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center; }
        .modal.show { display: flex; }
        .modal-content { background: white; padding: 30px; border-radius: 12px; max-width: 500px; width: 90%; max-height: 80vh; overflow-y: auto; }
        @media (max-width: 768px) { .sorting-workspace { grid-template-columns: 1fr; gap: 20px; padding: 20px; } .admin-grid { grid-template-columns: 1fr; padding: 20px; } .groups-container { grid-template-columns: 1fr; } .sorting-header { flex-direction: column; text-align: center; } .nav-buttons { flex-direction: column; width: 100%; } }
    </style>
</head>
<body>
    <div class="container">
        <!-- í™ˆí˜ì´ì§€ -->
        <div id="home-page" class="page active">
            <div class="login-container">
                <div class="login-box">
                    <h1 class="login-title">ì¹´ë“œì†ŒíŒ… ë¦¬ì„œì¹˜ íˆ´</h1>
                    <p class="login-subtitle">Google Sheets ì—°ë™ ë²„ì „ (CORS ë¬¸ì œ í•´ê²°ë¨)</p>
                    
                    <div class="flex gap-3" style="flex-direction: column;">
                        <button class="btn btn-primary w-full" onclick="showAdminLogin()">
                            ğŸ”§ ê´€ë¦¬ì ë¡œê·¸ì¸
                        </button>
                        <button class="btn btn-secondary w-full" onclick="showParticipantPage()">
                            ğŸ‘¤ ì‘ë‹µì ì°¸ì—¬
                        </button>
                    </div>

                    <div class="alert alert-success mt-3">
                        <strong>âœ… CORS ë¬¸ì œ í•´ê²°ë¨:</strong><br>
                        â€¢ JSONP ë°©ì‹ìœ¼ë¡œ Google Sheets ì—°ë™ ì•ˆì •í™”<br>
                        â€¢ ëª¨ë“  ë¸Œë¼ìš°ì €ì—ì„œ ì •ìƒ ì‘ë™<br>
                        â€¢ ì‹¤ì‹œê°„ ë°ì´í„° ì €ì¥ ë³´ì¥
                    </div>
                </div>
            </div>
        </div>

        <!-- ê´€ë¦¬ì ë¡œê·¸ì¸ -->
        <div id="admin-login-page" class="page">
            <div class="login-container">
                <div class="login-box">
                    <h1 class="login-title">ê´€ë¦¬ì ë¡œê·¸ì¸</h1>
                    <p class="login-subtitle">ê´€ë¦¬ì ì „ìš© í˜ì´ì§€ì…ë‹ˆë‹¤</p>
                    
                    <form onsubmit="adminLogin(event)">
                        <div class="form-group">
                            <label class="form-label">ê´€ë¦¬ì ë¹„ë°€ë²ˆí˜¸</label>
                            <input 
                                type="password" 
                                id="admin-password" 
                                class="form-control" 
                                placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                required
                            >
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-full">
                            ë¡œê·¸ì¸
                        </button>
                    </form>

                    <div class="text-center mt-3">
                        <button class="btn btn-secondary" onclick="showHomePage()">
                            â† ëŒì•„ê°€ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ -->
        <div id="admin-dashboard-page" class="page">
            <div class="card">
                <div class="header">
                    <div class="logo">ì¹´ë“œì†ŒíŒ… ê´€ë¦¬ì (Google Sheets ì—°ë™)</div>
                    <div class="nav-buttons">
                        <button class="btn btn-secondary" onclick="showHomePage()">í™ˆìœ¼ë¡œ</button>
                        <button class="btn btn-danger" onclick="adminLogout()">ë¡œê·¸ì•„ì›ƒ</button>
                    </div>
                </div>

                <div class="admin-grid">
                    <div class="admin-section">
                        <h3>ğŸ¯ í”„ë¡œì íŠ¸ ì„¤ì •</h3>
                        
                        <div class="form-group">
                            <label class="form-label">í”„ë¡œì íŠ¸ ì œëª©</label>
                            <input 
                                type="text" 
                                id="project-title" 
                                class="form-control" 
                                value="í˜œíƒ ì½˜í…ì¸  ì¹´ë“œì†ŒíŒ…"
                                placeholder="í”„ë¡œì íŠ¸ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”"
                            >
                        </div>

                        <div class="form-group">
                            <label class="form-label">ì†ŒíŒ… ë°©ì‹</label>
                            <select id="sorting-type" class="form-control">
                                <option value="open">ì˜¤í”ˆ ì†ŒíŒ… (ê·¸ë£¹ ììœ  ìƒì„±)</option>
                                <option value="closed">í´ë¡œì¦ˆë“œ ì†ŒíŒ… (ê³ ì • ê·¸ë£¹ë§Œ)</option>
                                <option value="hybrid" selected>í•˜ì´ë¸Œë¦¬ë“œ ì†ŒíŒ… (ê¸°ë³¸ + ì‚¬ìš©ì ìƒì„±)</option>
                            </select>
                        </div>

                        <div class="form-group" id="predefined-groups-section">
                            <label class="form-label">ê¸°ë³¸ ê·¸ë£¹ (í´ë¡œì¦ˆë“œ/í•˜ì´ë¸Œë¦¬ë“œ ì „ìš©)</label>
                            <textarea 
                                id="predefined-groups" 
                                class="form-control textarea" 
                                placeholder="í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ì„¸ìš”"
                            >êµ¬ë§¤í˜œíƒ
ì°¸ì—¬í˜œíƒ
ì¹´ë“œ/ê²°ì œí˜œíƒ</textarea>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>ğŸƒ ì¹´ë“œ ëª©ë¡ ê´€ë¦¬</h3>
                        
                        <div class="form-group">
                            <label class="form-label">ì¹´ë“œ ëª©ë¡ (ìµœëŒ€ 100ê°œ)</label>
                            <textarea 
                                id="card-list" 
                                class="form-control textarea" 
                                placeholder="í•œ ì¤„ì— í•˜ë‚˜ì”© ì…ë ¥í•˜ì„¸ìš”"
                                style="min-height: 200px;"
                            >ë°©ì†¡ ì•Œë¦¼ ì‹ ì²­í•˜ê³  ì ë¦½ê¸ˆ ë°›ê¸°
ë©¤ë²„ì‹­ ê°€ì…í•˜ê³  í• ì¸ ì¿ í° ë°›ê¸°
ë°©ì†¡ ì±„íŒ… ë‚¨ê¸°ê³  ì ë¦½ê¸ˆ ë°›ê¸°
ì¹œêµ¬ ì¶”ì²œí•˜ê³  í¬ì¸íŠ¸ ë°›ê¸°
ì²« êµ¬ë§¤ í›„ ìºì‹œë°± ë°›ê¸°
ë¦¬ë·° ì‘ì„±í•˜ê³  ì ë¦½ê¸ˆ ë°›ê¸°
ìƒì¼ ì¿ í° ë°›ê¸°
ë“±ê¸‰ë³„ í• ì¸ í˜œíƒ
ë¬´ë£Œë°°ì†¡ í˜œíƒ
ì ë¦½ê¸ˆ í˜œíƒ</textarea>
                        </div>

                        <div class="flex gap-2">
                            <input 
                                type="text" 
                                id="new-card" 
                                class="form-control" 
                                placeholder="ìƒˆ ì¹´ë“œ ì¶”ê°€"
                                style="flex: 1;"
                            >
                            <button class="btn btn-secondary" onclick="addNewCard()">ì¶”ê°€</button>
                        </div>

                        <div class="alert alert-info mt-2">
                            <strong>í˜„ì¬ ì¹´ë“œ ìˆ˜:</strong> <span id="card-count">10</span>ê°œ
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>ğŸ”— Google Sheets ì„¤ì •</h3>
                        
                        <div class="form-group">
                            <label class="form-label">ì›¹ì•± URL</label>
                            <input 
                                type="text" 
                                id="webapp-url" 
                                class="form-control" 
                                placeholder="ìƒˆë¡œìš´ Google Apps Script ì›¹ì•± URLì„ ì…ë ¥í•˜ì„¸ìš”"
                                value="ì—¬ê¸°ì—_ìƒˆë¡œìš´_ì›¹ì•±_URL_ì…ë ¥"
                            >
                        </div>

                        <div class="form-group">
                            <label class="form-label">ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID</label>
                            <input 
                                type="text" 
                                id="spreadsheet-id" 
                                class="form-control" 
                                placeholder="Google ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”"
                                value="ì—¬ê¸°ì—_ìŠ¤í”„ë ˆë“œì‹œíŠ¸_ID_ì…ë ¥"
                            >
                        </div>

                        <button class="btn btn-primary w-full mb-3" onclick="testConnection()">
                            ğŸ”— ì—°ê²° í…ŒìŠ¤íŠ¸
                        </button>

                        <div id="connection-status" class="alert alert-info">
                            <strong>ì—°ê²° ìƒíƒœ:</strong> í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•´ì£¼ì„¸ìš”
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>ğŸ”— ì‘ë‹µì URL ìƒì„±</h3>
                        
                        <button class="btn btn-primary w-full mb-3" onclick="generateURL()">
                            í”„ë¡œì íŠ¸ ì €ì¥ ë° URL ìƒì„±
                        </button>

                        <div id="generated-url-section" class="hidden">
                            <div class="form-group">
                                <label class="form-label">ìƒì„±ëœ ì‘ë‹µì URL</label>
                                <div style="position: relative;">
                                    <input 
                                        type="text" 
                                        id="generated-url" 
                                        class="form-control" 
                                        readonly
                                        style="padding-right: 60px;"
                                    >
                                    <button 
                                        class="btn btn-secondary" 
                                        onclick="copyURL()"
                                        style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); padding: 5px 10px; font-size: 12px;"
                                    >
                                        ë³µì‚¬
                                    </button>
                                </div>
                            </div>

                            <div class="flex gap-2 mt-2">
                                <button class="btn btn-secondary" onclick="showParticipantPage()">ğŸ‘¤ ì‘ë‹µì í˜ì´ì§€</button>
                                <button class="btn btn-secondary" onclick="openGoogleSheets()">ğŸ“Š Google Sheets ì—´ê¸°</button>
                            </div>
                        </div>
                    </div>

                    <div class="admin-section">
                        <h3>ğŸ“Š ì‘ë‹µ í˜„í™©</h3>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="total-responses">0</div>
                                <div class="stat-label">ì´ ì‘ë‹µ ìˆ˜</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="completed-responses">0</div>
                                <div class="stat-label">ì™„ë£Œëœ ì‘ë‹µ</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="ongoing-responses">0</div>
                                <div class="stat-label">ì§„í–‰ ì¤‘</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="avg-duration">0ë¶„</div>
                                <div class="stat-label">í‰ê·  ì†Œìš”ì‹œê°„</div>
                            </div>
                        </div>

                        <div class="flex gap-2 mt-3">
                            <button class="btn btn-primary" onclick="downloadAllResponses()" style="flex: 1;">
                                ğŸ“¥ JSON ë‹¤ìš´ë¡œë“œ
                            </button>
                            <button class="btn btn-secondary" onclick="openGoogleSheets()">
                                ğŸ“Š Google Sheets
                            </button>
                            <button class="btn btn-secondary" onclick="clearAllData()">
                                ğŸ—‘ï¸ ì´ˆê¸°í™”
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì‘ë‹µì ë¡œê·¸ì¸ -->
        <div id="participant-page" class="page">
            <div class="login-container">
                <div class="login-box">
                    <h1 class="login-title" id="participant-project-title">ì¹´ë“œì†ŒíŒ… ì°¸ì—¬</h1>
                    <p class="login-subtitle">ì‘ë‹µì ì •ë³´ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”</p>
                    
                    <form onsubmit="participantLogin(event)">
                        <div class="form-group">
                            <label class="form-label">ì´ë¦„</label>
                            <input 
                                type="text" 
                                id="participant-name" 
                                class="form-control" 
                                placeholder="í™ê¸¸ë™"
                                required
                            >
                        </div>

                        <div class="form-group">
                            <label class="form-label">ìƒë…„ì›”ì¼ (6ìë¦¬)</label>
                            <input 
                                type="text" 
                                id="participant-birth" 
                                class="form-control" 
                                placeholder="900101"
                                maxlength="6"
                                pattern="[0-9]{6}"
                                required
                            >
                            <small style="color: #666;">ì˜ˆ: 1990ë…„ 1ì›” 1ì¼ â†’ 900101</small>
                        </div>
                        
                        <button type="submit" class="btn btn-primary w-full">
                            ì‹œì‘í•˜ê¸°
                        </button>
                    </form>

                    <div id="existing-response-notice" class="alert alert-warning mt-3 hidden">
                        <strong>âš ï¸ ê¸°ì¡´ ì‘ë‹µ ë°œê²¬</strong><br>
                        ì´ì „ì— ì§„í–‰í•˜ë˜ ì‘ë‹µì´ ìˆìŠµë‹ˆë‹¤. ì´ì–´ì„œ ì§„í–‰í•˜ì‹œê² ìŠµë‹ˆê¹Œ?
                        <div class="flex gap-2 mt-2">
                            <button class="btn btn-secondary" onclick="continueExisting()">ì´ì–´ì„œ í•˜ê¸°</button>
                            <button class="btn btn-danger" onclick="startNew()">ìƒˆë¡œ ì‹œì‘</button>
                        </div>
                    </div>

                    <div class="alert alert-success mt-3">
                        <strong>ğŸ“‹ ì°¸ì—¬ ì•ˆë‚´:</strong><br>
                        â€¢ ì˜ˆìƒ ì†Œìš”ì‹œê°„: 10-15ë¶„<br>
                        â€¢ ë¸Œë¼ìš°ì €ë¥¼ ë‹«ì•„ë„ ë‚˜ì¤‘ì— ì´ì–´ì„œ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤<br>
                        â€¢ ì™„ë£Œ ì‹œ Google Sheetsì— ìë™ ì €ì¥ë©ë‹ˆë‹¤ (CORS ë¬¸ì œ í•´ê²°ë¨)
                    </div>

                    <div class="text-center mt-3">
                        <button class="btn btn-secondary" onclick="showHomePage()">
                            â† ëŒì•„ê°€ê¸°
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- ì¹´ë“œì†ŒíŒ… ë©”ì¸ í™”ë©´ - ê¸°ì¡´ê³¼ ë™ì¼ -->
        <div id="sorting-page" class="page">
            <div class="card">
                <div class="sorting-header">
                    <div class="participant-info">
                        <h2 id="sorting-participant-name">ì°¸ì—¬ìë‹˜ì˜ ì¹´ë“œì†ŒíŒ…</h2>
                        <p id="sorting-type-info">í•˜ì´ë¸Œë¦¬ë“œ ì†ŒíŒ… ì§„í–‰ ì¤‘</p>
                    </div>
                    <div class="timer" id="timer">00:00</div>
                </div>

                <div class="progress-container" style="padding: 0 30px;">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%;"></div>
                    </div>
                    <div class="progress-text" id="progress-text">
                        ì§„í–‰ ìƒí™©ì„ í™•ì¸í•˜ì„¸ìš”
                    </div>
                </div>

                <div class="sorting-workspace">
                    <div class="card-pool">
                        <h3>ğŸƒ ë¯¸ë¶„ë¥˜ ì¹´ë“œ (<span id="unassigned-count">0</span>ê°œ)</h3>
                        <div class="card-list" id="card-pool"></div>
                        
                        <button 
                            class="btn btn-secondary w-full" 
                            id="create-group-btn" 
                            onclick="createNewGroup()"
                        >
                            â• ìƒˆ ê·¸ë£¹ ë§Œë“¤ê¸°
                        </button>
                    </div>

                    <div class="groups-area">
                        <div class="groups-container" id="groups-container"></div>
                    </div>
                </div>

                <div class="sorting-actions">
                    <button class="btn btn-secondary" onclick="resetAllCards()">
                        ğŸ”„ ì „ì²´ ì´ˆê¸°í™”
                    </button>
                    <button class="btn btn-secondary" onclick="autoSave()">
                        ğŸ’¾ ì„ì‹œ ì €ì¥
                    </button>
                    <button class="btn btn-primary" onclick="submitSorting()" id="submit-btn">
                        âœ… ì™„ë£Œ í›„ ì œì¶œ
                    </button>
                </div>
            </div>
        </div>

        <!-- ì™„ë£Œ í™”ë©´ -->
        <div id="completion-page" class="page">
            <div class="card">
                <div class="completion-container">
                    <div class="completion-message">
                        <h2>ğŸ‰ ì¹´ë“œì†ŒíŒ…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!</h2>
                        <p>ì†Œì¤‘í•œ ì˜ê²¬ì„ ì£¼ì…”ì„œ ê°ì‚¬í•©ë‹ˆë‹¤.<br>ì‘ë‹µì´ Google Sheetsì— ìë™ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                    </div>

                    <div class="completion-stats" id="completion-stats">
                        <!-- ì™„ë£Œ í†µê³„ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>

                    <div class="flex gap-3 justify-center mt-3">
                        <button class="btn btn-primary" onclick="downloadMyResponse()">
                            ğŸ“¥ ë‚´ ì‘ë‹µ ë‹¤ìš´ë¡œë“œ
                        </button>
                        <button class="btn btn-secondary" onclick="showHomePage()">
                            ğŸ  í™ˆìœ¼ë¡œ
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ìƒˆ ê·¸ë£¹ ìƒì„± ëª¨ë‹¬ -->
    <div id="create-group-modal" class="modal">
        <div class="modal-content">
            <h3>ìƒˆ ê·¸ë£¹ ë§Œë“¤ê¸°</h3>
            <div class="form-group">
                <label class="form-label">ê·¸ë£¹ ì´ë¦„</label>
                <input 
                    type="text" 
                    id="new-group-name" 
                    class="form-control" 
                    placeholder="ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”"
                    maxlength="50"
                >
            </div>
            <div class="flex gap-2 justify-center">
                <button class="btn btn-secondary" onclick="closeModal('create-group-modal')">ì·¨ì†Œ</button>
                <button class="btn btn-primary" onclick="confirmCreateGroup()">ìƒì„±</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // ğŸ”— Google Sheets ì—°ë™ ì„¤ì • (CORS ìš°íšŒ ë²„ì „)
        // ============================================
        
        let GOOGLE_APPS_SCRIPT_URL = 'ì—¬ê¸°ì—_ìƒˆë¡œìš´_ì›¹ì•±_URL_ì…ë ¥';
        let SPREADSHEET_ID = 'ì—¬ê¸°ì—_ìŠ¤í”„ë ˆë“œì‹œíŠ¸_ID_ì…ë ¥';

        // ============================================
        // ğŸ”— CORS ìš°íšŒ Google Sheets ì—°ë™ í•¨ìˆ˜ë“¤
        // ============================================

        /**
         * JSONP ë°©ì‹ìœ¼ë¡œ Google Sheetsì— ë°ì´í„° ì €ì¥ (CORS ìš°íšŒ)
         */
        async function saveToGoogleSheets(responseData, projectConfig) {
            return new Promise((resolve, reject) => {
                try {
                    console.log('ğŸ”— Google Sheets ì €ì¥ ì‹œì‘ (JSONP ë°©ì‹)...');
                    
                    // ë°ì´í„° í¬ë§·íŒ…
                    const exportData = formatResponseForExport(responseData, projectConfig);
                    
                    // ì½œë°± í•¨ìˆ˜ëª… ìƒì„±
                    const callbackName = 'jsonp_callback_' + Date.now() + '_' + Math.random().toString(36).substr(2, 5);
                    
                    // ì „ì—­ ì½œë°± í•¨ìˆ˜ ë“±ë¡
                    window[callbackName] = function(response) {
                        // ì½œë°± ì‹¤í–‰ í›„ ì •ë¦¬
                        delete window[callbackName];
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                        
                        console.log('ğŸ“Š Google Sheets ì‘ë‹µ:', response);
                        
                        if (response.status === 'success') {
                            showNotification('âœ… Google Sheetsì— ì„±ê³µì ìœ¼ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
                            resolve(response);
                        } else {
                            reject(new Error(response.message || 'ì €ì¥ ì‹¤íŒ¨'));
                        }
                    };
                    
                    // URL êµ¬ì„±
                    const params = new URLSearchParams({
                        action: 'save',
                        data: JSON.stringify(exportData),
                        callback: callbackName
                    });
                    
                    const url = `${GOOGLE_APPS_SCRIPT_URL}?${params.toString()}`;
                    
                    // ë™ì  ìŠ¤í¬ë¦½íŠ¸ íƒœê·¸ ìƒì„± (JSONP)
                    const script = document.createElement('script');
                    script.src = url;
                    script.onerror = function() {
                        delete window[callbackName];
                        if (document.head.contains(script)) {
                            document.head.removeChild(script);
                        }
                        reject(new Error('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜: ìŠ¤í¬ë¦½íŠ¸ ë¡œë“œ ì‹¤íŒ¨'));
                    };
                    
                    // íƒ€ì„ì•„ì›ƒ ì„¤ì • (15ì´ˆ)
                    setTimeout(() => {
                        if (window[callbackName]) {
                            delete window[callbackName];
                            if (document.head.contains(script)) {
                                document.head.removeChild(script);
                            }
                            reject(new Error('íƒ€ì„ì•„ì›ƒ: ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.'));
                        }
                    }, 15000);
                    
                    document.head.appendChild(script);
                    
                } catch (error) {
                    console.error('âŒ Google Sheets ì €ì¥ ì‹¤íŒ¨:', error);
                    reject(error);
                }
            });
        }

        /**
         * ì—°ê²° í…ŒìŠ¤íŠ¸ í•¨ìˆ˜
         */
        async function testConnection() {
            const webappUrl = document.getElementById('webapp-url').value.trim();
            const spreadsheetId = document.getElementById('spreadsheet-id').value.trim();
            
            if (!webappUrl || webappUrl === 'ì—¬ê¸°ì—_ìƒˆë¡œìš´_ì›¹ì•±_URL_ì…ë ¥') {
                showNotification('ì›¹ì•± URLì„ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            // ì„ì‹œë¡œ URL ì„¤ì •
            GOOGLE_APPS_SCRIPT_URL = webappUrl;
            SPREADSHEET_ID = spreadsheetId;
            
            const statusDiv = document.getElementById('connection-status');
            statusDiv.innerHTML = '<strong>ì—°ê²° ìƒíƒœ:</strong> í…ŒìŠ¤íŠ¸ ì¤‘...';
            statusDiv.className = 'alert alert-info';
            
            try {
                // í…ŒìŠ¤íŠ¸ ë°ì´í„° ìƒì„±
                const testData = {
                    participantInfo: {
                        participantId: 'connection_test_' + Date.now(),
                        name: 'ì—°ê²° í…ŒìŠ¤íŠ¸',
                        birth: '000000'
                    },
                    timeInfo: {
                        startTime: new Date().toISOString(),
                        completedTime: new Date().toISOString(),
                        durationMinutes: 0
                    },
                    sortingResults: {
                        sortingType: 'connection_test',
                        totalCards: 1,
                        assignedCards: 1,
                        totalGroups: 1,
                        groupResults: {
                            'í…ŒìŠ¤íŠ¸ê·¸ë£¹': ['ì—°ê²° í…ŒìŠ¤íŠ¸ ì¹´ë“œ']
                        }
                    },
                    projectInfo: {
                        projectTitle: 'ì—°ê²° í…ŒìŠ¤íŠ¸',
                        sortingType: 'connection_test'
                    }
                };
                
                const result = await saveToGoogleSheets(testData, { title: 'ì—°ê²° í…ŒìŠ¤íŠ¸', cards: ['í…ŒìŠ¤íŠ¸ ì¹´ë“œ'] });
                
                statusDiv.innerHTML = 'âœ… <strong>ì—°ê²° ì„±ê³µ!</strong> Google Sheetsì™€ ì •ìƒ ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤.';
                statusDiv.className = 'alert alert-success';
                
                // ì„¤ì • ì €ì¥
                localStorage.setItem('google_sheets_config', JSON.stringify({
                    webappUrl: webappUrl,
                    spreadsheetId: spreadsheetId
                }));
                
            } catch (error) {
                console.error('ì—°ê²° í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨:', error);
                statusDiv.innerHTML = `âŒ <strong>ì—°ê²° ì‹¤íŒ¨:</strong> ${error.message}`;
                statusDiv.className = 'alert alert-warning';
            }
        }

        /**
         * Google Sheets ì—´ê¸°
         */
        function openGoogleSheets() {
            const spreadsheetId = document.getElementById('spreadsheet-id').value.trim();
            if (spreadsheetId && spreadsheetId !== 'ì—¬ê¸°ì—_ìŠ¤í”„ë ˆë“œì‹œíŠ¸_ID_ì…ë ¥') {
                const sheetsUrl = `https://docs.google.com/spreadsheets/d/${spreadsheetId}/edit`;
                window.open(sheetsUrl, '_blank');
            } else {
                showNotification('âš ï¸ ìŠ¤í”„ë ˆë“œì‹œíŠ¸ IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.', 'warning');
            }
        }

        /**
         * ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
         */
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                max-width: 400px;
                padding: 15px 20px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                font-weight: 500;
                animation: slideIn 0.3s ease-out;
            `;
            
            const colors = {
                success: { bg: '#d4edda', border: '#28a745', text: '#155724' },
                warning: { bg: '#fff3cd', border: '#ffc107', text: '#856404' },
                error: { bg: '#f8d7da', border: '#dc3545', text: '#721c24' },
                info: { bg: '#d1ecf1', border: '#17a2b8', text: '#0c5460' }
            };
            
            const color = colors[type] || colors.info;
            notification.style.backgroundColor = color.bg;
            notification.style.borderLeft = `4px solid ${color.border}`;
            notification.style.color = color.text;
            
            notification.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center;">
                    <span>${message}</span>
                    <button onclick="this.parentElement.parentElement.remove()" 
                            style="background: none; border: none; font-size: 18px; cursor: pointer; color: ${color.text}; margin-left: 10px;">Ã—</button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }

        // ============================================
        // ì „ì—­ ë³€ìˆ˜ ë° ìƒíƒœ ê´€ë¦¬
        // ============================================
        
        let appState = {
            currentUser: null,
            currentProject: null,
            currentParticipant: null,
            sortingData: null,
            timer: null,
            startTime: null
        };

        const DEFAULT_PROJECT = {
            id: 'default-project',
            title: 'í˜œíƒ ì½˜í…ì¸  ì¹´ë“œì†ŒíŒ…',
            cards: [
                'ë°©ì†¡ ì•Œë¦¼ ì‹ ì²­í•˜ê³  ì ë¦½ê¸ˆ ë°›ê¸°',
                'ë©¤ë²„ì‹­ ê°€ì…í•˜ê³  í• ì¸ ì¿ í° ë°›ê¸°', 
                'ë°©ì†¡ ì±„íŒ… ë‚¨ê¸°ê³  ì ë¦½ê¸ˆ ë°›ê¸°',
                'ì¹œêµ¬ ì¶”ì²œí•˜ê³  í¬ì¸íŠ¸ ë°›ê¸°',
                'ì²« êµ¬ë§¤ í›„ ìºì‹œë°± ë°›ê¸°',
                'ë¦¬ë·° ì‘ì„±í•˜ê³  ì ë¦½ê¸ˆ ë°›ê¸°',
                'ìƒì¼ ì¿ í° ë°›ê¸°',
                'ë“±ê¸‰ë³„ í• ì¸ í˜œíƒ',
                'ë¬´ë£Œë°°ì†¡ í˜œíƒ',
                'ì ë¦½ê¸ˆ í˜œíƒ'
            ],
            sortingType: 'hybrid',
            predefinedGroups: ['êµ¬ë§¤í˜œíƒ', 'ì°¸ì—¬í˜œíƒ', 'ì¹´ë“œ/ê²°ì œí˜œíƒ'],
            createdAt: new Date().toISOString()
        };

        // ============================================
        // í•µì‹¬ í•¨ìˆ˜ë“¤ (Google Sheets ì—°ë™ í¬í•¨)
        // ============================================

        /**
         * ì†ŒíŒ… ì œì¶œ (Google Sheets ì—°ë™ í¬í•¨)
         */
        async function submitSorting() {
            if (!appState.sortingData) return;
            
            const unassignedCount = appState.sortingData.unassignedCards.length;
            if (unassignedCount > 0) {
                if (!confirm(`${unassignedCount}ê°œì˜ ì¹´ë“œê°€ ì•„ì§ ë¶„ë¥˜ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê·¸ë˜ë„ ì œì¶œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
                    return;
                }
            }
            
            // ì œì¶œ ë²„íŠ¼ ë¹„í™œì„±í™”
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.textContent;
            submitBtn.disabled = true;
            submitBtn.textContent = 'ğŸ“¤ ì œì¶œ ì¤‘...';
            
            try {
                // ì™„ë£Œ ì²˜ë¦¬
                appState.sortingData.isCompleted = true;
                appState.sortingData.completedTime = new Date().toISOString();
                appState.sortingData.duration = Math.floor((new Date() - appState.startTime) / 1000);
                
                // ë¡œì»¬ ì €ì¥
                saveToStorage(`participant_${appState.sortingData.participantId}`, appState.sortingData);
                
                // Google Sheets ì €ì¥ ì‹œë„
                try {
                    await saveToGoogleSheets(appState.sortingData, appState.currentProject);
                } catch (error) {
                    console.warn('Google Sheets ì €ì¥ ì‹¤íŒ¨, ë¡œì»¬ ì €ì¥ì€ ì™„ë£Œë¨:', error);
                    showNotification('âš ï¸ Google Sheets ì €ì¥ ì‹¤íŒ¨. ë¡œì»¬ ì €ì¥ì€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.', 'warning');
                }
                
                stopTimer();
                showCompletionPage();
                
            } catch (error) {
                console.error('ì œì¶œ ì¤‘ ì˜¤ë¥˜:', error);
                showNotification('ì œì¶œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.', 'error');
                
                // ë²„íŠ¼ ë³µì›
                submitBtn.disabled = false;
                submitBtn.textContent = originalText;
            }
        }

        // ============================================
        // ê¸°ë³¸ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë“¤
        // ============================================

        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                return false;
            }
        }

        function loadFromStorage(key, defaultValue = null) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : defaultValue;
            } catch (error) {
                console.error('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨:', error);
                return defaultValue;
            }
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2, 9);
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        function showModal(modalId) {
            document.getElementById(modalId).classList.add('show');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
        }

        function showHomePage() {
            showPage('home-page');
            stopTimer();
        }

        function showAdminLogin() {
            showPage('admin-login-page');
        }

        function showParticipantPage() {
            const project = loadFromStorage('current_project', DEFAULT_PROJECT);
            document.getElementById('participant-project-title').textContent = project.title;
            showPage('participant-page');
        }

        function adminLogin(event) {
            event.preventDefault();
            const password = document.getElementById('admin-password').value;
            if (password === 'LHLH') {
                appState.currentUser = { role: 'admin' };
                showPage('admin-dashboard-page');
                loadAdminData();
                updateResponseStats();
            } else {
                showNotification('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
            }
        }

        function adminLogout() {
            appState.currentUser = null;
            showHomePage();
        }

        function loadAdminData() {
            const project = loadFromStorage('current_project', DEFAULT_PROJECT);
            document.getElementById('project-title').value = project.title;
            document.getElementById('sorting-type').value = project.sortingType;
            document.getElementById('predefined-groups').value = project.predefinedGroups.join('\n');
            document.getElementById('card-list').value = project.cards.join('\n');
            updateCardCount();
            updateSortingTypeVisibility();
            
            // Google Sheets ì„¤ì • ë¡œë“œ
            const config = loadFromStorage('google_sheets_config');
            if (config) {
                document.getElementById('webapp-url').value = config.webappUrl || '';
                document.getElementById('spreadsheet-id').value = config.spreadsheetId || '';
                GOOGLE_APPS_SCRIPT_URL = config.webappUrl || '';
                SPREADSHEET_ID = config.spreadsheetId || '';
            }
        }

        function addNewCard() {
            const newCard = document.getElementById('new-card').value.trim();
            if (!newCard) return;
            const cardList = document.getElementById('card-list');
            const currentCards = cardList.value.trim();
            if (currentCards) {
                cardList.value = currentCards + '\n' + newCard;
            } else {
                cardList.value = newCard;
            }
            document.getElementById('new-card').value = '';
            updateCardCount();
        }

        function updateCardCount() {
            const cards = document.getElementById('card-list').value.trim().split('\n').filter(card => card.trim());
            document.getElementById('card-count').textContent = cards.length;
        }

        function updateSortingTypeVisibility() {
            const sortingType = document.getElementById('sorting-type').value;
            const groupsSection = document.getElementById('predefined-groups-section');
            if (sortingType === 'open') {
                groupsSection.style.display = 'none';
            } else {
                groupsSection.style.display = 'block';
            }
        }

        function generateURL() {
            // Google Sheets ì„¤ì • ì €ì¥
            const webappUrl = document.getElementById('webapp-url').value.trim();
            const spreadsheetId = document.getElementById('spreadsheet-id').value.trim();
            
            if (webappUrl && webappUrl !== 'ì—¬ê¸°ì—_ìƒˆë¡œìš´_ì›¹ì•±_URL_ì…ë ¥') {
                GOOGLE_APPS_SCRIPT_URL = webappUrl;
                SPREADSHEET_ID = spreadsheetId;
                
                localStorage.setItem('google_sheets_config', JSON.stringify({
                    webappUrl: webappUrl,
                    spreadsheetId: spreadsheetId
                }));
            }

            const project = {
                id: generateId(),
                title: document.getElementById('project-title').value.trim(),
                sortingType: document.getElementById('sorting-type').value,
                predefinedGroups: document.getElementById('predefined-groups').value.trim().split('\n').filter(g => g.trim()),
                cards: document.getElementById('card-list').value.trim().split('\n').filter(c => c.trim()),
                createdAt: new Date().toISOString()
            };

            if (!project.title || project.cards.length === 0) {
                showNotification('í”„ë¡œì íŠ¸ ì œëª©ê³¼ ì¹´ë“œ ëª©ë¡ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            if (project.cards.length > 100) {
                showNotification('ì¹´ë“œëŠ” ìµœëŒ€ 100ê°œê¹Œì§€ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.', 'warning');
                return;
            }

            saveToStorage('current_project', project);
            appState.currentProject = project;

            const baseURL = window.location.origin + window.location.pathname;
            const projectURL = `${baseURL}#participant`;
            
            document.getElementById('generated-url').value = projectURL;
            document.getElementById('generated-url-section').classList.remove('hidden');

            showNotification('í”„ë¡œì íŠ¸ê°€ ì €ì¥ë˜ê³  URLì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }

        function copyURL() {
            const urlInput = document.getElementById('generated-url');
            urlInput.select();
            document.execCommand('copy');
            showNotification('URLì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
        }

        function updateResponseStats() {
            const responses = getAllResponses();
            const completed = responses.filter(r => r.isCompleted);
            const ongoing = responses.filter(r => !r.isCompleted);
            
            const avgDuration = completed.length > 0 
                ? Math.round(completed.reduce((sum, r) => sum + (r.duration || 0), 0) / completed.length / 60)
                : 0;

            document.getElementById('total-responses').textContent = responses.length;
            document.getElementById('completed-responses').textContent = completed.length;
            document.getElementById('ongoing-responses').textContent = ongoing.length;
            document.getElementById('avg-duration').textContent = avgDuration + 'ë¶„';
        }

        function getAllResponses() {
            const responses = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key && key.startsWith('participant_')) {
                    const data = loadFromStorage(key);
                    if (data) responses.push(data);
                }
            }
            return responses;
        }

        function downloadAllResponses() {
            const responses = getAllResponses();
            if (responses.length === 0) {
                showNotification('ë‹¤ìš´ë¡œë“œí•  ì‘ë‹µì´ ì—†ìŠµë‹ˆë‹¤.', 'warning');
                return;
            }

            const project = loadFromStorage('current_project', DEFAULT_PROJECT);
            const exportData = {
                projectInfo: project,
                exportDate: new Date().toISOString(),
                totalResponses: responses.length,
                responses: responses.map(r => formatResponseForExport(r, project))
            };

            downloadJSON(exportData, `ì¹´ë“œì†ŒíŒ…_ì „ì²´ì‘ë‹µ_${project.title}_${new Date().toISOString().split('T')[0]}.json`);
        }

        function clearAllData() {
            if (confirm('ëª¨ë“  ì‘ë‹µ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.')) {
                for (let i = localStorage.length - 1; i >= 0; i--) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith('participant_')) {
                        localStorage.removeItem(key);
                    }
                }
                updateResponseStats();
                showNotification('ëª¨ë“  ì‘ë‹µ ë°ì´í„°ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            }
        }

        function participantLogin(event) {
            event.preventDefault();
            const name = document.getElementById('participant-name').value.trim();
            const birth = document.getElementById('participant-birth').value.trim();
            
            if (!name || !birth || birth.length !== 6) {
                showNotification('ì´ë¦„ê³¼ ìƒë…„ì›”ì¼ì„ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }

            const participantId = `${name}_${birth}`;
            const existingData = loadFromStorage(`participant_${participantId}`);
            
            if (existingData && !existingData.isCompleted) {
                appState.currentParticipant = { name, birth, id: participantId };
                document.getElementById('existing-response-notice').classList.remove('hidden');
                return;
            }

            startNewSorting(name, birth, participantId);
        }

        function continueExisting() {
            const { name, birth, id } = appState.currentParticipant;
            const existingData = loadFromStorage(`participant_${id}`);
            appState.sortingData = existingData;
            appState.startTime = new Date(existingData.startTime);
            startSortingPage();
        }

        function startNew() {
            const { name, birth, id } = appState.currentParticipant;
            startNewSorting(name, birth, id);
        }

        function startNewSorting(name, birth, participantId) {
            const project = loadFromStorage('current_project', DEFAULT_PROJECT);
            appState.currentParticipant = { name, birth, id: participantId };
            appState.currentProject = project;
            appState.startTime = new Date();
            
            appState.sortingData = {
                participantId,
                name,
                birth,
                startTime: appState.startTime.toISOString(),
                lastSaveTime: appState.startTime.toISOString(),
                completedTime: null,
                duration: 0,
                isCompleted: false,
                sortingType: project.sortingType,
                groups: initializeGroups(project),
                unassignedCards: project.cards.map((card, index) => ({
                    id: `card-${index}`,
                    content: card,
                    originalIndex: index
                }))
            };

            startSortingPage();
        }

        function initializeGroups(project) {
            const groups = {};
            if (project.sortingType !== 'open') {
                project.predefinedGroups.forEach((groupName, index) => {
                    groups[`group-${index}`] = {
                        id: `group-${index}`,
                        name: groupName,
                        isCustom: false,
                        cards: []
                    };
                });
            }
            return groups;
        }

        function startSortingPage() {
            showPage('sorting-page');
            const { name } = appState.currentParticipant;
            const { sortingType } = appState.currentProject;
            
            document.getElementById('sorting-participant-name').textContent = `${name}ë‹˜ì˜ ì¹´ë“œì†ŒíŒ…`;
            document.getElementById('sorting-type-info').textContent = getSortingTypeText(sortingType);
            
            const createGroupBtn = document.getElementById('create-group-btn');
            if (sortingType === 'closed') {
                createGroupBtn.style.display = 'none';
            } else {
                createGroupBtn.style.display = 'block';
            }
            
            renderSortingUI();
            startTimer();
            updateProgress();
        }

        function getSortingTypeText(type) {
            switch (type) {
                case 'open': return 'ì˜¤í”ˆ ì†ŒíŒ… (ê·¸ë£¹ ììœ  ìƒì„±)';
                case 'closed': return 'í´ë¡œì¦ˆë“œ ì†ŒíŒ… (ê³ ì • ê·¸ë£¹)';
                case 'hybrid': return 'í•˜ì´ë¸Œë¦¬ë“œ ì†ŒíŒ… (ê¸°ë³¸ + ì‚¬ìš©ì ìƒì„±)';
                default: return 'ì¹´ë“œì†ŒíŒ… ì§„í–‰ ì¤‘';
            }
        }

        function renderSortingUI() {
            renderCardPool();
            renderGroups();
        }

        function renderCardPool() {
            const cardPool = document.getElementById('card-pool');
            const { unassignedCards } = appState.sortingData;
            cardPool.innerHTML = '';
            
            unassignedCards.forEach(card => {
                const cardElement = createCardElement(card);
                cardPool.appendChild(cardElement);
            });
            
            document.getElementById('unassigned-count').textContent = unassignedCards.length;
        }

        function createCardElement(card) {
            const cardDiv = document.createElement('div');
            cardDiv.className = 'card-item';
            cardDiv.textContent = card.content;
            cardDiv.draggable = true;
            cardDiv.dataset.cardId = card.id;
            
            cardDiv.addEventListener('dragstart', handleDragStart);
            cardDiv.addEventListener('dragend', handleDragEnd);
            
            return cardDiv;
        }

        function renderGroups() {
            const container = document.getElementById('groups-container');
            const { groups } = appState.sortingData;
            container.innerHTML = '';
            
            Object.values(groups).forEach(group => {
                const groupElement = createGroupElement(group);
                container.appendChild(groupElement);
            });
        }

        function createGroupElement(group) {
            const groupDiv = document.createElement('div');
            groupDiv.className = 'group-container';
            groupDiv.dataset.groupId = group.id;
            
            groupDiv.addEventListener('dragover', handleDragOver);
            groupDiv.addEventListener('drop', handleDrop);
            groupDiv.addEventListener('dragenter', handleDragEnter);
            groupDiv.addEventListener('dragleave', handleDragLeave);
            
            const header = document.createElement('div');
            header.className = 'group-header';
            
            const title = document.createElement('div');
            title.className = `group-title ${group.isCustom ? 'editable' : ''}`;
            title.textContent = group.name;
            
            if (group.isCustom) {
                title.addEventListener('click', () => editGroupName(group.id));
            }
            
            const meta = document.createElement('div');
            meta.className = 'group-meta';
            
            const count = document.createElement('span');
            count.className = 'card-count';
            count.textContent = group.cards.length;
            meta.appendChild(count);
            
            if (group.isCustom) {
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'delete-group-btn';
                deleteBtn.textContent = 'Ã—';
                deleteBtn.onclick = () => deleteGroup(group.id);
                meta.appendChild(deleteBtn);
            }
            
            header.appendChild(title);
            header.appendChild(meta);
            
            const content = document.createElement('div');
            content.className = 'group-content';
            
            if (group.cards.length === 0) {
                const empty = document.createElement('div');
                empty.className = 'empty-group';
                empty.textContent = 'ì¹´ë“œë¥¼ ì—¬ê¸°ì— ë“œë˜ê·¸í•˜ì„¸ìš”';
                content.appendChild(empty);
            } else {
                group.cards.forEach(card => {
                    const cardElement = createCardElement(card);
                    content.appendChild(cardElement);
                });
            }
            
            groupDiv.appendChild(header);
            groupDiv.appendChild(content);
            
            return groupDiv;
        }

        function handleDragStart(event) {
            const cardId = event.target.dataset.cardId;
            event.dataTransfer.setData('text/plain', cardId);
            event.target.classList.add('dragging');
        }

        function handleDragEnd(event) {
            event.target.classList.remove('dragging');
            document.querySelectorAll('.group-container').forEach(group => {
                group.classList.remove('drag-over');
            });
        }

        function handleDragOver(event) {
            event.preventDefault();
        }

        function handleDragEnter(event) {
            event.target.closest('.group-container').classList.add('drag-over');
        }

        function handleDragLeave(event) {
            if (!event.target.closest('.group-container').contains(event.relatedTarget)) {
                event.target.closest('.group-container').classList.remove('drag-over');
            }
        }

        function handleDrop(event) {
            event.preventDefault();
            const cardId = event.dataTransfer.getData('text/plain');
            const targetGroup = event.target.closest('.group-container');
            const targetGroupId = targetGroup.dataset.groupId;
            moveCardToGroup(cardId, targetGroupId);
            targetGroup.classList.remove('drag-over');
        }

        function moveCardToGroup(cardId, targetGroupId) {
            const { groups, unassignedCards } = appState.sortingData;
            let card = null;
            
            const unassignedIndex = unassignedCards.findIndex(c => c.id === cardId);
            if (unassignedIndex !== -1) {
                card = unassignedCards.splice(unassignedIndex, 1)[0];
            } else {
                for (const group of Object.values(groups)) {
                    const cardIndex = group.cards.findIndex(c => c.id === cardId);
                    if (cardIndex !== -1) {
                        card = group.cards.splice(cardIndex, 1)[0];
                        break;
                    }
                }
            }
            
            if (card && groups[targetGroupId]) {
                groups[targetGroupId].cards.push(card);
                renderSortingUI();
                updateProgress();
                autoSave();
            }
        }

        function createNewGroup() {
            showModal('create-group-modal');
            document.getElementById('new-group-name').focus();
        }

        function confirmCreateGroup() {
            const groupName = document.getElementById('new-group-name').value.trim();
            
            if (!groupName) {
                showNotification('ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            if (groupName.length > 50) {
                showNotification('ê·¸ë£¹ ì´ë¦„ì€ 50ì ì´ë‚´ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'warning');
                return;
            }
            
            const existingNames = Object.values(appState.sortingData.groups).map(g => g.name);
            if (existingNames.includes(groupName)) {
                showNotification('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê·¸ë£¹ ì´ë¦„ì…ë‹ˆë‹¤.', 'warning');
                return;
            }
            
            const newGroupId = `custom-${generateId()}`;
            appState.sortingData.groups[newGroupId] = {
                id: newGroupId,
                name: groupName,
                isCustom: true,
                cards: []
            };
            
            renderGroups();
            closeModal('create-group-modal');
            document.getElementById('new-group-name').value = '';
            autoSave();
        }

        function editGroupName(groupId) {
            const group = appState.sortingData.groups[groupId];
            if (!group || !group.isCustom) return;
            
            const newName = prompt('ìƒˆ ê·¸ë£¹ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:', group.name);
            if (newName && newName.trim() && newName.trim() !== group.name) {
                group.name = newName.trim();
                renderGroups();
                autoSave();
            }
        }

        function deleteGroup(groupId) {
            const group = appState.sortingData.groups[groupId];
            if (!group || !group.isCustom) return;
            
            if (confirm(`'${group.name}' ê·¸ë£¹ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? í¬í•¨ëœ ì¹´ë“œë“¤ì€ ë¯¸ë¶„ë¥˜ë¡œ ì´ë™í•©ë‹ˆë‹¤.`)) {
                appState.sortingData.unassignedCards.push(...group.cards);
                delete appState.sortingData.groups[groupId];
                renderSortingUI();
                updateProgress();
                autoSave();
            }
        }

        function startTimer() {
            if (appState.timer) clearInterval(appState.timer);
            
            appState.timer = setInterval(() => {
                const elapsed = Math.floor((new Date() - appState.startTime) / 1000);
                const minutes = Math.floor(elapsed / 60);
                const seconds = elapsed % 60;
                
                document.getElementById('timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                    
                if (appState.sortingData) {
                    appState.sortingData.duration = elapsed;
                }
            }, 1000);
        }

        function stopTimer() {
            if (appState.timer) {
                clearInterval(appState.timer);
                appState.timer = null;
            }
        }

        function updateProgress() {
            if (!appState.sortingData) return;
            
            const totalCards = appState.currentProject.cards.length;
            const assignedCards = totalCards - appState.sortingData.unassignedCards.length;
            const progress = Math.round((assignedCards / totalCards) * 100);
            
            document.getElementById('progress-fill').style.width = `${progress}%`;
            document.getElementById('progress-text').textContent = 
                `${totalCards}ê°œ ì¤‘ ${assignedCards}ê°œ ì¹´ë“œ ë¶„ë¥˜ ì™„ë£Œ (${progress}%)`;
            
            const submitBtn = document.getElementById('submit-btn');
            if (assignedCards === totalCards) {
                submitBtn.disabled = false;
                submitBtn.textContent = 'âœ… ì™„ë£Œ í›„ ì œì¶œ';
            } else {
                submitBtn.disabled = false;
                submitBtn.textContent = `âœ… ì œì¶œ (${totalCards - assignedCards}ê°œ ë¯¸ë¶„ë¥˜)`;
            }
        }

        function autoSave() {
            if (!appState.sortingData) return;
            appState.sortingData.lastSaveTime = new Date().toISOString();
            saveToStorage(`participant_${appState.sortingData.participantId}`, appState.sortingData);
        }

        function resetAllCards() {
            if (!confirm('ëª¨ë“  ì¹´ë“œë¥¼ ë¯¸ë¶„ë¥˜ ìƒíƒœë¡œ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            const { groups } = appState.sortingData;
            Object.values(groups).forEach(group => {
                appState.sortingData.unassignedCards.push(...group.cards);
                group.cards = [];
            });
            
            renderSortingUI();
            updateProgress();
            autoSave();
        }

        function showCompletionPage() {
            showPage('completion-page');
            
            const { sortingData, currentProject } = appState;
            const assignedCards = currentProject.cards.length - sortingData.unassignedCards.length;
            const usedGroups = Object.values(sortingData.groups).filter(g => g.cards.length > 0).length;
            const customGroups = Object.values(sortingData.groups).filter(g => g.isCustom && g.cards.length > 0);
            const durationMinutes = Math.round(sortingData.duration / 60);
            
            const statsHTML = `
                <div class="stat-card">
                    <div class="stat-number">${assignedCards}</div>
                    <div class="stat-label">ë¶„ë¥˜í•œ ì¹´ë“œ ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${usedGroups}</div>
                    <div class="stat-label">ì‚¬ìš©í•œ ê·¸ë£¹ ìˆ˜</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${customGroups.length}</div>
                    <div class="stat-label">ìƒˆë¡œ ë§Œë“  ê·¸ë£¹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${durationMinutes}ë¶„</div>
                    <div class="stat-label">ì†Œìš” ì‹œê°„</div>
                </div>
            `;
            
            document.getElementById('completion-stats').innerHTML = statsHTML;
        }

        function downloadMyResponse() {
            if (!appState.sortingData) return;
            const exportData = formatResponseForExport(appState.sortingData, appState.currentProject);
            const fileName = `ì¹´ë“œì†ŒíŒ…_ì‘ë‹µ_${appState.sortingData.name}_${new Date().toISOString().split('T')[0]}.json`;
            downloadJSON(exportData, fileName);
        }

        function formatResponseForExport(responseData, projectConfig) {
            const groupResults = {};
            const cardDistribution = {};
            
            Object.values(responseData.groups || {}).forEach(group => {
                if (group.cards.length > 0) {
                    groupResults[group.name] = group.cards.map(card => card.content);
                    group.cards.forEach(card => {
                        cardDistribution[card.content] = group.name;
                    });
                }
            });
            
            if (responseData.unassignedCards && responseData.unassignedCards.length > 0) {
                groupResults['ë¯¸ë¶„ë¥˜'] = responseData.unassignedCards.map(card => card.content);
                responseData.unassignedCards.forEach(card => {
                    cardDistribution[card.content] = 'ë¯¸ë¶„ë¥˜';
                });
            }
            
            const browserInfo = {
                userAgent: navigator.userAgent,
                language: navigator.language,
                platform: navigator.platform,
                screenResolution: `${screen.width}x${screen.height}`,
                viewportSize: `${window.innerWidth}x${window.innerHeight}`,
                timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
            };
            
            return {
                participantInfo: {
                    name: responseData.name || 'ì•Œ ìˆ˜ ì—†ìŒ',
                    birth: responseData.birth || '',
                    participantId: responseData.participantId
                },
                timeInfo: {
                    startTime: responseData.startTime,
                    completedTime: responseData.completedTime,
                    lastSaveTime: responseData.lastSaveTime,
                    durationSeconds: responseData.duration,
                    durationMinutes: Math.round(responseData.duration / 60)
                },
                sortingResults: {
                    sortingType: responseData.sortingType,
                    totalCards: projectConfig.cards.length,
                    assignedCards: projectConfig.cards.length - (responseData.unassignedCards?.length || 0),
                    totalGroups: Object.keys(groupResults).length,
                    customGroupsCreated: Object.values(responseData.groups || {}).filter(g => g.isCustom && g.cards.length > 0).length,
                    groupResults: groupResults,
                    cardDistribution: cardDistribution
                },
                customGroups: Object.values(responseData.groups || {}).filter(g => g.isCustom && g.cards.length > 0).map(group => ({
                    name: group.name,
                    cardCount: group.cards.length,
                    cards: group.cards.map(card => card.content)
                })),
                projectInfo: {
                    projectId: projectConfig.id,
                    projectTitle: projectConfig.title,
                    totalAvailableCards: projectConfig.cards.length,
                    predefinedGroups: projectConfig.predefinedGroups || [],
                    sortingType: projectConfig.sortingType
                },
                technicalInfo: {
                    browserInfo: browserInfo,
                    isCompleted: responseData.isCompleted || false,
                    dataVersion: '1.0',
                    exportedAt: new Date().toISOString()
                }
            };
        }

        function downloadJSON(data, filename) {
            const jsonString = JSON.stringify(data, null, 2);
            const blob = new Blob([jsonString], { type: 'application/json;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const link = document.createElement('a');
            link.href = url;
            link.download = filename;
            link.style.display = 'none';
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            URL.revokeObjectURL(url);
        }

        // ============================================
        // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë° ì´ˆê¸°í™”
        // ============================================
        
        document.addEventListener('DOMContentLoaded', function() {
            document.getElementById('sorting-type').addEventListener('change', updateSortingTypeVisibility);
            document.getElementById('card-list').addEventListener('input', updateCardCount);
            
            document.getElementById('new-card').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    addNewCard();
                }
            });
            
            document.getElementById('new-group-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    confirmCreateGroup();
                }
            });
            
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('show');
                    }
                });
            });
            
            function handleHashChange() {
                const hash = window.location.hash.substr(1);
                switch (hash) {
                    case 'admin':
                        showAdminLogin();
                        break;
                    case 'participant':
                        showParticipantPage();
                        break;
                    default:
                        showHomePage();
                        break;
                }
            }
            
            window.addEventListener('hashchange', handleHashChange);
            handleHashChange();
            
            window.addEventListener('beforeunload', function(e) {
                if (appState.sortingData && !appState.sortingData.isCompleted) {
                    e.preventDefault();
                    e.returnValue = 'ì§„í–‰ ì¤‘ì¸ ì¹´ë“œì†ŒíŒ…ì´ ìˆìŠµë‹ˆë‹¤. ì •ë§ í˜ì´ì§€ë¥¼ ë– ë‚˜ì‹œê² ìŠµë‹ˆê¹Œ?';
                }
            });
            
            updateSortingTypeVisibility();
            updateCardCount();

            console.log('âœ… CORS ìš°íšŒ ì¹´ë“œì†ŒíŒ… íˆ´ì´ ì¤€ë¹„ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
    </script>
</body>
</html>